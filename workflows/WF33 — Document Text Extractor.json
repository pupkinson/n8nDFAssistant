{
  "name": "WF33 — Document Text Extractor",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -15968,
        3040
      ],
      "id": "d724a64b-ee38-4735-9694-69831c5217fc",
      "name": "IN — Execute Workflow Trigger",
      "notes": "PROD ENTRY: Receives job from WF90 with ctx{tenant_id, correlation_id, job_id, ...} + job{id, payload{document_id}, ...}. Input: WF90 item. Output: raw item."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1a2a3a4-b5b6-c7c8-d9d0-e1e2e3e4e5e6",
              "name": "ctx",
              "value": "={{ $json.ctx ?? {} }}",
              "type": "object"
            },
            {
              "id": "b2b3b4b5-c6c7-d8d9-e0e1-f2f3f4f5f6f7",
              "name": "job",
              "value": "={{ $json.job ?? {} }}",
              "type": "object"
            },
            {
              "id": "c3c4c5c6-d7d8-e9e0-f1f2-030405060708",
              "name": "ctx.tenant_id",
              "value": "={{ $json.ctx?.tenant_id ?? $json.job?.tenant_id }}",
              "type": "string"
            },
            {
              "id": "d4d5d6d7-e8e9-f0f1-0203-141516171819",
              "name": "ctx.correlation_id",
              "value": "={{ $json.ctx?.correlation_id ?? $json.job?.correlation_id }}",
              "type": "string"
            },
            {
              "id": "e5e6e7e8-f9f0-0102-1314-252627282930",
              "name": "ctx.job_id",
              "value": "={{ $json.job?.id }}",
              "type": "number"
            },
            {
              "id": "f6f7f8f9-0a0b-1213-2425-363738394041",
              "name": "ctx.workflow",
              "value": "WF33",
              "type": "string"
            },
            {
              "id": "07080910-1b1c-2324-3536-474849505152",
              "name": "ctx.contracts.errorpipe",
              "value": 1,
              "type": "number"
            },
            {
              "id": "18192021-2c2d-3435-4647-585960616263",
              "name": "job.payload.document_id",
              "value": "={{ $json.job?.payload?.document_id }}",
              "type": "number"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -15728,
        3056
      ],
      "id": "917743f6-5999-4cb8-8a7f-afd32ba17c3f",
      "name": "Set — Normalize Input",
      "notes": "Extract ctx + job from trigger. Preserve tenant_id, correlation_id, job_id. Set workflow=WF33 and errorpipe=1. Input: trigger item. Output: ctx.* + job.*. WHY dotNotation: nested fields."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "29303132-3d3e-4546-5758-697071727374",
              "leftValue": "={{ $json.ctx?.tenant_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "3a3b3c3d-4e4f-5657-6869-808182838485",
              "leftValue": "={{ $json.ctx?.correlation_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            },
            {
              "id": "4b4c4d4e-5f60-6768-7980-919293949596",
              "leftValue": "={{ $json.job?.payload?.document_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -15504,
        2928
      ],
      "id": "50b26b51-e2bf-4029-b347-f1f237ea9422",
      "name": "GUARD — Input Valid",
      "notes": "IF v3. Validate tenant_id, correlation_id, document_id all present. TRUE=valid, FALSE=error. Input: ctx + job. Output: same. WHY version=3: n8n v2.6.3 IF requirement."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5c5d5e5f-7081-9293-a4b5-c6d7e8f9a0b1",
              "name": "_err.node",
              "value": "GUARD — Input Valid",
              "type": "string"
            },
            {
              "id": "6d6e6f70-8192-a3b4-c5d6-e7f8a9b0c1d2",
              "name": "_err.operation",
              "value": "validate_input",
              "type": "string"
            },
            {
              "id": "7e7f8081-9293-b4c5-d6e7-f8a9b0c1d2e3",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "8f909192-a3b4-c5d6-e7f8-a9b0c1d2e3f4",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -13952,
        5120
      ],
      "id": "f374026f-3efb-4fa5-865d-8e488088d5c9",
      "name": "ERR — Source Input Guard",
      "notes": "ErrorPipe v1: Capture error source for Input Guard failure. Input: failed item. Output: _err.* + ctx + job + original. WHY includeOtherFields=true: preserve failure data."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "90a1a2a3-b4c5-d6e7-f8a9-b0c1d2e3f405",
              "name": "error_context.kind",
              "value": "validation",
              "type": "string"
            },
            {
              "id": "a1b2b3b4-c5d6-e7f8-a9b0-c1d2e3f40516",
              "name": "error_context.message",
              "value": "Missing required: tenant_id, correlation_id, or document_id",
              "type": "string"
            },
            {
              "id": "b2c3c4c5-d6e7-f8a9-b0c1-d2e3f4051627",
              "name": "error_context.status_code",
              "value": 400,
              "type": "number"
            },
            {
              "id": "c3d4d5d6-e7f8-a9b0-c1d2-e3f405162738",
              "name": "error_context.retryable",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "d4e5e6e7-f8a9-b0c1-d2e3-f40516273849",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "e5f6f7f8-a9b0-c1d2-e3f4-05162738495a",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "f60708090-b0c1-d2e3-f405-1627384950a5b",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "0718191a-c1d2-e3f4-0516-27384950a5b6c",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -13696,
        5120
      ],
      "id": "50439b85-0e75-4c9d-bffa-d714caac4fbc",
      "name": "ERR — Prepare ErrorPipe v1 (Input)",
      "notes": "Build error_context for WF99. Input: err source. Output: error_context.* only. WHY includeOtherFields=false: clean envelope for WF99."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -13456,
        5120
      ],
      "id": "15e110ad-8cf5-4e3b-8e4d-6355642436d9",
      "name": "Execute WF99 (Input)",
      "notes": "Call WF99 for input validation error. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after this!"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "content",
          "mode": "list",
          "cachedResultName": "content"
        },
        "table": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "where": {
          "values": [
            {
              "column": "id",
              "value": "={{ $json.job.payload.document_id }}"
            },
            {
              "column": "tenant_id",
              "value": "={{ $json.ctx.tenant_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -15264,
        2912
      ],
      "id": "687cf6ed-e147-43a1-bf1b-86a99767d43d",
      "name": "DB — Load Document",
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Load document from content.documents by id + tenant_id. Input: ctx + job. Output: document row. WHY AOD=OFF: need error output for 404 handling. WHY select: no dynamic SQL."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "718293a4-b5c6-d7e8-f9a0-b1c2d3e4f506",
              "name": "_err.node",
              "value": "DB — Load Document",
              "type": "string"
            },
            {
              "id": "8293a4b5-c6d7-e8f9-a0b1-c2d3e4f50617",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "93a4b5c6-d7e8-f9a0-b1c2-d3e4f5061728",
              "name": "_err.table",
              "value": "content.documents",
              "type": "string"
            },
            {
              "id": "a4b5c6d7-e8f9-a0b1-c2d3-e4f506172839",
              "name": "ctx",
              "value": "={{ $('Set — Normalize Input').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "b5c6d7e8-f9a0-b1c2-d3e4-f5061728394a",
              "name": "job",
              "value": "={{ $('Set — Normalize Input').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12880,
        5248
      ],
      "id": "cfccdf14-5a8d-44d6-8a16-5dd49adfe23f",
      "name": "ERR — Source DB Load Doc",
      "notes": "ErrorPipe v1: Capture DB error for Load Document (404 or DB error). Input: error output. Output: _err.* + ctx + job + error. WHY includeOtherFields=true: preserve error details."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c6d7e8f9-a0b1-c2d3-e4f5-0617283949a5b",
              "name": "error_context.kind",
              "value": "={{ $json.error?.code ? 'db' : 'business' }}",
              "type": "string"
            },
            {
              "id": "d7e8f9a0-b1c2-d3e4-f506-17283949a5b6c",
              "name": "error_context.message",
              "value": "={{ $json.error?.message || ('Document not found: id=' + $json.job.payload.document_id) }}",
              "type": "string"
            },
            {
              "id": "e8f9a0b1-c2d3-e4f5-0617-283949a5b6c7d",
              "name": "error_context.status_code",
              "value": "={{ $json.error?.code ? 500 : 404 }}",
              "type": "number"
            },
            {
              "id": "f9a0b1c2-d3e4-f506-1728-3949a5b6c7d8e",
              "name": "error_context.retryable",
              "value": "={{ $json.error?.code ? true : false }}",
              "type": "boolean"
            },
            {
              "id": "0a1b2c3d-e4f5-0617-2839-49a5b6c7d8e9f",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "1b2c3d4e-f506-1728-3949-a5b6c7d8e9f00",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "2c3d4e5f-0617-2839-49a5-b6c7d8e9f0011",
              "name": "error_context.details.table",
              "value": "={{ $json._err?.table }}",
              "type": "string"
            },
            {
              "id": "3d4e5f60-1728-3949-a5b6-c7d8e9f001122",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "4e5f6071-2839-49a5-b6c7-d8e9f00112233",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12496,
        5280
      ],
      "id": "5438efbe-9d94-48ea-9da7-628a35eb00cf",
      "name": "ERR — Prepare ErrorPipe v1 (DB Doc)",
      "notes": "Build error_context for DB Load Doc failure. Distinguish 404 (business) vs DB error. Input: err source. Output: error_context.*. WHY includeOtherFields=false: clean envelope."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -12256,
        5280
      ],
      "id": "3214e0a7-b136-4278-acbc-8c48be123495",
      "name": "Execute WF99 (DB Doc)",
      "notes": "Call WF99 for DB Load Document failure. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after!"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -15008,
        3040
      ],
      "id": "906d0323-a80e-462b-a0ab-3548874dd25a",
      "name": "Merge — Restore CTX after DB Load",
      "notes": "Restore ctx/job after DB Load Document (Carry pattern via Merge). Input1: DB result, Input2: ctx/job from Set Normalize Input. Output: document.* + ctx + job. WHY: Postgres overwrites item."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "5f607182-9394-a5b6-c7d8-e9f0a1b2c3d4",
              "leftValue": "={{ $json.doc_type }}",
              "rightValue": "message",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -14768,
        3040
      ],
      "id": "52a30c0f-cd93-445e-afca-650b0e764a2b",
      "name": "CTL — Route by doc_type: message?",
      "notes": "IF v3. Route by doc_type. TRUE=message, FALSE=file/url. Input: document + ctx + job. Output: same. WHY version=3: n8n v2.6.3 requirement."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "607182939-a4b5-c6d7-e8f9-a0b1c2d3e4f5",
              "leftValue": "={{ $json.doc_type }}",
              "rightValue": "file",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -14768,
        3328
      ],
      "id": "bdb87241-de19-49b3-a98c-06223d8a8cf6",
      "name": "CTL — Route by doc_type: file?",
      "notes": "IF v3. Route file vs url. TRUE=file, FALSE=url. Input: document + ctx + job. Output: same. WHY version=3: n8n v2.6.3 requirement."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "718293a4-b5c6-d7e8-f9a0-b1c2d3e4f506",
              "leftValue": "={{ $json.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -14528,
        2896
      ],
      "id": "a3bbe623-cd70-4be2-9dce-744cde8c1a53",
      "name": "GUARD — Message Has Text",
      "notes": "IF v3. Check if message doc has text. TRUE=has text, FALSE=empty (error 409). Input: document + ctx + job. Output: same. WHY version=3: n8n v2.6.3 requirement."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "8293a4b5-c6d7-e8f9-a0b1-c2d3e4f50617",
              "name": "_err.node",
              "value": "GUARD — Message Has Text",
              "type": "string"
            },
            {
              "id": "93a4b5c6-d7e8-f9a0-b1c2-d3e4f5061728",
              "name": "_err.operation",
              "value": "validate_text",
              "type": "string"
            },
            {
              "id": "a4b5c6d7-e8f9-a0b1-c2d3-e4f506172839",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "b5c6d7e8-f9a0-b1c2-d3e4-f5061728394a",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "c6d7e8f9-a0b1-c2d3-e4f5-061728394a5b",
              "name": "document_id",
              "value": "={{ $json.id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -14048,
        4768
      ],
      "id": "61789a64-15c4-422b-a040-a75dd1a04604",
      "name": "ERR — Source Message Empty",
      "notes": "ErrorPipe v1: Capture error for empty message text (business error 409). Input: failed guard. Output: _err.* + ctx + job + document. WHY includeOtherFields=true: preserve document data."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f9a0b1c2-d3e4-f506-1728-3949a5b6c7d8",
              "name": "error_context.kind",
              "value": "business",
              "type": "string"
            },
            {
              "id": "0a1b2c3d-e4f5-0617-2839-49a5b6c7d8e9",
              "name": "error_context.message",
              "value": "Nothing to extract: document text is empty",
              "type": "string"
            },
            {
              "id": "1b2c3d4e-f506-1728-3949-a5b6c7d8e9f0",
              "name": "error_context.status_code",
              "value": 409,
              "type": "number"
            },
            {
              "id": "2c3d4e5f-0617-2839-49a5-b6c7d8e9f001",
              "name": "error_context.retryable",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "3d4e5f60-1728-3949-a5b6-c7d8e9f00112",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "4e5f6071-2839-49a5-b6c7-d8e9f0011223",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "5f607182-3949-a5b6-c7d8-e9f001122334",
              "name": "error_context.details.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "60718293-49a5-b6c7-d8e9-f00112233445",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "718293a4-a5b6-c7d8-e9f0-011223344556",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -13808,
        4768
      ],
      "id": "d4ddd834-6959-4b56-b925-74b8ea2ee4fb",
      "name": "ERR — Prepare ErrorPipe v1 (Empty Text)",
      "notes": "Build error_context for empty text (business error). Input: err source. Output: error_context.*. WHY includeOtherFields=false: clean envelope for WF99."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -13568,
        4768
      ],
      "id": "04d0d000-918e-470d-8826-9e466313a9d7",
      "name": "Execute WF99 (Empty Text)",
      "notes": "Call WF99 for empty text error. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after!"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1b2c3d4e-f506-1728-3949-a5b6c7d8e9f0",
              "name": "extracted_text",
              "value": "={{ $json.text }}",
              "type": "string"
            },
            {
              "id": "2c3d4e5f-0617-2839-49a5-b6c7d8e9f001",
              "name": "document_id",
              "value": "={{ $json.id }}",
              "type": "number"
            },
            {
              "id": "3d4e5f60-1728-3949-a5b6-c7d8e9f00112",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "4e5f6071-2839-49a5-b6c7-d8e9f0011223",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "msg-meta",
              "name": "extracted_meta.source",
              "value": "message_text",
              "type": "string"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12688,
        2528
      ],
      "id": "cad7b61b-0c1c-48e5-a1aa-0128b44d8f34",
      "name": "Set — Message: Extract Existing Text",
      "notes": "For message doc: map content.documents.text into unified extraction payload. Input: document + ctx + job. Output: extracted_text + extracted_meta + document_id + ctx + job."
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "messages": {
          "values": [
            {
              "content": "=Строго придерживайся принципа краткого изложения фактов. Возвращай только краткий текст с изложением фактов (максимум 1200 символов). Если что-то непонятно, укажи это.\\n\\nТекст для краткого изложения:\\n{{ $json.extracted_text }}"
            }
          ]
        },
        "simplify": false,
        "jsonOutput": true,
        "builtInTools": {},
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        -9328,
        2912
      ],
      "id": "dc2446da-5eba-4999-8bf9-931406736282",
      "name": "AI — Generate Description (Gemini)",
      "credentials": {
        "googlePalmApi": {
          "id": "4J3UGUqYNZJxtTVa",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Analyze Document node (Gemini) for summary generation from extracted_text. INPUT: unified extracted_text (+binary when available). OUTPUT: Gemini response text/json. WHY: requested replacement of text generation node with document analyzer."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4e5f6071-2839-49a5-b6c7-d8e9f0011223",
              "name": "_err.node",
              "value": "AI — Generate Description (Gemini)",
              "type": "string"
            },
            {
              "id": "5f607182-3949-a5b6-c7d8-e9f001122334",
              "name": "_err.operation",
              "value": "generate_description",
              "type": "string"
            },
            {
              "id": "60718293-49a5-b6c7-d8e9-f00112233445",
              "name": "ctx",
              "value": "={{ $('Carry — Pre AI Description').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "718293a4-a5b6-c7d8-e9f0-011223344556",
              "name": "job",
              "value": "={{ $('Carry — Pre AI Description').item.json.job }}",
              "type": "object"
            },
            {
              "id": "8293a4b5-b6c7-d8e9-f001-122334455667",
              "name": "document_id",
              "value": "={{ $('Carry — Pre AI Description').item.json.document_id }}",
              "type": "number"
            },
            {
              "id": "93a4b5c6-c7d8-e9f0-0112-233445566778",
              "name": "extracted_text",
              "value": "={{ $('Carry — Pre AI Description').item.json.extracted_text }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8384,
        4992
      ],
      "id": "87539876-2cce-4a73-a64d-427f5c6cdba8",
      "name": "ERR — Source AI Description",
      "notes": "ErrorPipe v1: Capture AI error for description generation. Input: error output. Output: _err.* + ctx + job + document_id + extracted_text + error. WHY includeOtherFields=true: preserve error details."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a4b5c6d7-d8e9-f001-1223-344556677889",
              "name": "error_context.kind",
              "value": "upstream",
              "type": "string"
            },
            {
              "id": "b5c6d7e8-e9f0-0112-2334-45566778899a",
              "name": "error_context.message",
              "value": "={{ $json.error?.message || 'AI description generation failed' }}",
              "type": "string"
            },
            {
              "id": "c6d7e8f9-f001-1223-3445-56677889a0b1",
              "name": "error_context.status_code",
              "value": 502,
              "type": "number"
            },
            {
              "id": "d7e8f9a0-0112-2334-4556-6778899a0b1c2",
              "name": "error_context.retryable",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "e8f9a0b1-1223-3445-5667-78899a0b1c2d3",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "f9a0b1c2-2334-4556-6778-899a0b1c2d3e4",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "0a1b2c3d-3445-5667-7889-9a0b1c2d3e4f5",
              "name": "error_context.details.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "1b2c3d4e-4556-6778-899a-0b1c2d3e4f506",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "2c3d4e5f-5667-7889-9a0b-1c2d3e4f50617",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8032,
        5008
      ],
      "id": "c3339139-a568-42e3-a190-19ae56361583",
      "name": "ERR — Prepare ErrorPipe v1 (AI Desc)",
      "notes": "Build error_context for AI description failure (upstream error, retryable). Input: err source. Output: error_context.*. WHY includeOtherFields=false: clean envelope."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -7728,
        5040
      ],
      "id": "f590b2f8-7199-42f9-81b7-8070a833bcc8",
      "name": "Execute WF99 (AI Desc)",
      "notes": "Call WF99 for AI description failure. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after!"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "718293a4-a5b6-c7d8-e9f0-011223344556",
              "name": "description",
              "value": "={{ $json.text || $json.message || $json.response || $json.output || $json.result || $json.candidates?.[0]?.content?.parts?.[0]?.text || \"Summary not available\" }}",
              "type": "string"
            },
            {
              "id": "8293a4b5-b6c7-d8e9-f001-122334455667",
              "name": "extracted_text",
              "value": "={{ $json.extracted_text || $('Carry — Pre AI Description').item.json.extracted_text }}",
              "type": "string"
            },
            {
              "id": "93a4b5c6-c7d8-e9f0-0112-233445566778",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Carry — Pre AI Description').item.json.document_id }}",
              "type": "number"
            },
            {
              "id": "a4b5c6d7-d8e9-f001-1223-344556677889",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Carry — Pre AI Description').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "b5c6d7e8-e9f0-0112-2334-45566778899a",
              "name": "job",
              "value": "={{ $json.job || $('Carry — Pre AI Description').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8704,
        3104
      ],
      "id": "8e009730-5083-4a00-a689-9090f92d3b28",
      "name": "Set — Extract Description from AI Response",
      "notes": "Extract description from AI response and restore carried fields. Input: merged AI+carry item. Output: description + extracted_text + document_id + ctx + job."
    },
    {
      "parameters": {
        "type": "SHA256",
        "value": "={{ $json.extracted_text }}"
      },
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        -8480,
        3120
      ],
      "id": "7d1bd015-e09d-4729-a6b9-d953f3e9165b",
      "name": "Crypto — Compute SHA256",
      "notes": "Compute SHA256 hash from extracted_text using explicit Value field. INPUT: unified extracted_text. OUTPUT: hash in data. WHY: required field must be explicitly filled."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "93a4b5c6-c7d8-e9f0-0112-233445566778",
              "name": "text_sha256_bytea",
              "value": "={{ '\\\\x' + $json.hash }}",
              "type": "string"
            },
            {
              "id": "a4b5c6d7-d8e9-f001-1223-344556677889",
              "name": "description",
              "value": "={{ $json.description || $('Set — Extract Description from AI Response').item.json.description }}",
              "type": "string"
            },
            {
              "id": "b5c6d7e8-e9f0-0112-2334-45566778899a",
              "name": "extracted_text",
              "value": "={{ $json.extracted_text || $('Set — Extract Description from AI Response').item.json.extracted_text || $('Carry — Pre AI Description').item.json.extracted_text }}",
              "type": "string"
            },
            {
              "id": "c6d7e8f9-f001-1223-3445-56677889a0b1",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Set — Extract Description from AI Response').item.json.document_id || $('Carry — Pre AI Description').item.json.document_id }}",
              "type": "number"
            },
            {
              "id": "d7e8f9a0-0112-2334-4556-6778899a0b1c2",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Set — Extract Description from AI Response').item.json.ctx || $('Carry — Pre AI Description').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "e8f9a0b1-1223-3445-5667-78899a0b1c2d3",
              "name": "job",
              "value": "={{ $json.job || $('Set — Extract Description from AI Response').item.json.job || $('Carry — Pre AI Description').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -8240,
        3120
      ],
      "id": "49b4c0e5-9998-4248-a8ce-46b6bb766842",
      "name": "Set — Prepare Bytea Format",
      "notes": "Convert hash to Postgres bytea format (\\\\x prefix). Restore description/extracted_text/document_id/ctx/job. Input: hash + description + extracted_text + document_id + ctx + job. Output: text_sha256_bytea + all. WHY: Postgres bytea requires \\\\x prefix."
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "value": "content",
          "mode": "list",
          "cachedResultName": "content"
        },
        "table": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "text": "={{ $json.extracted_text }}",
            "description": "={{ $json.description }}",
            "text_sha256": "={{ $json.text_sha256_bytea }}",
            "status": "succeeded",
            "id": "={{ $json.document_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "text",
              "displayName": "text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "description",
              "displayName": "description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "text_sha256",
              "displayName": "text_sha256",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": false,
              "options": [
                {
                  "name": "pending",
                  "value": "pending"
                },
                {
                  "name": "succeeded",
                  "value": "succeeded"
                },
                {
                  "name": "failed",
                  "value": "failed"
                }
              ]
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -7984,
        2896
      ],
      "id": "5f4a6ae0-cc7d-4940-a56d-1896cefd85dc",
      "name": "DB — Update Document (Success)",
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Update content.documents: text, description, text_sha256, status=succeeded. Match by id. Input: text_sha256_bytea + description + extracted_text + document_id + ctx + job. Output: updated row. WHY AOD=OFF: need error output. WHY update op: no dynamic SQL."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b5c6d7e8-e9f0-0112-2334-45566778899a",
              "name": "_err.node",
              "value": "DB — Update Document (Success)",
              "type": "string"
            },
            {
              "id": "c6d7e8f9-f001-1223-3445-56677889a0b1",
              "name": "_err.operation",
              "value": "update",
              "type": "string"
            },
            {
              "id": "d7e8f9a0-0112-2334-4556-6778899a0b1c2",
              "name": "_err.table",
              "value": "content.documents",
              "type": "string"
            },
            {
              "id": "e8f9a0b1-1223-3445-5667-78899a0b1c2d3",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "f9a0b1c2-2334-4556-6778-899a0b1c2d3e4",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "0a1b2c3d-3445-5667-7889-9a0b1c2d3e4f5",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7536,
        4704
      ],
      "id": "189ba01c-7022-4130-bbb6-522f2d5e0df1",
      "name": "ERR — Source DB Update Doc",
      "notes": "ErrorPipe v1: Capture DB error for Update Document. Input: error output. Output: _err.* + ctx + job + document_id + error. WHY includeOtherFields=true: preserve error details."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c6d7e8f9-f001-1223-3445-56677889a0b1",
              "name": "error_context.kind",
              "value": "db",
              "type": "string"
            },
            {
              "id": "d7e8f9a0-0112-2334-4556-6778899a0b1c2",
              "name": "error_context.message",
              "value": "={{ $json.error?.message || 'Failed to update document' }}",
              "type": "string"
            },
            {
              "id": "e8f9a0b1-1223-3445-5667-78899a0b1c2d3",
              "name": "error_context.status_code",
              "value": 500,
              "type": "number"
            },
            {
              "id": "f9a0b1c2-2334-4556-6778-899a0b1c2d3e4",
              "name": "error_context.retryable",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "0a1b2c3d-3445-5667-7889-9a0b1c2d3e4f5",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "1b2c3d4e-4556-6778-899a-0b1c2d3e4f506",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "2c3d4e5f-5667-7889-9a0b-1c2d3e4f50617",
              "name": "error_context.details.table",
              "value": "={{ $json._err?.table }}",
              "type": "string"
            },
            {
              "id": "3d4e5f60-6778-899a-0b1c-2d3e4f5061728",
              "name": "error_context.details.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "4e5f6071-7889-9a0b-1c2d-3e4f506172839",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "5f607182-899a-0b1c-2d3e-4f5061728394a",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7248,
        4704
      ],
      "id": "b1cbf20d-238e-4bcb-8aa4-ebab8a6f21ca",
      "name": "ERR — Prepare ErrorPipe v1 (DB Update)",
      "notes": "Build error_context for DB Update Document failure (DB error, retryable). Input: err source. Output: error_context.*. WHY includeOtherFields=false: clean envelope."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -7008,
        4704
      ],
      "id": "76271cf7-c135-4f1d-b3ca-7e043dbccdfa",
      "name": "Execute WF99 (DB Update)",
      "notes": "Call WF99 for DB Update Document failure. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after!"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -7680,
        3120
      ],
      "id": "b7737366-dac6-4bcf-be96-2180b0dca017",
      "name": "Merge — Restore CTX after DB Update",
      "notes": "Restore ctx/job after DB Update (Carry pattern via Merge). Input1: DB result, Input2: ctx/job from Set Prepare Bytea Format. Output: updated document.* + ctx + job. WHY: Postgres overwrites item."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "f9a0b1c2-2334-4556-6778-899a0b1c2d3e4",
              "name": "enqueue_payload.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "0a1b2c3d-3445-5667-7889-9a0b1c2d3e4f5",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "1b2c3d4e-4556-6778-899a-0b1c2d3e4f506",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -7440,
        3344
      ],
      "id": "66af195f-c316-4d25-8523-6629dec6ee8e",
      "name": "Set — Prepare Enqueue Payload",
      "notes": "Build enqueue_payload object for chunk_document job. No object literals (use dotNotation). Input: updated document + ctx + job. Output: enqueue_payload.document_id + ctx + job. WHY: prepare for ops.jobs insert."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "value": "ops",
          "mode": "list",
          "cachedResultName": "ops"
        },
        "table": {
          "__rl": true,
          "value": "jobs",
          "mode": "list",
          "cachedResultName": "jobs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json.ctx.tenant_id }}",
            "job_type": "chunk_document",
            "payload": "={{ $json.enqueue_payload }}",
            "correlation_id": "={{ $json.ctx.correlation_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "job_type",
              "displayName": "job_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "chunk_document",
                  "value": "chunk_document"
                },
                {
                  "name": "embed_chunks",
                  "value": "embed_chunks"
                },
                {
                  "name": "extract_text",
                  "value": "extract_text"
                },
                {
                  "name": "fetch_tg_file",
                  "value": "fetch_tg_file"
                },
                {
                  "name": "fetch_url",
                  "value": "fetch_url"
                }
              ]
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "correlation_id",
              "displayName": "correlation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -7184,
        3200
      ],
      "id": "5d9fbf99-6b45-4c34-b56e-e8437e7ea6a2",
      "name": "DB — Enqueue chunk_document Job",
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert chunk_document job in ops.jobs. Payload is object (not string). Input: enqueue_payload + ctx + job. Output: inserted row. WHY AOD=OFF: need error output. WHY insert op: no dynamic SQL."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "1b2c3d4e-4556-6778-899a-0b1c2d3e4f506",
              "name": "_err.node",
              "value": "DB — Enqueue chunk_document Job",
              "type": "string"
            },
            {
              "id": "2c3d4e5f-5667-7889-9a0b-1c2d3e4f50617",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "3d4e5f60-6778-899a-0b1c-2d3e4f5061728",
              "name": "_err.table",
              "value": "ops.jobs",
              "type": "string"
            },
            {
              "id": "4e5f6071-7889-9a0b-1c2d-3e4f506172839",
              "name": "ctx",
              "value": "={{ $('Set — Prepare Enqueue Payload').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "5f607182-899a-0b1c-2d3e-4f5061728394a",
              "name": "job",
              "value": "={{ $('Set — Prepare Enqueue Payload').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6640,
        4736
      ],
      "id": "0c93d44a-11a8-40cf-8246-16589c0908d2",
      "name": "ERR — Source DB Enqueue",
      "notes": "ErrorPipe v1: Capture DB error for Enqueue chunk_document. Input: error output. Output: _err.* + ctx + job + error. WHY includeOtherFields=true: preserve error details."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2c3d4e5f-5667-7889-9a0b-1c2d3e4f50617",
              "name": "error_context.kind",
              "value": "db",
              "type": "string"
            },
            {
              "id": "3d4e5f60-6778-899a-0b1c-2d3e4f5061728",
              "name": "error_context.message",
              "value": "={{ $json.error?.message || 'Failed to enqueue chunk_document job' }}",
              "type": "string"
            },
            {
              "id": "4e5f6071-7889-9a0b-1c2d-3e4f506172839",
              "name": "error_context.status_code",
              "value": 500,
              "type": "number"
            },
            {
              "id": "5f607182-899a-0b1c-2d3e-4f5061728394a",
              "name": "error_context.retryable",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "607182939-a0b1-c2d3-e4f5-061728394a5b6",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "718293a4b-b1c2-d3e4-f506-1728394a5b6c7",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "8293a4b5c-c2d3-e4f5-0617-28394a5b6c7d8",
              "name": "error_context.details.table",
              "value": "={{ $json._err?.table }}",
              "type": "string"
            },
            {
              "id": "93a4b5c6d-d3e4-f506-1728-394a5b6c7d8e9",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "a4b5c6d7e-e4f5-0617-2839-4a5b6c7d8e9f0",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6336,
        4752
      ],
      "id": "cf9decf6-6325-4519-9e4d-43897ef5f62a",
      "name": "ERR — Prepare ErrorPipe v1 (DB Enqueue)",
      "notes": "Build error_context for DB Enqueue failure (DB error, retryable). Input: err source. Output: error_context.*. WHY includeOtherFields=false: clean envelope."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -6096,
        4752
      ],
      "id": "2a10c7d4-edec-4b06-98c8-e74d575c48eb",
      "name": "Execute WF99 (DB Enqueue)",
      "notes": "Call WF99 for DB Enqueue failure. Input: error_context. Output: ErrorEnvelope. WHY: ErrorPipe v1 centralized logging. NO StopAndError after!"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -6800,
        3456
      ],
      "id": "dd6e1d75-bfce-4716-b5b4-1b1eb2aebd57",
      "name": "Merge — Restore CTX after Enqueue",
      "notes": "Restore ctx/job after DB Enqueue (Carry pattern via Merge). Input1: DB result, Input2: ctx/job from Set Prepare Enqueue Payload. Output: enqueued job.* + ctx + job. WHY: Postgres overwrites item."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5f607182-899a-0b1c-2d3e-4f5061728394a",
              "name": "ok",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "607182939-a0b1-c2d3-e4f5-061728394a5b6",
              "name": "status_code",
              "value": 200,
              "type": "number"
            },
            {
              "id": "718293a4b-b1c2-d3e4-f506-1728394a5b6c7",
              "name": "ctx",
              "value": "={{ $('Set — Prepare Enqueue Payload').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "8293a4b5c-c2d3-e4f5-0617-28394a5b6c7d8",
              "name": "result.document_id",
              "value": "={{ $('Set — Prepare Enqueue Payload').item.json.enqueue_payload.document_id }}",
              "type": "number"
            },
            {
              "id": "93a4b5c6d-d3e4-f506-1728-394a5b6c7d8e9",
              "name": "result.extracted",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "a4b5c6d7e-e4f5-0617-2839-4a5b6c7d8e9f0",
              "name": "result.enqueued_chunk_job",
              "value": true,
              "type": "boolean"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6512,
        4016
      ],
      "id": "aa43f82b-1240-4a96-9b5d-4c4964fac5c1",
      "name": "OUT — Success Envelope",
      "notes": "Build SuccessEnvelope for WF90. ok=true, status_code=200, ctx preserved, result with document_id/extracted/enqueued_chunk_job. Input: enqueued job + ctx. Output: SuccessEnvelope. WHY: contract compliance."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "passThrough"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -5936,
        4304
      ],
      "id": "929ccc1d-cece-4fc0-8057-26a90c03b42b",
      "name": "Merge — Final (Success + All Errors)",
      "notes": "Merge all paths: success (OUT — Success Envelope) + all error paths (WF99 outputs). PassThrough mode merges first available. Input0: success, Input1-6: error paths. Output: first available item. WHY: combine all branches."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "file-doc",
              "name": "document_id",
              "value": "={{ $json.id }}",
              "type": "number"
            },
            {
              "id": "file-fuid",
              "name": "file_unique_id",
              "value": "={{ $json.file_unique_id }}",
              "type": "string"
            },
            {
              "id": "file-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "file-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -14528,
        3328
      ],
      "id": "4614cd82-0509-48bf-b04c-1be1809cefa7",
      "name": "Set — File Ref from Document",
      "notes": "Build file reference and unified carry fields from content.documents row. Input: document + ctx + job. Output: file_unique_id + document_id + ctx + job."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "url-doc",
              "name": "document_id",
              "value": "={{ $json.id }}",
              "type": "number"
            },
            {
              "id": "url-text",
              "name": "extracted_text",
              "value": "",
              "type": "string"
            },
            {
              "id": "url-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "url-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "url-meta",
              "name": "extracted_meta.reason",
              "value": "url_not_implemented",
              "type": "string"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -14528,
        3520
      ],
      "id": "2f682bb0-e418-43c2-8680-03a08c75d4fc",
      "name": "Set — URL Placeholder Unified",
      "notes": "URL extraction placeholder unified output: extracted_text empty with reason marker. Keeps pipeline deterministic until URL extractor workflow is implemented."
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -15968,
        4240
      ],
      "id": "8066fa3a-4a18-4643-8420-1f343e6593ee",
      "name": "TEST — Manual Trigger",
      "notes": "Manual test entrypoint for T1/T2/T3 fixture seeding and execution through production path."
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    test_case: 'T1',\n    ctx: {\n      tenant_id: '00000000-0000-0000-0000-000000000331',\n      correlation_id: '33111111-1111-1111-1111-111111111111',\n      job_id: 331001,\n      workflow: 'WF33-TEST',\n      contracts: { errorpipe: 1 }\n    },\n    job: {\n      id: 331001,\n      tenant_id: '00000000-0000-0000-0000-000000000331',\n      job_type: 'extract_text',\n      correlation_id: '33111111-1111-1111-1111-111111111111',\n      payload: { document_id: 331001 }\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -14448,
        4272
      ],
      "id": "abbdbeac-9d38-4087-a610-7a63769d1d1b",
      "name": "TEST — Build Worker Requests",
      "notes": "Single worker request item (T1) to prevent combinatorial growth in test execution path."
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "files",
          "mode": "list",
          "cachedResultName": "files"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "file_unique_id",
              "value": "={{ $json.file_unique_id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -14240,
        3184
      ],
      "id": "e27dab4d-afe9-4d87-b1eb-f5f90608dd5d",
      "name": "DB — Select tg.files by file_unique_id",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Load tg.files by file_unique_id to resolve sha256/mime/file_name for blob lookup."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -14048,
        3344
      ],
      "id": "94f492bd-c273-4c2c-8f7f-fca07a3872b2",
      "name": "Merge — Restore CTX after tg.files",
      "notes": "Carry/restore after tg.files select overwrite."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 3
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "wf33-file-has-sha",
              "leftValue": "={{ $json.sha256 }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -13856,
        3424
      ],
      "id": "9e2ca842-4198-4db2-8e64-b76d2cb344c2",
      "name": "GUARD — File Has sha256",
      "notes": "Require sha256 in tg.files to locate blob object."
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "content",
          "mode": "list",
          "cachedResultName": "content"
        },
        "table": {
          "__rl": true,
          "value": "blob_objects",
          "mode": "list",
          "cachedResultName": "blob_objects"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "sha256",
              "value": "={{ $json.sha256 }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -13632,
        3168
      ],
      "id": "73338e3f-48cc-4e15-a1a9-5afcf7fe0a15",
      "name": "DB — Select blob_objects by sha256",
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Lookup blob object by sha256 to get storage_key."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -13296,
        3200
      ],
      "id": "7f61ab54-4263-4578-b763-bb404476dca6",
      "name": "Merge — Restore CTX after blob lookup",
      "notes": "Carry/restore after blob_objects select overwrite."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 3
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "wf33-file-has-key",
              "leftValue": "={{ $json.storage_key }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -13088,
        3264
      ],
      "id": "a2c01919-e3c4-4166-a210-a95f48d05b71",
      "name": "GUARD — Blob Has storage_key",
      "notes": "Require blob storage_key before S3 download."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -12608,
        3248
      ],
      "id": "c16f40c5-8c25-40e3-bcf2-6e49140f9320",
      "name": "Merge — Restore CTX after S3",
      "notes": "Carry/restore after S3 download overwrite."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-file-ext",
              "name": "file_ext",
              "value": "={{ (($json.file_name || $json.storage_key || \"\").split(\".\").pop() || \"\").toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "wf33-file-mime",
              "name": "file_mime",
              "value": "={{ ($json.mime_type || \"\").toLowerCase() }}",
              "type": "string"
            },
            {
              "id": "wf33-file-docid",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-file-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-file-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12352,
        3248
      ],
      "id": "d751c31b-75d2-47f1-ad06-c9eeebafbcd3",
      "name": "Set — Detect File Type",
      "notes": "Compute file_ext/file_mime for extractor routing and keep binary payload. INPUT: file metadata + binary + context. OUTPUT: typed routing fields + preserved binary. WHY: extractor/analyzer nodes require binary."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_mime.includes(\"pdf\") || $json.file_ext === \"pdf\" }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-pdf"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "pdf"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ [\"txt\",\"log\",\"md\"].includes($json.file_ext) || $json.file_mime.startsWith(\"text/\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-text"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "text"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"csv\" || $json.file_mime.includes(\"csv\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-csv"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "csv"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"html\" || $json.file_ext === \"htm\" || $json.file_mime.includes(\"html\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-html"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "html"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"json\" || $json.file_mime.includes(\"json\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-json"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "json"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"ics\" || $json.file_mime.includes(\"calendar\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-ics"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ics"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"rtf\" || $json.file_mime.includes(\"rtf\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-rtf"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "rtf"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"xlsx\" }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-xlsx"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "xlsx"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"xls\" }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-xls"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "xls"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.file_ext === \"ods\" }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-ods"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "ods"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ [\"docx\",\"pptx\",\"doc\",\"ppt\"].includes($json.file_ext) || $json.file_mime.includes(\"word\") || $json.file_mime.includes(\"presentation\") || $json.file_mime.includes(\"msword\") }}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "wf33-sw-conv"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "convert"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -12128,
        3280
      ],
      "id": "c976ef9f-49d5-4a7f-8823-e6f93bf594be",
      "name": "SWITCH — Route by File Type",
      "notes": "Switch by MIME/extension after S3 download. Routes only supported types to matching Extract From File operation; doc/docx/ppt/pptx to Convert File To Json; unknown types to Gemini Analyze Document fallback."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-extract-txt",
              "name": "extracted_text",
              "value": "={{ typeof $json.text === \"string\" ? $json.text : (typeof $json.data === \"string\" ? $json.data : JSON.stringify($json)) }}",
              "type": "string"
            },
            {
              "id": "wf33-extract-meta",
              "name": "extracted_meta.extract_source",
              "value": "extract_from_file",
              "type": "string"
            },
            {
              "id": "wf33-extract-docid",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Merge — Restore CTX after S3').item.json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-extract-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Merge — Restore CTX after S3').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-extract-job",
              "name": "job",
              "value": "={{ $json.job || $('Merge — Restore CTX after S3').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11408,
        3040
      ],
      "id": "1f4a43de-68f3-480a-8a9a-3aba57c72720",
      "name": "Set — Unified from Extract",
      "notes": "Map any Extract From File output shape to unified extracted_text deterministically; fallback to JSON.stringify for table-like outputs."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-exterr-node",
              "name": "_err.node",
              "value": "Extract — Extract From File",
              "type": "string"
            },
            {
              "id": "wf33-exterr-op",
              "name": "_err.operation",
              "value": "extract",
              "type": "string"
            },
            {
              "id": "wf33-exterr-table",
              "name": "_err.table",
              "value": "",
              "type": "string"
            },
            {
              "id": "wf33-exterr-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Merge — Restore CTX after S3').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-exterr-job",
              "name": "job",
              "value": "={{ $json.job || $('Merge — Restore CTX after S3').item.json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-exterr-docid",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Merge — Restore CTX after S3').item.json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11456,
        3760
      ],
      "id": "8cd9c2ef-c707-4293-b424-9217cf71a992",
      "name": "ERR — Source Extract File",
      "notes": "Capture extractor error details for unsupported/fatal routing."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 3
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "wf33-unsupported",
              "leftValue": "={{ ((($json.error?.message||\"\")+\" \"+($json.error?.description||\"\")).toLowerCase().includes(\"unsupported\") || (($json.error?.message||\"\")+\" \"+($json.error?.description||\"\")).toLowerCase().includes(\"not support\")) }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -11280,
        3760
      ],
      "id": "6217ad0d-62ca-4d02-af9c-d0c6922d4a68",
      "name": "IF — Extract Error Is Unsupported",
      "notes": "Expected unsupported-type errors route to converter; other errors go to WF99."
    },
    {
      "parameters": {},
      "type": "@mazix/n8n-nodes-converter-documents.convertFileToJson",
      "typeVersion": 5,
      "position": [
        -10896,
        3504
      ],
      "id": "490d7428-3f58-4fe1-ab15-86dfcf2cb04a",
      "name": "Convert — File To Json",
      "retryOnFail": true,
      "onError": "continueErrorOutput",
      "notes": "Fallback extraction for pptx and unsupported formats via converter community node."
    },
    {
      "parameters": {
        "jsCode": "const out=[];\nfor (const item of $input.all()) {\n  const src=item.json || {};\n  const converted = src.converted_json ?? src.convertedJson ?? src.data ?? src.result ?? src.content ?? src;\n  const clone=JSON.parse(JSON.stringify(converted));\n  out.push({json:{\n    extracted_text: typeof clone === 'string' ? clone : JSON.stringify(clone),\n    extracted_meta:{extract_source:'convert_file_to_json',converted_json:clone},\n    document_id: src.document_id ?? $('Carry — Pre Convert File').item.json.document_id,\n    ctx: src.ctx ?? $('Carry — Pre Convert File').item.json.ctx,\n    job: src.job ?? $('Carry — Pre Convert File').item.json.job\n  }});\n}\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -10496,
        3456
      ],
      "id": "b533dec7-1746-481b-9da6-bb4ab461a38b",
      "name": "CODE — Flatten Converted JSON",
      "notes": "Small deterministic transformer: converter JSON -> extracted_text string + extracted_meta.converted_json."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-conv-node",
              "name": "_err.node",
              "value": "Convert — File To Json",
              "type": "string"
            },
            {
              "id": "wf33-conv-op",
              "name": "_err.operation",
              "value": "convert",
              "type": "string"
            },
            {
              "id": "wf33-conv-table",
              "name": "_err.table",
              "value": "",
              "type": "string"
            },
            {
              "id": "wf33-conv-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Carry — Pre Convert File').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-conv-job",
              "name": "job",
              "value": "={{ $json.job || $('Carry — Pre Convert File').item.json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-conv-doc",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Carry — Pre Convert File').item.json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -10160,
        4384
      ],
      "id": "6ad4a680-e4f5-4602-9485-1e46f3edb4b5",
      "name": "ERR — Source Convert File",
      "notes": "Capture converter errors for ErrorPipe."
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -10352,
        3312
      ],
      "id": "0b6ecefe-759b-4e6b-b750-492298b0de18",
      "name": "Merge — File Extract Unified",
      "notes": "Merge extraction outputs using append mode (valid in current n8n build). Input: Extract/Convert/AI-fallback unified items. Output: single extracted stream."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-fileio-kind",
              "name": "error_context.kind",
              "value": "={{ $json._err?.operation === \"validate_file_ref\" ? \"business\" : \"io\" }}",
              "type": "string"
            },
            {
              "id": "wf33-fileio-msg",
              "name": "error_context.message",
              "value": "={{ $json.error?.message || ($json._err?.operation === \"validate_file_ref\" ? \"File/blob reference missing\" : \"File extraction I/O failed\") }}",
              "type": "string"
            },
            {
              "id": "wf33-fileio-status",
              "name": "error_context.status_code",
              "value": "={{ $json._err?.operation === \"validate_file_ref\" ? 404 : 500 }}",
              "type": "number"
            },
            {
              "id": "wf33-fileio-retry",
              "name": "error_context.retryable",
              "value": "={{ $json._err?.operation === \"validate_file_ref\" ? false : true }}",
              "type": "boolean"
            },
            {
              "id": "wf33-fileio-node",
              "name": "error_context.details.node",
              "value": "={{ $json._err?.node }}",
              "type": "string"
            },
            {
              "id": "wf33-fileio-op",
              "name": "error_context.details.operation",
              "value": "={{ $json._err?.operation }}",
              "type": "string"
            },
            {
              "id": "wf33-fileio-table",
              "name": "error_context.details.table",
              "value": "={{ $json._err?.table }}",
              "type": "string"
            },
            {
              "id": "wf33-fileio-doc",
              "name": "error_context.details.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-fileio-ctx",
              "name": "error_context.ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-fileio-job",
              "name": "error_context.job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6448,
        5664
      ],
      "id": "c955a8e2-cc82-4b7c-9ded-39d3881d2bb6",
      "name": "ERR — Prepare ErrorPipe v1 (File I/O)",
      "notes": "Prepare ErrorPipe payload for all file path DB/S3/extractor/converter errors."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -6208,
        5664
      ],
      "id": "5223c5fd-f3e9-4126-9445-65c873195049",
      "name": "Execute WF99 (File I/O)",
      "notes": "Call WF99 for file extraction failures and return ErrorEnvelope."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-dbf-node",
              "name": "_err.node",
              "value": "DB — Select tg.files by file_unique_id",
              "type": "string"
            },
            {
              "id": "wf33-dbf-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "wf33-dbf-table",
              "name": "_err.table",
              "value": "tg.files",
              "type": "string"
            },
            {
              "id": "wf33-dbf-ctx",
              "name": "ctx",
              "value": "={{ $('Set — File Ref from Document').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-dbf-job",
              "name": "job",
              "value": "={{ $('Set — File Ref from Document').item.json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-dbf-doc",
              "name": "document_id",
              "value": "={{ $('Set — File Ref from Document').item.json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -13376,
        4528
      ],
      "id": "12b62006-2534-46f7-b274-0f3c4d97872c",
      "name": "ERR — Source DB File Ref",
      "notes": "Error source for tg.files lookup failure."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-dbb-node",
              "name": "_err.node",
              "value": "DB — Select blob_objects by sha256",
              "type": "string"
            },
            {
              "id": "wf33-dbb-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "wf33-dbb-table",
              "name": "_err.table",
              "value": "content.blob_objects",
              "type": "string"
            },
            {
              "id": "wf33-dbb-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-dbb-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-dbb-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12208,
        4752
      ],
      "id": "d4e8379a-2a24-41ad-9517-d54bef58b073",
      "name": "ERR — Source DB Blob Ref",
      "notes": "Error source for blob_objects lookup failure."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-miss-node",
              "name": "_err.node",
              "value": "GUARD — File Has sha256 / Blob Has storage_key",
              "type": "string"
            },
            {
              "id": "wf33-miss-op",
              "name": "_err.operation",
              "value": "validate_file_ref",
              "type": "string"
            },
            {
              "id": "wf33-miss-table",
              "name": "_err.table",
              "value": "tg.files/content.blob_objects",
              "type": "string"
            },
            {
              "id": "wf33-miss-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-miss-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-miss-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -12448,
        4752
      ],
      "id": "4448f9c1-f0e1-4bb9-b352-d05d247b07bf",
      "name": "ERR — Source Missing File Ref",
      "notes": "Managed error source when file/blob references are absent."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-s3-node",
              "name": "_err.node",
              "value": "S3 — Download Source File",
              "type": "string"
            },
            {
              "id": "wf33-s3-op",
              "name": "_err.operation",
              "value": "download",
              "type": "string"
            },
            {
              "id": "wf33-s3-table",
              "name": "_err.table",
              "value": "",
              "type": "string"
            },
            {
              "id": "wf33-s3-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-s3-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-s3-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11696,
        4432
      ],
      "id": "92135e80-6355-426b-9d5c-bcd48b9693f6",
      "name": "ERR — Source S3 Download",
      "notes": "Error source for S3 download failure."
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -10112,
        3248
      ],
      "id": "fc18669e-55f3-4689-8757-50e574d6bd57",
      "name": "Merge — Unified Extracted Text",
      "notes": "Join message/file/url branches into unified extraction item shape."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 3
          },
          "combinator": "and",
          "conditions": [
            {
              "id": "wf33-if-extracted",
              "leftValue": "={{ ($json.extracted_text || \"\").trim() }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -9744,
        3152
      ],
      "id": "acb28861-932e-48f6-8e88-7bd004b2961c",
      "name": "GUARD — Extracted Text NonEmpty",
      "notes": "Proceed to AI only when extracted_text is non-empty; otherwise return deterministic skipped success."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-skip-ok",
              "name": "ok",
              "value": true,
              "type": "boolean"
            },
            {
              "id": "wf33-skip-code",
              "name": "status_code",
              "value": 200,
              "type": "number"
            },
            {
              "id": "wf33-skip-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-skip-doc",
              "name": "result.document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-skip-ext",
              "name": "result.extracted",
              "value": false,
              "type": "boolean"
            },
            {
              "id": "wf33-skip-r",
              "name": "result.skipped_reason",
              "value": "empty_extracted_text",
              "type": "string"
            },
            {
              "id": "wf33-skip-enq",
              "name": "result.enqueued_chunk_job",
              "value": false,
              "type": "boolean"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9328,
        3408
      ],
      "id": "8ff58c48-211d-4457-8468-4b6995369d57",
      "name": "OUT — Success Envelope (Skipped Empty)",
      "notes": "Return deterministic success when extracted_text is empty (message/file/url) and skip enqueue."
    },
    {
      "parameters": {
        "jsCode": "return [{\n  json: {\n    tenant_id: '00000000-0000-0000-0000-000000000331',\n    file_unique_id: 'wf33_t1_file_unique_id',\n    file_name: 'sample_document.docx',\n    mime_type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    sha256_bytea: '\\\\x1111111111111111111111111111111111111111111111111111111111111111',\n    storage_key: 'test/media/sample_document.docx',\n    document_id: 331001\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "id": "580e7812-ad2e-4855-a369-f9503c81411d",
      "name": "TEST — Build Fixtures",
      "position": [
        -15664,
        4128
      ],
      "notes": "Single fixture item (T1) to avoid test-item multiplication in merge chains. Seeds tenant/file/blob/document for one real extraction run."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "core",
          "mode": "list",
          "cachedResultName": "core"
        },
        "table": {
          "__rl": true,
          "value": "tenants",
          "mode": "list",
          "cachedResultName": "tenants"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.tenant_id }}",
            "name": "WF33_TEST_TENANT",
            "is_active": true,
            "meta": {}
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "name",
              "displayName": "name",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "is_active",
              "displayName": "is_active",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": false
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "id": "d9b70c0c-9f5d-465d-b00b-443b2571cbd2",
      "name": "TEST — DB Upsert Tenant",
      "position": [
        -15472,
        3984
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Ensure test tenant exists for FK constraints. Input: fixture item. Output: tenant row upsert result."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "files",
          "mode": "list",
          "cachedResultName": "files"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "file_unique_id": "={{ $('TEST — Build Fixtures').item.json.file_unique_id }}",
            "file_type": "document",
            "mime_type": "={{ $('TEST — Build Fixtures').item.json.mime_type }}",
            "file_name": "={{ $('TEST — Build Fixtures').item.json.file_name }}",
            "file_size": 1024,
            "sha256": "={{ $('TEST — Build Fixtures').item.json.sha256_bytea }}",
            "meta": {}
          },
          "matchingColumns": [
            "file_unique_id"
          ],
          "schema": [
            {
              "id": "file_unique_id",
              "displayName": "file_unique_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_type",
              "displayName": "file_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "mime_type",
              "displayName": "mime_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "file_name",
              "displayName": "file_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "file_size",
              "displayName": "file_size",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "sha256",
              "displayName": "sha256",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "id": "71adcc76-6597-4e70-b45e-f018d093642e",
      "name": "TEST — DB Upsert tg.files",
      "position": [
        -15280,
        4144
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Seed tg.files rows used by content.documents.file_unique_id FK and sha256->blob mapping."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "content",
          "mode": "list",
          "cachedResultName": "content"
        },
        "table": {
          "__rl": true,
          "value": "blob_objects",
          "mode": "list",
          "cachedResultName": "blob_objects"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "sha256": "={{ $('TEST — Build Fixtures').item.json.sha256_bytea }}",
            "byte_size": "=1024",
            "storage_key": "={{ $('TEST — Build Fixtures').item.json.storage_key }}",
            "storage_kind": "s3",
            "meta": "{}"
          },
          "matchingColumns": [
            "sha256"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "sha256",
              "displayName": "sha256",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "byte_size",
              "displayName": "byte_size",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false
            },
            {
              "id": "storage_kind",
              "displayName": "storage_kind",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "storage_key",
              "displayName": "storage_key",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "id": "643356a0-42c3-4ae7-87db-3e4930dcbc0b",
      "name": "TEST — DB Upsert blob_objects",
      "position": [
        -15024,
        3984
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Seed content.blob_objects with S3 storage_key for extractor file download."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "content",
          "mode": "list",
          "cachedResultName": "content"
        },
        "table": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('TEST — Build Fixtures').item.json.document_id }}",
            "tenant_id": "={{ $('TEST — Build Fixtures').item.json.tenant_id }}",
            "doc_type": "file",
            "file_unique_id": "={{ $('TEST — Build Fixtures').item.json.file_unique_id }}",
            "status": "pending",
            "title": "WF33_TEST"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "doc_type",
              "displayName": "doc_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": false,
              "options": [
                {
                  "name": "voice",
                  "value": "voice"
                },
                {
                  "name": "url",
                  "value": "url"
                },
                {
                  "name": "file",
                  "value": "file"
                },
                {
                  "name": "message",
                  "value": "message"
                }
              ]
            },
            {
              "id": "visibility",
              "displayName": "visibility",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": false,
              "options": [
                {
                  "name": "admin_only",
                  "value": "admin_only"
                },
                {
                  "name": "dm_private",
                  "value": "dm_private"
                },
                {
                  "name": "group",
                  "value": "group"
                }
              ],
              "removed": true
            },
            {
              "id": "dm_owner_user_id",
              "displayName": "dm_owner_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "message_version_id",
              "displayName": "message_version_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "file_unique_id",
              "displayName": "file_unique_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "url_id",
              "displayName": "url_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "source_created_at",
              "displayName": "source_created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "language",
              "displayName": "language",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "text",
              "displayName": "text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "text_sha256",
              "displayName": "text_sha256",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "token_count",
              "displayName": "token_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": false,
              "options": [
                {
                  "name": "failed",
                  "value": "failed"
                },
                {
                  "name": "succeeded",
                  "value": "succeeded"
                },
                {
                  "name": "pending",
                  "value": "pending"
                }
              ]
            },
            {
              "id": "error",
              "displayName": "error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "description",
              "displayName": "description",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "id": "e8db2841-87b8-44f1-afa0-49d10028fd35",
      "name": "TEST — DB Upsert content.documents",
      "position": [
        -14688,
        4016
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Seed file documents for T1/T2 extraction tests. Output document_ids are fed into worker requests."
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {
          "keepSource": "json"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        2768
      ],
      "id": "d0658cdb-b63e-4442-928e-f9a0ea8956ce",
      "name": "Extract — From PDF",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=pdf. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "text",
        "options": {
          "encoding": "utf8",
          "stripBOM": true,
          "keepSource": "json"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        2928
      ],
      "id": "41b2aba8-e405-40a4-91d9-3976f236eb2e",
      "name": "Extract — From Text",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=text. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "options": {
          "encoding": "utf8"
        }
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3088
      ],
      "id": "e9deefe6-27a8-4228-a58e-56538887a9fa",
      "name": "Extract — From CSV",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=csv. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "html",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3248
      ],
      "id": "7cb2ddae-dfd5-45e2-b456-4f266fdf0642",
      "name": "Extract — From HTML",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=html. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "json"
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3408
      ],
      "id": "63eded3d-ef2b-429f-810e-56b4d6e49625",
      "name": "Extract — From JSON",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=json. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "ics"
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3568
      ],
      "id": "4abf86aa-f7ef-4e46-ac5b-b05791bad55f",
      "name": "Extract — From ICS",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=ics. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "rtf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3712
      ],
      "id": "f4ae8f64-f672-44c1-b0f1-b592e4a74036",
      "name": "Extract — From RTF",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=rtf. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        3872
      ],
      "id": "234713f8-94a3-4b6e-822b-8905edd290c3",
      "name": "Extract — From XLSX",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=xlsx. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "xls",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        4032
      ],
      "id": "6bd0bef5-c3fb-42e7-b166-0354692fb711",
      "name": "Extract — From XLS",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=xls. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "operation": "ods",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1.1,
      "position": [
        -11872,
        4176
      ],
      "id": "dfd87b79-2036-4ab1-893b-d21a94eaa08e",
      "name": "Extract — From ODS",
      "onError": "continueErrorOutput",
      "notes": "Extract From File operation=ods. INPUT: binary data + file metadata. OUTPUT: extracted JSON/text. WHY: only for formats supported by core Extract From File."
    },
    {
      "parameters": {
        "resource": "document",
        "modelId": {
          "__rl": true,
          "value": "models/gemini-2.5-flash",
          "mode": "list",
          "cachedResultName": "models/gemini-2.5-flash"
        },
        "text": "You are a strict JSON generator. Output ONLY one valid JSON OBJECT.\nDo NOT wrap the JSON in quotes. Do NOT use markdown/code fences.\nThe first character must be { and the last character must be }\nAnalyze the document and return ONLY this JSON object with exactly these keys:\n{\"description\":\"...\",\"transcription\":\"...\",\"language\":\"...\"}\nRules:\nNo extra keys, no comments.\ndescription: a detailed description of what is in the document, avoid using the \" character inside the text (use ' or curly quotes “ ” if needed).\ntranscription: verbatim text in windows encoding, if present in the document; if no text, \"\"\nlanguage: a language used in the document, ISO 639-1 code when possible, else \"und\"",
        "inputType": "binary",
        "simplify": false,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.googleGemini",
      "typeVersion": 1.1,
      "position": [
        -10768,
        4080
      ],
      "id": "1c43b32b-8dcd-4710-8fea-5e7ee89cf8a4",
      "name": "AI — Analyze Document Fallback",
      "credentials": {
        "googlePalmApi": {
          "id": "4J3UGUqYNZJxtTVa",
          "name": "Google Gemini(PaLM) Api account"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Fallback extractor for unsupported file types or extractor/converter failures. INPUT: binary file. OUTPUT: strict JSON with description/transcription/language."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-aif-txt",
              "name": "extracted_text",
              "value": "={{ $json.transcription || $json.text || JSON.stringify($json) }}",
              "type": "string"
            },
            {
              "id": "wf33-aif-meta-src",
              "name": "extracted_meta.extract_source",
              "value": "gemini_analyze_document_fallback",
              "type": "string"
            },
            {
              "id": "wf33-aif-meta-raw",
              "name": "extracted_meta.gemini",
              "value": "={{ $json }}",
              "type": "object"
            },
            {
              "id": "wf33-aif-doc",
              "name": "document_id",
              "value": "={{ $json.document_id || $('Merge — Restore CTX after S3').item.json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-aif-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx || $('Merge — Restore CTX after S3').item.json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-aif-job",
              "name": "job",
              "value": "={{ $json.job || $('Merge — Restore CTX after S3').item.json.job }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -10448,
        3984
      ],
      "id": "1425f9ec-f551-4247-a0c4-5142d62b0ef8",
      "name": "Set — Unified from AI Fallback",
      "notes": "Map Gemini Analyze Document fallback output into unified extraction payload for shared downstream processing."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-aif-err-node",
              "name": "_err.node",
              "value": "AI — Analyze Document Fallback",
              "type": "string"
            },
            {
              "id": "wf33-aif-err-op",
              "name": "_err.operation",
              "value": "analyze_document",
              "type": "string"
            },
            {
              "id": "wf33-aif-err-table",
              "name": "_err.table",
              "value": "",
              "type": "string"
            },
            {
              "id": "wf33-aif-err-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-aif-err-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-aif-err-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -10240,
        5200
      ],
      "id": "9e46afd8-9952-4ef5-af90-72a9b0117cbb",
      "name": "ERR — Source AI Fallback",
      "notes": "Error source wrapper for Gemini Analyze Document fallback failures."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "passThrough"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -10992,
        4048
      ],
      "id": "83236afb-f5d9-41aa-a809-3dbe13d81db3",
      "name": "Merge — Fallback Inputs",
      "notes": "Join three fallback entry points: unsupported mime route, Extract fatal error route, Convert error route."
    },
    {
      "parameters": {
        "bucketName": "dfassistant",
        "fileKey": "={{ $json.storage_key }}"
      },
      "type": "n8n-nodes-base.s3",
      "typeVersion": 1,
      "position": [
        -12864,
        3136
      ],
      "id": "b4102a7a-fd28-474b-95ae-16aa3e3cee46",
      "name": "S3 - Download a file",
      "credentials": {
        "s3": {
          "id": "hjNqGx5slcq2dEGk",
          "name": "S3 account"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Test/manual support node."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-carry-ai-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-carry-ai-text",
              "name": "extracted_text",
              "value": "={{ $json.extracted_text }}",
              "type": "string"
            },
            {
              "id": "wf33-carry-ai-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-carry-ai-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            },
            {
              "id": "wf33-carry-ai-meta",
              "name": "extracted_meta",
              "value": "={{ $json.extracted_meta || {} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -9488,
        3120
      ],
      "id": "6ec4d127-4f6d-4b55-9997-2876dffabc5f",
      "name": "Carry — Pre AI Description",
      "notes": "Carry unified context before AI node that may overwrite fields. Input: unified extraction payload. Output: same item with guaranteed document_id/extracted_text/ctx/job."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -8944,
        2912
      ],
      "id": "f1952c6b-2720-4127-bf0d-1d17d98ef8fe",
      "name": "Merge — Restore CTX after AI",
      "notes": "Restore carried fields after AI response. Input1: AI output. Input2: carry item. Output: AI fields + document_id/extracted_text/ctx/job."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wf33-carry-conv-doc",
              "name": "document_id",
              "value": "={{ $json.document_id }}",
              "type": "number"
            },
            {
              "id": "wf33-carry-conv-ctx",
              "name": "ctx",
              "value": "={{ $json.ctx }}",
              "type": "object"
            },
            {
              "id": "wf33-carry-conv-job",
              "name": "job",
              "value": "={{ $json.job }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -11056,
        3648
      ],
      "id": "8259c0e3-c266-46c5-9f51-3a5cc2ef7acc",
      "name": "Carry — Pre Convert File",
      "notes": "Carry context before Convert node that may overwrite json fields. Input: file item from switch/unsupported branch. Output: same item with guaranteed ctx/job/document_id."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        -10704,
        3632
      ],
      "id": "0d87c97e-8b69-40d6-a7fb-8170aefa50b9",
      "name": "Merge — Restore CTX after Convert",
      "notes": "Restore ctx/job/document_id after Convert output. Input1: Convert output. Input2: carried context. Output: converted payload + restored context."
    }
  ],
  "pinData": {},
  "connections": {
    "IN — Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "Set — Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Normalize Input": {
      "main": [
        [
          {
            "node": "GUARD — Input Valid",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after DB Load",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "GUARD — Input Valid": {
      "main": [
        [
          {
            "node": "DB — Load Document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Input Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source Input Guard": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (Input)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (Input)": {
      "main": [
        [
          {
            "node": "Execute WF99 (Input)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute WF99 (Input)": {
      "main": [
        [
          {
            "node": "Merge — Final (Success + All Errors)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DB — Load Document": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after DB Load",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source DB Load Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source DB Load Doc": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (DB Doc)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (DB Doc)": {
      "main": [
        [
          {
            "node": "Execute WF99 (DB Doc)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after DB Load": {
      "main": [
        [
          {
            "node": "CTL — Route by doc_type: message?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CTL — Route by doc_type: message?": {
      "main": [
        [
          {
            "node": "GUARD — Message Has Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "CTL — Route by doc_type: file?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CTL — Route by doc_type: file?": {
      "main": [
        [
          {
            "node": "Set — File Ref from Document",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — URL Placeholder Unified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GUARD — Message Has Text": {
      "main": [
        [
          {
            "node": "Set — Message: Extract Existing Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Message Empty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source Message Empty": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (Empty Text)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (Empty Text)": {
      "main": [
        [
          {
            "node": "Execute WF99 (Empty Text)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Message: Extract Existing Text": {
      "main": [
        [
          {
            "node": "Merge — Unified Extracted Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI — Generate Description (Gemini)": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after AI",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source AI Description",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source AI Description": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (AI Desc)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (AI Desc)": {
      "main": [
        [
          {
            "node": "Execute WF99 (AI Desc)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract Description from AI Response": {
      "main": [
        [
          {
            "node": "Crypto — Compute SHA256",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crypto — Compute SHA256": {
      "main": [
        [
          {
            "node": "Set — Prepare Bytea Format",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Bytea Format": {
      "main": [
        [
          {
            "node": "DB — Update Document (Success)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after DB Update",
            "type": "main",
            "index": 1
          },
          {
            "node": "Set — Prepare Enqueue Payload",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after Enqueue",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DB — Update Document (Success)": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after DB Update",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source DB Update Doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source DB Update Doc": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (DB Update)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (DB Update)": {
      "main": [
        [
          {
            "node": "Execute WF99 (DB Update)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after DB Update": {
      "main": [
        [
          {
            "node": "Set — Prepare Enqueue Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Enqueue Payload": {
      "main": [
        [
          {
            "node": "DB — Enqueue chunk_document Job",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after Enqueue",
            "type": "main",
            "index": 1
          },
          {
            "node": "OUT — Success Envelope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB — Enqueue chunk_document Job": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after Enqueue",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source DB Enqueue",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source DB Enqueue": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (DB Enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (DB Enqueue)": {
      "main": [
        [
          {
            "node": "Execute WF99 (DB Enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after Enqueue": {
      "main": [
        [
          {
            "node": "OUT — Success Envelope",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OUT — Success Envelope": {
      "main": [
        [
          {
            "node": "Merge — Final (Success + All Errors)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — Manual Trigger": {
      "main": [
        [
          {
            "node": "TEST — Build Fixtures",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — File Ref from Document": {
      "main": [
        [
          {
            "node": "DB — Select tg.files by file_unique_id",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after tg.files",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "DB — Select tg.files by file_unique_id": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after tg.files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source DB File Ref",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after tg.files": {
      "main": [
        [
          {
            "node": "GUARD — File Has sha256",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GUARD — File Has sha256": {
      "main": [
        [
          {
            "node": "DB — Select blob_objects by sha256",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after blob lookup",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "ERR — Source Missing File Ref",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DB — Select blob_objects by sha256": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after blob lookup",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source DB Blob Ref",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after blob lookup": {
      "main": [
        [
          {
            "node": "GUARD — Blob Has storage_key",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GUARD — Blob Has storage_key": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after S3",
            "type": "main",
            "index": 1
          },
          {
            "node": "S3 - Download a file",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Missing File Ref",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore CTX after S3": {
      "main": [
        [
          {
            "node": "Set — Detect File Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Detect File Type": {
      "main": [
        [
          {
            "node": "SWITCH — Route by File Type",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Unified from Extract": {
      "main": [
        [
          {
            "node": "Merge — File Extract Unified",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source Extract File": {
      "main": [
        [
          {
            "node": "IF — Extract Error Is Unsupported",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Extract Error Is Unsupported": {
      "main": [
        [
          {
            "node": "Carry — Pre Convert File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge — Fallback Inputs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Convert — File To Json": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after Convert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Convert File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "CODE — Flatten Converted JSON": {
      "main": [
        [
          {
            "node": "Merge — File Extract Unified",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — File Extract Unified": {
      "main": [
        [
          {
            "node": "Merge — Unified Extracted Text",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ERR — Source DB File Ref": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source DB Blob Ref": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source Missing File Ref": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source S3 Download": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Prepare ErrorPipe v1 (File I/O)": {
      "main": [
        [
          {
            "node": "Execute WF99 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Unified Extracted Text": {
      "main": [
        [
          {
            "node": "GUARD — Extracted Text NonEmpty",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GUARD — Extracted Text NonEmpty": {
      "main": [
        [
          {
            "node": "Carry — Pre AI Description",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "OUT — Success Envelope (Skipped Empty)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — Build Fixtures": {
      "main": [
        [
          {
            "node": "TEST — DB Upsert Tenant",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — DB Upsert Tenant": {
      "main": [
        [
          {
            "node": "TEST — DB Upsert tg.files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Input Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — DB Upsert tg.files": {
      "main": [
        [
          {
            "node": "TEST — DB Upsert blob_objects",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Input Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — DB Upsert blob_objects": {
      "main": [
        [
          {
            "node": "TEST — DB Upsert content.documents",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Input Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — DB Upsert content.documents": {
      "main": [
        [
          {
            "node": "TEST — Build Worker Requests",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Input Guard",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TEST — Build Worker Requests": {
      "main": [
        [
          {
            "node": "Set — Normalize Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SWITCH — Route by File Type": {
      "main": [
        [
          {
            "node": "Extract — From PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From Text",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From HTML",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From JSON",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From ICS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From RTF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From XLSX",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From XLS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract — From ODS",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Carry — Pre Convert File",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge — Fallback Inputs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From PDF": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From Text": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From CSV": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From HTML": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From JSON": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From ICS": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From RTF": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From XLSX": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From XLS": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract — From ODS": {
      "main": [
        [
          {
            "node": "Set — Unified from Extract",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source Extract File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Fallback Inputs": {
      "main": [
        [
          {
            "node": "AI — Analyze Document Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI — Analyze Document Fallback": {
      "main": [
        [
          {
            "node": "Set — Unified from AI Fallback",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source AI Fallback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source AI Fallback": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source Convert File": {
      "main": [
        [
          {
            "node": "ERR — Prepare ErrorPipe v1 (File I/O)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S3 - Download a file": {
      "main": [
        [
          {
            "node": "Merge — Restore CTX after S3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source S3 Download",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Carry — Pre AI Description": {
      "main": [
        [
          {
            "node": "AI — Generate Description (Gemini)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after AI",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore CTX after AI": {
      "main": [
        [
          {
            "node": "Set — Extract Description from AI Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Carry — Pre Convert File": {
      "main": [
        [
          {
            "node": "Convert — File To Json",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore CTX after Convert",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore CTX after Convert": {
      "main": [
        [
          {
            "node": "CODE — Flatten Converted JSON",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false
  },
  "versionId": "63a76145-646d-4f76-aafa-d6f69e03958f",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49b1b765c7a60d5365a95e5c3e2d1b2e695b21e61861bbe488c27ec04546a71d"
  },
  "id": "VxHQSdnSqx-IP0pWSJ0LX",
  "tags": []
}