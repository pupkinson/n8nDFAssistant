{"name":"WF50 — Answer Query","nodes":[{"id":"n1","name":"IN — Execute Workflow Trigger","type":"n8n-nodes-
  base.executeWorkflowTrigger","typeVersion":1.1,"position":[-1880,160],"parameters":{"inputSource":"passthrough"},"notes":"PURPOSE: entry. INPUT:
  req.ctx+req.job. OUTPUT: spine. WHY: WF90 worker contract."},{"id":"n2","name":"Set — Normalize Input","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[-1660,160],"parameters":{"assignments":{"assignments":
  [{"id":"a1","name":"req","value":"={{ $json.req }}","type":"object"},{"id":"a2","name":"req.ctx","value":"={{ $json.req?.ctx }}","type":"object"},
  {"id":"a3","name":"req.job","value":"={{ $json.req?.job }}","type":"object"},{"id":"a4","name":"req.job.job_id","value":"={{ $json.req?.job?.job_id ||
  $json.req?.job?.id || null }}","type":"number"},{"id":"a5","name":"req.job.job_run_id","value":"={{ $json.req?.job?.job_run_id || $json._meta?.job_run_id ||
  null }}","type":"number"},{"id":"a6","name":"ctx.contracts.errorpipe","value":1,"type":"number"}]},"options":{"dotNotation":true}},"notes":"PURPOSE:
  normalize. INPUT: raw item. OUTPUT: req.* canonical. WHY: stable field paths."},{"id":"n3","name":"GUARD — Validate Input","type":"n8n-nodes-
  base.if","typeVersion":2.3,"position":[-1440,160],"parameters":{"conditions":{"options":{"version":3},"combinator":"and","conditions":
  [{"id":"c1","leftValue":"={{ $json.req?.ctx?.correlation_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},
  {"id":"c2","leftValue":"={{ $json.req?.ctx?.tenant_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},
  {"id":"c3","leftValue":"={{ $json.req?.job?.job_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},
  {"id":"c4","leftValue":"={{ $json.req?.job?.job_type }}","rightValue":"answer_query","operator":{"type":"string","operation":"equals"}},
  {"id":"c5","leftValue":"={{ $json.req?.job?.payload?.chat_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},
  {"id":"c6","leftValue":"={{ $json.req?.job?.payload?.actor_user_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}},
  {"id":"c7","leftValue":"={{ ($json.req?.job?.payload?.query_text || "").trim() }}","rightValue":"","operator":
  {"type":"string","operation":"notEmpty"}}]},"options":{}},"notes":"PURPOSE: validate. INPUT: req. OUTPUT: true/false. WHY: managed 400 on bad payload."},
  {"id":"n4","name":"OUT — ManagedFailure Validation","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1220,40],"parameters":{"assignments":
  {"assignments":[{"id":"v1","name":"ok","value":false,"type":"boolean"},{"id":"v2","name":"status_code","value":400,"type":"number"},
  {"id":"v3","name":"error.type","value":"validation_error","type":"string"},{"id":"v4","name":"error.message","value":"Invalid answer_query input
  contract","type":"string"},{"id":"v5","name":"error.retryable","value":false,"type":"boolean"},
  {"id":"v6","name":"error.details.reason","value":"missing_required_fields_or_wrong_job_type","type":"string"},
  {"id":"v7","name":"ctx.correlation_id","value":"={{ $json.req?.ctx?.correlation_id || null }}","type":"string"},
  {"id":"v8","name":"ctx.tenant_id","value":"={{ $json.req?.ctx?.tenant_id || null }}","type":"string"},
  {"id":"v9","name":"ctx.bot_id","value":"={{ $json.req?.ctx?.bot_id || $json.req?.job?.payload?.bot_id || null }}","type":"string"},
  {"id":"v10","name":"ctx.chat_id","value":"={{ $json.req?.job?.payload?.chat_id || null }}","type":"number"},
  {"id":"v11","name":"ctx.actor_user_id","value":"={{ $json.req?.job?.payload?.actor_user_id || null }}","type":"number"},
  {"id":"v12","name":"ctx.job_id","value":"={{ $json.req?.job?.job_id || null }}","type":"number"},
  {"id":"v13","name":"ctx.job_run_id","value":"={{ $json.req?.job?.job_run_id || null }}","type":"number"}]},"options":{"dotNotation":true}},"notes":"PURPOSE:
  return 400. INPUT: invalid branch. OUTPUT: managed failure. WHY: no unmanaged throw."},{"id":"n5","name":"CTX — Prepare WF00c Request","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[-1220,280],"parameters":{"assignments":{"assignments":
  [{"id":"w1","name":"wf00c.req.tenant_id","value":"={{ $json.req.ctx.tenant_id }}","type":"string"},
  {"id":"w2","name":"wf00c.req.bot_id","value":"={{ $json.req.ctx.bot_id || $json.req.job.payload.bot_id || null }}","type":"string"},
  {"id":"w3","name":"wf00c.req.tg_user_id","value":"={{ $json.req.job.payload.actor_user_id }}","type":"number"},
  {"id":"w4","name":"wf00c.req.chat_id","value":"={{ $json.req.job.payload.chat_id }}","type":"number"},
  {"id":"w5","name":"wf00c.req.channel","value":"={{ $json.req.job.payload.channel || (($json.req.job.payload.chat_type || "") === "private" ? "dm" :
  "group") }}","type":"string"},{"id":"w6","name":"wf00c.req.trace_id","value":"={{ $json.req.ctx.trace_id || null }}","type":"string"},
  {"id":"w7","name":"wf00c.req.correlation_id","value":"={{ $json.req.ctx.correlation_id }}","type":"string"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: map to WF00c input. INPUT: req. OUTPUT: wf00c.req. WHY: canonical ACL context loader."},{"id":"n6","name":"CTX —
  Execute WF00c","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[-1000,280],"parameters":{"workflowId":{"__rl":true,"value":"WF00c —
  Context Loader (ACL + Chat Policy + Visibility)","mode":"list"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":
  [],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"onError":"continueErrorOutput","notes":"PURPOSE: load
  ctx. INPUT: wf00c.req. OUTPUT: canonical ctx envelope. WHY: ACL-first requirement."},{"id":"n7","name":"CTX — Canonicalize","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[-780,280],"parameters":{"assignments":{"assignments":[{"id":"k1","name":"ctx","value":"={{ $json.data?.ctx ||
  $json.ctx }}","type":"object"},{"id":"k2","name":"ctx.correlation_id","value":"={{ $json.data?.ctx?.correlation_id || $json.ctx?.correlation_id || $("Set —
  Normalize Input").item.json.req.ctx.correlation_id }}","type":"string"},{"id":"k3","name":"ctx.tenant_id","value":"={{ $json.data?.ctx?.tenant_id ||
  $json.ctx?.tenant_id || $("Set — Normalize Input").item.json.req.ctx.tenant_id }}","type":"string"},
  {"id":"k4","name":"ctx.bot_id","value":"={{ $json.data?.ctx?.bot_id || $json.ctx?.bot_id || $("Set — Normalize Input").item.json.req.ctx.bot_id || $("Set —
  Normalize Input").item.json.req.job.payload.bot_id || null }}","type":"string"},{"id":"k5","name":"ctx.chat_id","value":"={{ $json.data?.ctx?.chat_id ||
  $json.ctx?.chat_id || $("Set — Normalize Input").item.json.req.job.payload.chat_id }}","type":"number"},
  {"id":"k6","name":"ctx.actor_user_id","value":"={{ $json.data?.ctx?.tg_user_id || $json.ctx?.tg_user_id || $("Set — Normalize
  Input").item.json.req.job.payload.actor_user_id }}","type":"number"},{"id":"k7","name":"ctx.role","value":"={{ $json.data?.ctx?.role || $json.ctx?.role ||
  "user" }}","type":"string"},{"id":"k8","name":"ctx.channel","value":"={{ $json.data?.ctx?.channel || $json.ctx?.channel || $("Set — Normalize
  Input").item.json.req.job.payload.channel || "group" }}","type":"string"},{"id":"k9","name":"ctx.chat_type","value":"={{ $json.data?.ctx?.chat_type ||
  $json.ctx?.chat_type || $("Set — Normalize Input").item.json.req.job.payload.chat_type || null }}","type":"string"},
  {"id":"k10","name":"ctx.is_allowed","value":"={{ $json.data?.ctx?.is_allowed !== undefined ? $json.data.ctx.is_allowed : ($json.ctx?.is_allowed !==
  undefined ? $json.ctx.is_allowed : true) }}","type":"boolean"},{"id":"k11","name":"ctx.chat_policy","value":"={{ $json.data?.ctx?.chat_policy ||
  $json.ctx?.chat_policy }}","type":"object"},{"id":"k12","name":"ctx.job_id","value":"={{ $("Set — Normalize
  Input").item.json.req.job.job_id }}","type":"number"},{"id":"k13","name":"ctx.job_run_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_run_id
  || null }}","type":"number"},{"id":"k14","name":"query_text","value":"={{ $("Set — Normalize
  Input").item.json.req.job.payload.query_text }}","type":"string"},{"id":"k15","name":"reply_to_message_id","value":"={{ $("Set — Normalize
  Input").item.json.req.job.payload.reply_to_message_id || null }}","type":"number"},{"id":"k16","name":"req","value":"={{ $("Set — Normalize
  Input").item.json.req }}","type":"object"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: canonical ctx spine. INPUT: WF00c output. OUTPUT: ctx/query
  fields. WHY: consistent downstream access."},{"id":"n8","name":"ACL — Guard Context Allowed","type":"n8n-nodes-base.if","typeVersion":2.3,"position":
  [-560,280],"parameters":{"conditions":{"options":{"version":3},"combinator":"and","conditions":
  [{"id":"ga","leftValue":"={{ $json.ctx.is_allowed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}},
  {"id":"gb","leftValue":"={{ $json.ctx.tenant_id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty"}}]},"options":{}},"notes":"PURPOSE:
  enforce ACL allow. INPUT: ctx. OUTPUT: allow/deny. WHY: retrieval must not run if denied."},{"id":"n9","name":"OUT — ManagedFailure ACL","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[-340,120],"parameters":{"assignments":{"assignments":[{"id":"fa1","name":"ok","value":false,"type":"boolean"},
  {"id":"fa2","name":"status_code","value":403,"type":"number"},{"id":"fa3","name":"error.type","value":"acl_forbidden","type":"string"},
  {"id":"fa4","name":"error.message","value":"Access denied by canonical context","type":"string"},
  {"id":"fa5","name":"error.retryable","value":false,"type":"boolean"},
  {"id":"fa6","name":"error.details.reason","value":"ctx.is_allowed=false","type":"string"},
  {"id":"fa7","name":"ctx","value":"={{ $json.ctx }}","type":"object"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: return 403. INPUT: ACL false. OUTPUT:
  managed failure. WHY: deterministic denial."},{"id":"n10","name":"DB — Verify Group Membership Current","type":"n8n-nodes-
  base.postgres","typeVersion":2.6,"position":[-340,420],"credentials":{"postgres":{"id":"yckAFBLpmdhsPaDZ","name":"Postgres DF
  Assistant"}},"onError":"continueErrorOutput","parameters":{"operation":"select","schema":
  {"__rl":true,"value":"tg","mode":"list","cachedResultName":"tg"},"table":
  {"__rl":true,"value":"chat_memberships_current","mode":"list","cachedResultName":"chat_memberships_current"},"limit":1,"where":{"values":
  [{"column":"tenant_id","value":"={{ $json.ctx.tenant_id }}"},{"column":"chat_id","value":"={{ $json.ctx.chat_id }}"},
  {"column":"tg_user_id","value":"={{ $json.ctx.actor_user_id }}"}]},"options":{"alwaysOutputData":true}},"notes":"PURPOSE: group membership check. INPUT:
  tenant/chat/user. OUTPUT: row or none. WHY: group path requires membership_current."},{"id":"n11","name":"DB — Select Actor Membership Chats","type":"n8n-
  nodes-base.postgres","typeVersion":2.6,"position":[-120,420],"credentials":{"postgres":{"id":"yckAFBLpmdhsPaDZ","name":"Postgres DF
  Assistant"}},"onError":"continueErrorOutput","parameters":{"operation":"select","schema":
  {"__rl":true,"value":"tg","mode":"list","cachedResultName":"tg"},"table":
  {"__rl":true,"value":"chat_memberships_current","mode":"list","cachedResultName":"chat_memberships_current"},"where":{"values":
  [{"column":"tenant_id","value":"={{ $json.ctx.tenant_id }}"},{"column":"tg_user_id","value":"={{ $json.ctx.actor_user_id }}"}]},"options":
  {"alwaysOutputData":true}},"notes":"PURPOSE: dm-user scope source. INPUT: tenant/user. OUTPUT: chat_ids. WHY: DM non-admin limited by memberships."},
  {"id":"n12","name":"DB — Select Tenant Enabled Chats","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[100,420],"credentials":{"postgres":
  {"id":"yckAFBLpmdhsPaDZ","name":"Postgres DF Assistant"}},"onError":"continueErrorOutput","parameters":{"operation":"select","schema":
  {"__rl":true,"value":"core","mode":"list","cachedResultName":"core"},"table":
  {"__rl":true,"value":"tenant_chats","mode":"list","cachedResultName":"tenant_chats"},"where":{"values":
  [{"column":"tenant_id","value":"={{ $json.ctx.tenant_id }}"},{"column":"is_enabled","value":"={{ true }}"}]},"options":
  {"alwaysOutputData":true}},"notes":"PURPOSE: dm-admin scope source. INPUT: tenant. OUTPUT: enabled chat_ids. WHY: admin can search tenant chat scope."},
  {"id":"n13","name":"ACL — Build AccessScope","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[320,420],"parameters":{"assignments":{"assignments":
  [{"id":"s1","name":"access_scope.is_group_origin","value":"={{ (($json.ctx.chat_type || "") === "group" || ($json.ctx.chat_type || "") === "supergroup" ||
  ($json.ctx.channel || "") === "group") }}","type":"boolean"},{"id":"s2","name":"access_scope.is_admin","value":"={{ ($json.ctx.role || "user") ===
  "admin" }}","type":"boolean"},{"id":"s3","name":"access_scope.origin_chat_id","value":"={{ $json.ctx.chat_id }}","type":"number"},
  {"id":"s4","name":"access_scope.group_member_exists","value":"={{ $items("DB — Verify Group Membership Current").filter(i => i.json && i.json.chat_id !==
  undefined).length > 0 }}","type":"boolean"},{"id":"s5","name":"access_scope.allowed_chat_ids","value":"={{ $json.access_scope?.is_group_origin ?
  [$json.ctx.chat_id] : ($json.access_scope?.is_admin ? $items("DB — Select Tenant Enabled Chats").filter(i => i.json && i.json.chat_id !== undefined &&
  i.json.chat_id !== null).map(i => i.json.chat_id) : $items("DB — Select Actor Membership Chats").filter(i => i.json && i.json.chat_id !== undefined &&
  i.json.chat_id !== null).map(i => i.json.chat_id)) }}","type":"array"},
  {"id":"s6","name":"access_scope.actor_user_id","value":"={{ $json.ctx.actor_user_id }}","type":"number"},
  {"id":"s7","name":"access_scope.tenant_id","value":"={{ $json.ctx.tenant_id }}","type":"string"},
  {"id":"s8","name":"access_scope.allow_embedding","value":"={{ ($json.ctx.chat_policy?.allow_embedding !== undefined ? $json.ctx.chat_policy.allow_embedding :
  true) }}","type":"boolean"},{"id":"s9","name":"access_scope.scope_allowed","value":"={{ $json.access_scope?.is_group_origin ?
  $json.access_scope?.group_member_exists : ($json.access_scope?.is_admin || (($json.access_scope?.allowed_chat_ids || []).length >
  0)) }}","type":"boolean"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: build ACL scope object. INPUT: ctx + membership selects. OUTPUT: access_scope..
  WHY: retrieval SQL enforces these constraints."},{"id":"n14","name":"ACL — Guard Scope Allowed","type":"n8n-nodes-base.if","typeVersion":2.3,"position":
  [540,420],"parameters":{"conditions":{"options":{"version":3},"combinator":"and","conditions":
  [{"id":"gs1","leftValue":"={{ $json.access_scope.scope_allowed }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}]},"options":
  {}},"notes":"PURPOSE: block if scope invalid (e.g. group without membership). INPUT: access_scope. OUTPUT: true/false. WHY: enforce ACL before retrieval."},
  {"id":"n15","name":"OUT — ManagedFailure Scope","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[760,300],"parameters":{"assignments":{"assignments":
  [{"id":"fs1","name":"ok","value":false,"type":"boolean"},{"id":"fs2","name":"status_code","value":403,"type":"number"},
  {"id":"fs3","name":"error.type","value":"acl_scope_forbidden","type":"string"},{"id":"fs4","name":"error.message","value":"AccessScope validation
  failed","type":"string"},{"id":"fs5","name":"error.retryable","value":false,"type":"boolean"},
  {"id":"fs6","name":"error.details.reason","value":"group_membership_required_or_empty_scope","type":"string"},
  {"id":"fs7","name":"ctx","value":"={{ $json.ctx }}","type":"object"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: return 403 for scope denial. INPUT:
  scope false branch. OUTPUT: managed failure. WHY: no retrieval outside allowed scope."},{"id":"n16","name":"RETRIEVE — Embedding Allowed?","type":"n8n-nodes-
  base.if","typeVersion":2.3,"position":[760,520],"parameters":{"conditions":{"options":{"version":3},"combinator":"and","conditions":
  [{"id":"ea1","leftValue":"={{ $json.access_scope.allow_embedding }}","rightValue":true,"operator":{"type":"boolean","operation":"true"}}]},"options":
  {}},"notes":"PURPOSE: policy gate for embeddings. INPUT: access_scope.allow_embedding. OUTPUT: retrieve vs empty. WHY: respect chat policy flags."},
  {"id":"n17","name":"RETRIEVE — Empty Candidates","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[980,620],"parameters":{"assignments":
  {"assignments":[{"id":"ec1","name":"retrieval.candidates","value":"={{ [] }}","type":"array"},
  {"id":"ec2","name":"retrieval.candidate_count","value":0,"type":"number"},
  {"id":"ec3","name":"retrieval.note","value":"no_candidates_in_scope_or_embedding_disabled","type":"string"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: empty retrieval payload. INPUT: embedding-disabled branch. OUTPUT: candidates=[] for WF51. WHY: WF51 still answers
  with scope-aware message."},{"id":"n18","name":"DB — Select Active Embedding Model","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":
  [980,420],"credentials":{"postgres":{"id":"yckAFBLpmdhsPaDZ","name":"Postgres DF Assistant"}},"onError":"continueErrorOutput","parameters":
  {"operation":"select","schema":{"__rl":true,"value":"kg","mode":"list","cachedResultName":"kg"},"table":
  {"__rl":true,"value":"embedding_models","mode":"list","cachedResultName":"embedding_models"},"limit":1,"where":{"values":
  [{"column":"is_active","value":"={{ true }}"},{"column":"output_dim","value":"={{ 1536 }}"}]},"sort":{"values":[{"column":"id"}]},"options":
  {"alwaysOutputData":true}},"notes":"PURPOSE: pick active 1536 model. INPUT: none. OUTPUT: model id/key. WHY: aligns query vector with
  kg.chunk_embeddings_1536."},{"id":"n19","name":"RETRIEVE — Prepare OpenAI Request","type":"n8n-nodes-base.set","typeVersion":3.4,"position":
  [1200,420],"parameters":{"assignments":{"assignments":[{"id":"or1","name":"openai.body.model","value":"={{ $items("DB — Select Active Embedding Model")
  [0]?.json?.model_key || "text-embedding-3-small" }}","type":"string"},
  {"id":"or2","name":"openai.body.input","value":"={{ $json.query_text }}","type":"string"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: build embeddings
  request. INPUT: model key + query text. OUTPUT: openai.body.. WHY: dotNotation, no object literal payload."},{"id":"n20","name":"HTTP — Embed Query
  Text","type":"n8n-nodes-base.httpRequest","typeVersion":4.2,"position":[1420,420],"onError":"continueErrorOutput","credentials":{"openAiApi":
  {"id":"LB6ntiMR8lDYKSy4","name":"OpenAi account"}},"parameters":{"method":"POST","url":"https://api.openai.com/v1/
  embeddings","authentication":"predefinedCredentialType","nodeCredentialType":"openAiApi","sendBody":true,"specifyBody":"json","jsonBody":"={{ $json.openai.bod
  y }}","options":{"response":{"response":{"responseFormat":"json"}},"timeout":120000}},"notes":"PURPOSE: get query embedding. INPUT: openai.body. OUTPUT:
  data[0].embedding. WHY: vector leg of hybrid retrieval."},{"id":"n21","name":"RETRIEVE — Prepare Query Vector","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[1640,420],"parameters":{"assignments":{"assignments":[{"id":"qv1","name":"retrieval.model_id","value":"={{ $items("DB
  — Select Active Embedding Model")[0]?.json?.id || null }}","type":"number"},{"id":"qv2","name":"retrieval.query_embedding_str","value":"={{ "[" +
  (($json.data?.[0]?.embedding || []).join(",")) + "]" }}","type":"string"},{"id":"qv3","name":"retrieval.k_final","value":24,"type":"number"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: prepare vector params. INPUT: HTTP embedding + model lookup. OUTPUT: model_id/vector string/k. WHY: parameterized SQL
  inputs."},{"id":"n22","name":"DB — Retrieve Hybrid Candidates","type":"n8n-nodes-base.postgres","typeVersion":2.6,"position":[1860,420],"credentials":
  {"postgres":{"id":"yckAFBLpmdhsPaDZ","name":"Postgres DF Assistant"}},"onError":"continueErrorOutput","parameters":{"operation":"executeQuery","query":"WITH
  scoped AS (\n  SELECT c.id AS chunk_id, c.document_id, d.chat_id, d.dm_owner_user_id, c.text AS snippet, d.doc_type::text AS source_kind,
  d.message_version_id, d.file_unique_id, d.url_id\n  FROM kg.chunks c\n  JOIN content.documents d ON d.id = c.document_id\n  WHERE d.tenant_id = $1::uuid\n
  AND (\n      ( $2::boolean = true AND d.chat_id = $3::bigint AND $4::boolean = true )\n      OR\n      ( $2::boolean = false\n        AND (d.chat_id IS NULL
  OR d.chat_id = ANY($6::bigint[]))\n        AND ($5::boolean = true OR d.dm_owner_user_id IS NULL OR d.dm_owner_user_id = $7::bigint)\n      )\n    )\n),\nfts
  AS (\n  SELECT s., ts_rank_cd(to_tsvector('simple', COALESCE(s.snippet, '')), websearch_to_tsquery('simple', $8::text)) AS fts_score\n  FROM scoped s\n  WHERE
  to_tsvector('simple', COALESCE(s.snippet, '')) @@ websearch_to_tsquery('simple', $8::text)\n  ORDER BY fts_score DESC\n  LIMIT 40\n),\nvec AS (\n  SELECT s.,
  (1 - (e.embedding <=> $9::vector)) AS vec_score\n  FROM scoped s\n  JOIN kg.chunk_embeddings_1536 e ON e.chunk_id = s.chunk_id AND e.model_id =
  $10::smallint\n  ORDER BY e.embedding <=> $9::vector\n  LIMIT 40\n),\nunified AS (\n  SELECT\n    COALESCE(f.chunk_id, v.chunk_id) AS chunk_id,\n
  COALESCE(f.document_id, v.document_id) AS document_id,\n    COALESCE(f.chat_id, v.chat_id) AS chat_id,\n    COALESCE(f.source_kind, v.source_kind) AS
  source_kind,\n    COALESCE(f.message_version_id, v.message_version_id) AS message_version_id,\n    COALESCE(f.file_unique_id, v.file_unique_id) AS
  file_unique_id,\n    COALESCE(f.url_id, v.url_id) AS url_id,\n    COALESCE(f.snippet, v.snippet) AS snippet,\n    COALESCE(f.fts_score, 0) AS fts_score,\n
  COALESCE(v.vec_score, 0) AS vec_score,\n    (COALESCE(f.fts_score, 0) * 0.45 + COALESCE(v.vec_score, 0) * 0.55) AS score\n  FROM fts f\n  FULL OUTER JOIN vec
  v ON v.chunk_id = f.chunk_id\n)\nSELECT * FROM unified ORDER BY score DESC NULLS LAST LIMIT $11::int;","options":{"queryParameters":"={{ [$json.ctx.tenant_id,
  $json.access_scope.is_group_origin, $json.access_scope.origin_chat_id, $json.access_scope.group_member_exists, $json.access_scope.is_admin,
  $json.access_scope.allowed_chat_ids, $json.access_scope.actor_user_id, $json.query_text, $json.retrieval.query_embedding_str, $json.retrieval.model_id,
  $json.retrieval.k_final] }}","alwaysOutputData":true}},"notes":"PURPOSE: ACL-first hybrid retrieval. INPUT: tenant/scope/query/vector params. OUTPUT: ranked
  citation rows. WHY ADR: Execute Query required for pgvector + FTS + ACL joins; uses prepared query parameters only."},{"id":"n23","name":"RETRIEVE — Build
  Candidates","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,420],"parameters":{"assignments":{"assignments":
  [{"id":"bc1","name":"retrieval.candidates","value":"={{ $items("DB — Retrieve Hybrid Candidates").filter(i => i.json && i.json.chunk_id !== undefined).map(i
  => i.json) }}","type":"array"},{"id":"bc2","name":"retrieval.candidate_count","value":"={{ $items("DB — Retrieve Hybrid Candidates").filter(i => i.json &&
  i.json.chunk_id !== undefined).length }}","type":"number"},{"id":"bc3","name":"retrieval.note","value":"={{ $items("DB — Retrieve Hybrid Candidates").filter(i
  => i.json && i.json.chunk_id !== undefined).length > 0 ? "ok" : "no_candidates_in_scope" }}","type":"string"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: rows->array payload. INPUT: retrieval rows. OUTPUT: retrieval.candidates/count. WHY: WF51 expects explicit candidates
  array."},{"id":"n24","name":"Merge — Retrieval Candidates","type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[2300,520],"parameters":
  {"mode":"chooseBranch"},"notes":"PURPOSE: join retrieval branches. INPUT1 empty, INPUT2 hybrid. OUTPUT: one payload. WHY: branch join via Merge."},
  {"id":"n25","name":"CALL — Prepare WF51 Request","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2520,520],"parameters":{"assignments":
  {"assignments":[{"id":"p1","name":"ctx","value":"={{ $json.ctx }}","type":"object"},
  {"id":"p2","name":"query_text","value":"={{ $json.query_text }}","type":"string"},
  {"id":"p3","name":"access_scope","value":"={{ $json.access_scope }}","type":"object"},
  {"id":"p4","name":"retrieved_candidates","value":"={{ $json.retrieval.candidates }}","type":"array"},
  {"id":"p5","name":"origin_chat_id","value":"={{ $json.ctx.chat_id }}","type":"number"},
  {"id":"p6","name":"reply_to_message_id","value":"={{ $json.reply_to_message_id || null }}","type":"number"},
  {"id":"p7","name":"req","value":"={{ $json.req }}","type":"object"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: build WF51 payload. INPUT: ctx/query/
  scope/candidates. OUTPUT: top-level fields for WF51. WHY: WF51 does answer+citation+send."},{"id":"n26","name":"CALL — Execute WF51","type":"n8n-nodes-
  base.executeWorkflow","typeVersion":1.3,"position":[2740,520],"onError":"continueErrorOutput","parameters":{"workflowId":{"__rl":true,"value":"WF51 — Answerer
  (Mention/DM question → answer + citations)","mode":"list"},"workflowInputs":{"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":
  [],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":{"waitForSubWorkflow":true}},"notes":"PURPOSE: call WF51. INPUT: prepared fields.
  OUTPUT: answer outcome. WHY: separation of orchestration and answering."},{"id":"n27","name":"OUT — SuccessEnvelope","type":"n8n-nodes-
  base.set","typeVersion":3.4,"position":[2960,520],"parameters":{"assignments":{"assignments":[{"id":"so1","name":"ok","value":true,"type":"boolean"},
  {"id":"so2","name":"status_code","value":200,"type":"number"},{"id":"so3","name":"result.status","value":"={{ ($json.data?.citations?.length ||
  $json.retrieved_candidates?.length || 0) > 0 ? "ok" : "skipped" }}","type":"string"},{"id":"so4","name":"result.worker","value":"WF50","type":"string"},
  {"id":"so5","name":"result.job_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_id }}","type":"number"},
  {"id":"so6","name":"result.job_run_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_run_id || null }}","type":"number"},
  {"id":"so7","name":"result.correlation_id","value":"={{ $("CTX — Canonicalize").item.json.ctx.correlation_id }}","type":"string"},
  {"id":"so8","name":"result.data.answer_summary","value":"={{ $json.data?.answer_text || $json.answer_text || $json.data?.summary || null }}","type":"string"},
  {"id":"so9","name":"result.data.telegram_send","value":"={{ $json.data?.telegram_send || $json.telegram_send || null }}","type":"object"},
  {"id":"so10","name":"result.data.raw","value":"={{ $json.data || $json }}","type":"object"}]},"options":{"dotNotation":true}},"notes":"PURPOSE: return success
  envelope. INPUT: WF51 result. OUTPUT: ok=200 with worker/job/correlation/data. WHY: WF90 worker output contract."},{"id":"n28","name":"Merge — Final
  Output","type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[3380,360],"parameters":{"mode":"chooseBranch"},"notes":"PURPOSE: single terminal item.
  INPUT1 managed failures, INPUT2 success. OUTPUT: one envelope. WHY: avoid duplicate terminal outputs."},{"id":"n29","name":"ERR — Source I/O","type":"n8n-
  nodes-base.set","typeVersion":3.4,"position":[1420,860],"parameters":{"assignments":{"assignments":
  [{"id":"er1","name":"_err.node","value":"={{ $json.n8nDetails?.nodeName || $json.error?.node?.name || "WF50 I/O" }}","type":"string"},
  {"id":"er2","name":"_err.operation","value":"={{ $json._err?.operation || "io" }}","type":"string"},
  {"id":"er3","name":"_err.table","value":"={{ $json._err?.table || "unknown" }}","type":"string"},{"id":"er4","name":"_err.kind","value":"io","type":"string"},
  {"id":"er5","name":"_err.message","value":"={{ $json.error?.message || $json.message || "WF50 I/O failure" }}","type":"string"},
  {"id":"er6","name":"_err.status_code","value":"={{ Number($json.statusCode || $json.httpCode || 500) }}","type":"number"},
  {"id":"er7","name":"_err.retryable","value":"={{ Number($json.statusCode || $json.httpCode || 500) >= 500 || Number($json.statusCode || $json.httpCode || 500)
  === 429 }}","type":"boolean"},{"id":"er8","name":"_ctx","value":"={{ $json.ctx || $("CTX — Canonicalize").item.json.ctx || $("Set — Normalize
  Input").item.json.req.ctx }}","type":"object"},{"id":"er9","name":"req","value":"={{ $json.req || $("Set — Normalize
  Input").item.json.req }}","type":"object"}]},"includeOtherFields":true,"options":{"dotNotation":true}},"notes":"PURPOSE: mark error source. INPUT: any I/O/
  execute error output. OUTPUT: _err + _ctx for ErrorPipe. WHY: one local managed error branch for all I/O nodes."},{"id":"n30","name":"ERR — Prepare ErrorPipe
  v1","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1640,860],"parameters":{"assignments":{"assignments":
  [{"id":"ep1","name":"ctx","value":"={{ $json._ctx || $json.ctx }}","type":"object"},{"id":"ep2","name":"ctx.contracts.errorpipe","value":1,"type":"number"},
  {"id":"ep3","name":"error_context.kind","value":"={{ $json._err?.kind || "io" }}","type":"string"},
  {"id":"ep4","name":"error_context.error_message","value":"={{ $json._err?.message || $json.error?.message || "WF50 failure" }}","type":"string"},
  {"id":"ep5","name":"error_context.status_code","value":"={{ Number($json._err?.status_code || 500) }}","type":"number"},
  {"id":"ep6","name":"error_context.retryable","value":"={{ $json._err?.retryable === true }}","type":"boolean"},
  {"id":"ep7","name":"error_context.node","value":"={{ $json._err?.node || null }}","type":"string"},
  {"id":"ep8","name":"error_context.operation","value":"={{ $json._err?.operation || null }}","type":"string"},
  {"id":"ep9","name":"error_context.table","value":"={{ $json._err?.table || null }}","type":"string"},
  {"id":"ep10","name":"error_context.ctx","value":"={{ $json._ctx || $json.ctx }}","type":"object"},
  {"id":"ep11","name":"req","value":"={{ $json.req }}","type":"object"}]},"includeOtherFields":true,"options":{"dotNotation":true}},"notes":"PURPOSE: canonical
  ErrorPipe payload. INPUT: ERR source item. OUTPUT: ctx + error_context for WF99. WHY: WF99 is canonical logger/enveloper."},{"id":"n31","name":"ERR — Execute
  WF99","type":"n8n-nodes-base.executeWorkflow","typeVersion":1.3,"position":[1860,860],"onError":"continueErrorOutput","parameters":{"workflowId":
  {"__rl":true,"value":"WF99 — Global ERR Handler","mode":"list","cachedResultName":"WF99 — Global ERR Handler"},"workflowInputs":
  {"mappingMode":"defineBelow","value":{},"matchingColumns":[],"schema":[],"attemptToConvertTypes":false,"convertFieldsToString":true},"options":
  {"waitForSubWorkflow":true}},"notes":"PURPOSE: call WF99 for managed errors. INPUT: ErrorPipe v1 item. OUTPUT: ErrorEnvelope. WHY: central logging +
  normalization."},{"id":"n32","name":"OUT — ManagedFailure (via WF99)","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,820],"parameters":
  {"assignments":{"assignments":[{"id":"mf1","name":"ok","value":false,"type":"boolean"},{"id":"mf2","name":"status_code","value":"={{ $json.status_code ||
  500 }}","type":"number"},{"id":"mf3","name":"error.type","value":"={{ $json.error?.kind || "worker_failure" }}","type":"string"},
  {"id":"mf4","name":"error.message","value":"={{ $json.error?.message || "WF50 managed failure" }}","type":"string"},
  {"id":"mf5","name":"error.retryable","value":"={{ $json.error?.retryable === true }}","type":"boolean"},
  {"id":"mf6","name":"error.details.ctx","value":"={{ $json.error?.details?.ctx || $("Set — Normalize Input").item.json.req.ctx }}","type":"object"},
  {"id":"mf7","name":"error.details.error_context","value":"={{ $json.error?.details?.error_context }}","type":"object"},
  {"id":"mf8","name":"error.details.raw_error","value":"={{ $json.error?.details?.raw_error }}","type":"object"},
  {"id":"mf9","name":"ctx.correlation_id","value":"={{ $json.error?.details?.ctx?.correlation_id || $("Set — Normalize
  Input").item.json.req.ctx.correlation_id }}","type":"string"},{"id":"mf10","name":"ctx.tenant_id","value":"={{ $json.error?.details?.ctx?.tenant_id || $("Set
  — Normalize Input").item.json.req.ctx.tenant_id }}","type":"string"},{"id":"mf11","name":"ctx.bot_id","value":"={{ $json.error?.details?.ctx?.bot_id || $("Set
  — Normalize Input").item.json.req.ctx.bot_id || $("Set — Normalize Input").item.json.req.job.payload.bot_id || null }}","type":"string"},
  {"id":"mf12","name":"ctx.chat_id","value":"={{ $("Set — Normalize Input").item.json.req.job.payload.chat_id || null }}","type":"number"},
  {"id":"mf13","name":"ctx.actor_user_id","value":"={{ $("Set — Normalize Input").item.json.req.job.payload.actor_user_id || null }}","type":"number"},
  {"id":"mf14","name":"ctx.job_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_id || null }}","type":"number"},
  {"id":"mf15","name":"ctx.job_run_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_run_id || null }}","type":"number"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: map WF99 result to worker failure format. INPUT: WF99 envelope. OUTPUT: managed failure for WF90. WHY: no StopAndError
  after WF99."},{"id":"n33","name":"OUT — ManagedFailure WF99 Call Failed","type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2080,940],"parameters":
  {"assignments":{"assignments":[{"id":"ff1","name":"ok","value":false,"type":"boolean"},{"id":"ff2","name":"status_code","value":500,"type":"number"},
  {"id":"ff3","name":"error.type","value":"wf99_call_failed","type":"string"},{"id":"ff4","name":"error.message","value":"WF50 failed to call
  WF99","type":"string"},{"id":"ff5","name":"error.retryable","value":true,"type":"boolean"},
  {"id":"ff6","name":"error.details.reason","value":"errorpipe_escalation_failed","type":"string"},{"id":"ff7","name":"ctx.correlation_id","value":"={{ $("Set —
  Normalize Input").item.json.req.ctx.correlation_id || null }}","type":"string"},{"id":"ff8","name":"ctx.tenant_id","value":"={{ $("Set — Normalize
  Input").item.json.req.ctx.tenant_id || null }}","type":"string"},{"id":"ff9","name":"ctx.bot_id","value":"={{ $("Set — Normalize
  Input").item.json.req.ctx.bot_id || $("Set — Normalize Input").item.json.req.job.payload.bot_id || null }}","type":"string"},
  {"id":"ff10","name":"ctx.chat_id","value":"={{ $("Set — Normalize Input").item.json.req.job.payload.chat_id || null }}","type":"number"},
  {"id":"ff11","name":"ctx.actor_user_id","value":"={{ $("Set — Normalize Input").item.json.req.job.payload.actor_user_id || null }}","type":"number"},
  {"id":"ff12","name":"ctx.job_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_id || null }}","type":"number"},
  {"id":"ff13","name":"ctx.job_run_id","value":"={{ $("Set — Normalize Input").item.json.req.job.job_run_id || null }}","type":"number"}]},"options":
  {"dotNotation":true}},"notes":"PURPOSE: fallback failure if WF99 call errors. INPUT: WF99 error output. OUTPUT: managed 500. WHY: keep worker non-
  throwing."}],"connections":{"IN — Execute Workflow Trigger":{"main":[[{"node":"Set — Normalize Input","type":"main","index":0}]]},"Set — Normalize Input":
  {"main":[[{"node":"GUARD — Validate Input","type":"main","index":0}]]},"GUARD — Validate Input":{"main":[[{"node":"CTX — Prepare WF00c
  Request","type":"main","index":0}],[{"node":"OUT — ManagedFailure Validation","type":"main","index":0}]]},"OUT — ManagedFailure Validation":{"main":
  [[{"node":"Merge — Final Output","type":"main","index":0}]]},"CTX — Prepare WF00c Request":{"main":[[{"node":"CTX — Execute
  WF00c","type":"main","index":0}]]},"CTX — Execute WF00c":{"main":[[{"node":"CTX — Canonicalize","type":"main","index":0}],[{"node":"ERR — Source I/
  O","type":"main","index":0}]]},"CTX — Canonicalize":{"main":[[{"node":"ACL — Guard Context Allowed","type":"main","index":0}]]},"ACL — Guard Context Allowed":
  {"main":[[{"node":"DB — Verify Group Membership Current","type":"main","index":0}],[{"node":"OUT — ManagedFailure ACL","type":"main","index":0}]]},"OUT —
  ManagedFailure ACL":{"main":[[{"node":"Merge — Final Output","type":"main","index":0}]]},"DB — Verify Group Membership Current":{"main":[[{"node":"DB — Select
  Actor Membership Chats","type":"main","index":0}],[{"node":"ERR — Source I/O","type":"main","index":0}]]},"DB — Select Actor Membership Chats":{"main":
  [[{"node":"DB — Select Tenant Enabled Chats","type":"main","index":0}],[{"node":"ERR — Source I/O","type":"main","index":0}]]},"DB — Select Tenant Enabled
  Chats":{"main":[[{"node":"ACL — Build AccessScope","type":"main","index":0}],[{"node":"ERR — Source I/O","type":"main","index":0}]]},"ACL — Build
  AccessScope":{"main":[[{"node":"ACL — Guard Scope Allowed","type":"main","index":0}]]},"ACL — Guard Scope Allowed":{"main":[[{"node":"RETRIEVE — Embedding
  Allowed?","type":"main","index":0}],[{"node":"OUT — ManagedFailure Scope","type":"main","index":0}]]},"OUT — ManagedFailure Scope":{"main":[[{"node":"Merge —
  Final Output","type":"main","index":0}]]},"RETRIEVE — Embedding Allowed?":{"main":[[{"node":"DB — Select Active Embedding Model","type":"main","index":0}],
  [{"node":"RETRIEVE — Empty Candidates","type":"main","index":0}]]},"RETRIEVE — Empty Candidates":{"main":[[{"node":"Merge — Retrieval
  Candidates","type":"main","index":0}]]},"DB — Select Active Embedding Model":{"main":[[{"node":"RETRIEVE — Prepare OpenAI Request","type":"main","index":0}],
  [{"node":"ERR — Source I/O","type":"main","index":0}]]},"RETRIEVE — Prepare OpenAI Request":{"main":[[{"node":"HTTP — Embed Query
  Text","type":"main","index":0}]]},"HTTP — Embed Query Text":{"main":[[{"node":"RETRIEVE — Prepare Query Vector","type":"main","index":0}],[{"node":"ERR —
  Source I/O","type":"main","index":0}]]},"RETRIEVE — Prepare Query Vector":{"main":[[{"node":"DB — Retrieve Hybrid Candidates","type":"main","index":0}]]},"DB
  — Retrieve Hybrid Candidates":{"main":[[{"node":"RETRIEVE — Build Candidates","type":"main","index":0}],[{"node":"ERR — Source I/
  O","type":"main","index":0}]]},"RETRIEVE — Build Candidates":{"main":[[{"node":"Merge — Retrieval Candidates","type":"main","index":1}]]},"Merge — Retrieval
  Candidates":{"main":[[{"node":"CALL — Prepare WF51 Request","type":"main","index":0}]]},"CALL — Prepare WF51 Request":{"main":[[{"node":"CALL — Execute
  WF51","type":"main","index":0}]]},"CALL — Execute WF51":{"main":[[{"node":"OUT — SuccessEnvelope","type":"main","index":0}],[{"node":"ERR — Source I/
  O","type":"main","index":0}]]},"OUT — SuccessEnvelope":{"main":[[{"node":"Merge — Final Output","type":"main","index":1}]]},"ERR — Source I/O":{"main":
  [[{"node":"ERR — Prepare ErrorPipe v1","type":"main","index":0}]]},"ERR — Prepare ErrorPipe v1":{"main":[[{"node":"ERR — Execute
  WF99","type":"main","index":0}]]},"ERR — Execute WF99":{"main":[[{"node":"OUT — ManagedFailure (via WF99)","type":"main","index":0}],[{"node":"OUT —
  ManagedFailure WF99 Call Failed","type":"main","index":0}]]},"OUT — ManagedFailure (via WF99)":{"main":[[{"node":"Merge — Final
  Output","type":"main","index":0}]]},"OUT — ManagedFailure WF99 Call Failed":{"main":[[{"node":"Merge — Final Output","type":"main","index":0}]]}},"pinData":
  {},"active":false,"settings":
  {"executionOrder":"v1","availableInMCP":false,"timeSavedMode":"fixed","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"VykeJY27VNJD_xWfy5Nx6","binaryM
  ode":"separate"},"versionId":"6fb03ec8-b42f-4a1e-9a59-f90e2c560c6f"}