{
  "name": "WF20 — Update Processor (Normalize & Persist)",
  "nodes": [
    {
      "parameters": {
        "fieldToSplitOut": "_attachments.urls",
        "include": "allOtherFields",
        "options": {
          "destinationFieldName": "_url_obj"
        }
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -25392,
        3312
      ],
      "id": "c92a5250-8f1c-48f6-9a3b-8773f05cbc49",
      "name": "Item Lists — Split URLs",
      "notes": "Split _attachments.urls array into per-URL items.\nInput: Item with _attachments.urls array.\nOutput: One item per URL with _url_obj containing url and source.\nWHY: Need per-URL items for content.urls upsert and fetch_url job creation."
    },
    {
      "parameters": {
        "fieldToSplitOut": "_attachments.files",
        "include": "allOtherFields",
        "options": {
          "destinationFieldName": "_file"
        }
      },
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3.1,
      "position": [
        -25392,
        2832
      ],
      "id": "53848864-969c-4277-a2f7-2f2530bfc726",
      "name": "Item Lists — Split Files",
      "notes": "Split _attachments.files array into per-file items.\nInput: Item with _attachments.files array.\nOutput: One item per file with _file object containing file_id, file_unique_id, type, payload etc.\nWHY: Need per-file items for tg.files upsert, tg.file_instances upsert, message_attachments insert, and job creation."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "files-count",
              "name": "_attachments.files_count",
              "value": "={{ $json._attachments.files.length }}",
              "type": "number"
            },
            {
              "id": "urls-arr",
              "name": "_attachments.urls",
              "value": "={{ $json._parsed.discovered_urls || [] }}",
              "type": "array"
            },
            {
              "id": "urls-count",
              "name": "_attachments.urls_count",
              "value": "={{ ($json._parsed.discovered_urls || []).length }}",
              "type": "number"
            },
            {
              "id": "has-media",
              "name": "_parsed.has_media",
              "value": "={{ ($json._attachments.files || []).length > 0 }}",
              "type": "boolean"
            },
            {
              "id": "has-links",
              "name": "_parsed.has_links",
              "value": "={{ ($json._parsed.discovered_urls || []).length > 0 }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "d912e23f-4978-4afd-99f8-0d5b65cb7941",
      "name": "Set — Attachment Counts & URLs",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27616,
        3184
      ],
      "notes": "Compute attachment counts and boolean flags.\nInput: _attachments.files array, _parsed.discovered_urls.\nOutput: _attachments.files_count, urls array/count, _parsed.has_media, _parsed.has_links.\nWHY: tg.message_versions needs has_media/has_links booleans. Counts used for fan-out decisions."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "files",
              "name": "_attachments.files",
              "value": "={{\n                    (() => {\n                        const files = [];\n                        const p = $json._parsed;\n                        \n                        // Helper to add file\n                        const addFile = (type, obj) => {\n                            if (!obj) return;\n                            files.push({\n                                type: type,\n                                file_id: obj.file_id,\n                                file_unique_id: obj.file_unique_id,\n                                mime_type: obj.mime_type || null,\n                                file_name: obj.file_name || null,\n                                file_size: obj.file_size || null,\n                                width: obj.width || null,\n                                height: obj.height || null,\n                                duration: obj.duration || null,\n                                payload: obj\n                            });\n                        };\n                        \n                        // Add each type\n                        addFile('document', p.document);\n                        addFile('video', p.video);\n                        addFile('audio', p.audio);\n                        addFile('voice', p.voice);\n                        addFile('animation', p.animation);\n                        addFile('sticker', p.sticker);\n                        \n                        // Photo: take largest\n                        if (p.photo && Array.isArray(p.photo) && p.photo.length > 0) {\n                            const largest = p.photo.reduce((a, b) => (b.file_size > a.file_size ? b : a));\n                            addFile('photo', {...largest, mime_type: 'image/jpeg'});\n                        }\n                        \n                        return files;\n                    })()\n                }}",
              "type": "array"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "f5e3ac32-f33f-4b56-834b-56d90e48310e",
      "name": "Set — Build Files Array",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27600,
        2944
      ],
      "notes": "Build _attachments.files array from parsed attachment objects (document, video, audio, voice, animation, sticker, photo)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "urls",
              "name": "_parsed.discovered_urls",
              "value": "={{\n                    (() => {\n                        const entities = ($json._parsed.entities || []).concat($json._parsed.caption_entities || []);\n                        const text = $json._parsed.text || $json._parsed.caption || '';\n                        const urls = [];\n                        const seen = new Set();\n                        \n                        for (const e of entities) {\n                            let url = null;\n                            if (e.type === 'text_link' && e.url) {\n                                url = e.url;\n                            } else if (e.type === 'url' && e.offset != null && e.length != null) {\n                                url = text.substring(e.offset, e.offset + e.length);\n                            }\n                            if (url && !seen.has(url)) {\n                                seen.add(url);\n                                urls.push({url: url, source: 'entity'});\n                            }\n                        }\n                        \n                        return urls;\n                    })()\n                }}",
              "type": "array"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "9e16b33b-8dd1-466e-bb37-40cc94d1d8de",
      "name": "Set — Extract URLs from Entities",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31504,
        4464
      ],
      "notes": "Extract URLs from text_link and url entities, deduplicate"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "membership",
              "name": "_parsed.membership_update",
              "value": "={{ $json.req.update.my_chat_member || $json.req.update.chat_member || null }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "ff125286-29f5-46a0-811b-792fb3e4c4c0",
      "name": "Set — Extract Membership",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31728,
        4944
      ],
      "notes": "Extract membership_update for my_chat_member or chat_member updates"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "doc",
              "name": "_parsed.document",
              "value": "={{ $json._msg?.document || null }}",
              "type": "object"
            },
            {
              "id": "photo",
              "name": "_parsed.photo",
              "value": "={{ $json._msg?.photo || null }}",
              "type": "array"
            },
            {
              "id": "video",
              "name": "_parsed.video",
              "value": "={{ $json._msg?.video || null }}",
              "type": "object"
            },
            {
              "id": "audio",
              "name": "_parsed.audio",
              "value": "={{ $json._msg?.audio || null }}",
              "type": "object"
            },
            {
              "id": "voice",
              "name": "_parsed.voice",
              "value": "={{ $json._msg?.voice || null }}",
              "type": "object"
            },
            {
              "id": "anim",
              "name": "_parsed.animation",
              "value": "={{ $json._msg?.animation || null }}",
              "type": "object"
            },
            {
              "id": "sticker",
              "name": "_parsed.sticker",
              "value": "={{ $json._msg?.sticker || null }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "b2c0f56d-f5a2-4d25-8500-25c058e97573",
      "name": "Set — Extract Attachments",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31920,
        4944
      ],
      "notes": "Extract file attachments: document, photo, video, audio, voice, animation, sticker"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "date",
              "name": "_parsed.date",
              "value": "={{ $json._msg?.date || null }}",
              "type": "number"
            },
            {
              "id": "edit-date",
              "name": "_parsed.edit_date",
              "value": "={{ $json._msg?.edit_date || null }}",
              "type": "number"
            },
            {
              "id": "via-bot",
              "name": "_parsed.via_bot",
              "value": "={{ $json._msg?.via_bot || null }}",
              "type": "object"
            },
            {
              "id": "reply-to",
              "name": "_parsed.reply_to_message_id",
              "value": "={{ $json._msg?.reply_to_message?.message_id || null }}",
              "type": "number"
            },
            {
              "id": "fwd-from",
              "name": "_parsed.forward_from",
              "value": "={{ $json._msg?.forward_from || null }}",
              "type": "object"
            },
            {
              "id": "fwd-chat",
              "name": "_parsed.forward_from_chat",
              "value": "={{ $json._msg?.forward_from_chat || null }}",
              "type": "object"
            },
            {
              "id": "fwd-date",
              "name": "_parsed.forward_date",
              "value": "={{ $json._msg?.forward_date || null }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "fdf9d357-463d-480d-ae4e-502c91e7d681",
      "name": "Set — Extract Dates & Reply",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31792,
        4672
      ],
      "notes": "Extract date, edit_date, reply_to, forward_*"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "from-user",
              "name": "_parsed.from_user",
              "value": "={{ $json._msg?.from || null }}",
              "type": "object"
            },
            {
              "id": "sender-chat",
              "name": "_parsed.sender_chat",
              "value": "={{ $json._msg?.sender_chat || null }}",
              "type": "object"
            },
            {
              "id": "text",
              "name": "_parsed.text",
              "value": "={{ $json._msg?.text || null }}",
              "type": "string"
            },
            {
              "id": "caption",
              "name": "_parsed.caption",
              "value": "={{ $json._msg?.caption || null }}",
              "type": "string"
            },
            {
              "id": "entities",
              "name": "_parsed.entities",
              "value": "={{ $json._msg?.entities || null }}",
              "type": "array"
            },
            {
              "id": "caption-ent",
              "name": "_parsed.caption_entities",
              "value": "={{ $json._msg?.caption_entities || null }}",
              "type": "array"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "ea0ab64c-826f-467b-b032-1265634aa296",
      "name": "Set — Extract User & Content",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31824,
        4464
      ],
      "notes": "Extract from_user, sender_chat, text, caption, entities"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chat-id",
              "name": "_parsed.chat_id",
              "value": "={{ $json._msg?.chat?.id || null }}",
              "type": "number"
            },
            {
              "id": "chat-type",
              "name": "_parsed.chat_type",
              "value": "={{ $json._msg?.chat?.type || null }}",
              "type": "string"
            },
            {
              "id": "msg-id",
              "name": "_parsed.message_id",
              "value": "={{ $json._msg?.message_id || null }}",
              "type": "number"
            },
            {
              "id": "thread-id",
              "name": "_parsed.message_thread_id",
              "value": "={{ $json._msg?.message_thread_id || null }}",
              "type": "number"
            },
            {
              "id": "is-topic",
              "name": "_parsed.is_topic_message",
              "value": "={{ $json._msg?.is_topic_message || false }}",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "eb63d115-1584-4a2f-93c9-d8ce6edd380a",
      "name": "Set — Extract Chat Fields",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31840,
        4240
      ],
      "notes": "Extract chat, message ID fields"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "kind",
              "name": "_parsed.update_kind",
              "value": "={{ \n                        $json.req.update.message ? 'message' :\n                        $json.req.update.edited_message ? 'edited_message' :\n                        $json.req.update.channel_post ? 'channel_post' :\n                        $json.req.update.edited_channel_post ? 'edited_channel_post' :\n                        $json.req.update.my_chat_member ? 'my_chat_member' :\n                        $json.req.update.chat_member ? 'chat_member' :\n                        'other'\n                    }}",
              "type": "string"
            },
            {
              "id": "msg-ref",
              "name": "_msg",
              "value": "={{\n                        $json.req.update.message || \n                        $json.req.update.edited_message || \n                        $json.req.update.channel_post || \n                        $json.req.update.edited_channel_post ||\n                        null\n                    }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "da25026d-1450-42e8-91e8-1a7b4fd0813c",
      "name": "Set — Determine update_kind",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31840,
        4000
      ],
      "notes": "Determine update_kind and extract message-like object (_msg)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Load raw.telegram_updates",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "raw.telegram_updates",
              "type": "string"
            },
            {
              "id": "ctx",
              "name": "ctx",
              "value": "={{ $json._ctx }}",
              "type": "object"
            },
            {
              "id": "ec-node",
              "name": "error_context.node",
              "value": "PG — Load raw.telegram_updates",
              "type": "string"
            },
            {
              "id": "ec-op",
              "name": "error_context.operation",
              "value": "select_not_found",
              "type": "string"
            },
            {
              "id": "ec-table",
              "name": "error_context.table",
              "value": "raw.telegram_updates",
              "type": "string"
            },
            {
              "id": "ec-corr",
              "name": "error_context.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "ec-msg",
              "name": "error_context.error_message",
              "value": "Raw update not found by bot_id+update_id+received_at",
              "type": "string"
            },
            {
              "id": "ec-status",
              "name": "error_context.status_code",
              "value": "=404",
              "type": "number"
            },
            {
              "id": "ec-retry",
              "name": "error_context.retryable",
              "value": "=false",
              "type": "boolean"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "deee6246-be6c-4b02-a549-9b73f67e8e23",
      "name": "Set — Error: Raw Update Not Found",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31952,
        5552
      ],
      "notes": "Prepare non-retryable error when raw update not found.\nInput: Base item with _ctx.\nOutput: Error context for WF99.\nWHY: Missing raw update means data was deleted or pointer is wrong — not retryable."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "set-update",
              "name": "req.update",
              "value": "={{ $items(\"PG — Load raw.telegram_updates\")[0].json.body }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "ba8f956b-4a64-4219-8f10-144f7e32013c",
      "name": "Set — req.update from DB",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -32320,
        4048
      ],
      "notes": "Assign loaded body (JSONB) to req.update"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cond-raw-found",
              "leftValue": "={{ $items(\"PG — Load raw.telegram_updates\").length > 0 }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "40e7dbd6-6ce8-4692-b04e-53799247ea66",
      "name": "IF — Raw Update Found",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -32544,
        4192
      ],
      "notes": "Check if raw update was found in DB.\nInput: Appended items (base + optional raw row).\nOutput True: Raw row with body → extract update.\nOutput False: Base item without body → error path.\nWHY: If raw.telegram_updates row not found, must route to WF99 as non-retryable error."
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "raw",
          "mode": "list"
        },
        "table": {
          "__rl": true,
          "value": "telegram_updates",
          "mode": "list"
        },
        "where": {
          "values": [
            {
              "column": "bot_id",
              "value": "={{ $json._raw_lookup.bot_id }}"
            },
            {
              "column": "update_id",
              "value": "={{ $json._raw_lookup.update_id }}"
            },
            {
              "column": "received_at",
              "value": "={{ $json._raw_lookup.received_at }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e16aec75-bb42-4569-955b-146037b44e1b",
      "name": "PG — Load raw.telegram_updates",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -32928,
        4128
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Load raw Telegram update by bot_id+update_id+received_at.\nInput: _raw_lookup fields.\nOutput: Raw row or 0 items if not found.\nWHY: Source data for normalization.\nNOTE: onError=continueErrorOutput for ErrorPipe v1."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "payload-parsed",
              "name": "_payload",
              "value": "={{ $json.req.job.payload }}",
              "type": "object"
            },
            {
              "id": "bot-id-key",
              "name": "_raw_lookup.bot_id",
              "value": "={{ $json.req.job.payload.bot_id }}",
              "type": "string"
            },
            {
              "id": "update-id-key",
              "name": "_raw_lookup.update_id",
              "value": "={{ $json.req.job.payload.update_id }}",
              "type": "number"
            },
            {
              "id": "received-at-key",
              "name": "_raw_lookup.received_at",
              "value": "={{ $json.req.job.payload.received_at }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "2efc8dbc-ac28-45c6-9b3d-df782a6740f5",
      "name": "Set — Parse job.payload",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33168,
        4000
      ],
      "notes": "Parse job.payload from WF90 input.\nInput: req.job.payload with bot_id, update_id, received_at.\nOutput: _payload object and _raw_lookup fields.\nWHY: Needed to query raw.telegram_updates."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "files",
          "mode": "list",
          "cachedResultName": "files"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "file_unique_id": "={{ $json._file.file_unique_id }}",
            "mime_type": "={{ $json._file.mime_type }}",
            "file_name": "={{ $json._file.file_name }}",
            "file_size": "={{ $json._file.file_size }}",
            "file_type": "={{ $json._file.type }}"
          },
          "matchingColumns": [
            "file_unique_id"
          ],
          "schema": [
            {
              "id": "file_unique_id",
              "displayName": "file_unique_id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mime_type",
              "displayName": "mime_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string"
            },
            {
              "id": "file_name",
              "displayName": "file_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string"
            },
            {
              "id": "file_size",
              "displayName": "file_size",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number"
            },
            {
              "id": "file_type",
              "displayName": "file_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            }
          ]
        },
        "options": {
          "replaceEmptyStrings": true
        }
      },
      "id": "b9520651-e7f2-44cb-a3a2-ca807b13370f",
      "name": "PG — Upsert tg.files",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -24848,
        2656
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert file metadata into tg.files by file_unique_id.\nInput: _file object with file_unique_id, file_type, mime_type, file_name, file_size.\nOutput: Upserted row.\nWHY: Deduplicate files by file_unique_id. file_type needed for classification."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a2a644cd-eeba-4272-8a02-3a5a36c3bdb4",
              "name": "_content_sha256",
              "value": "={{ '\\\\x' + $json._hash_hex }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "8b7df749-339a-4929-a8a8-eb21017a5a76",
      "name": "Set — Format Content Hash",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28016,
        3200
      ],
      "notes": "Format hash as PostgreSQL bytea.\nInput: _hash_hex from Crypto node.\nOutput: _content_sha256 = '\\x' + hex_hash.\nWHY: PostgreSQL bytea column needs \\x prefix."
    },
    {
      "parameters": {
        "type": "SHA256",
        "value": "={{ JSON.stringify({ text: String($json._parsed?.text || ''), caption: String($json._parsed?.caption || ''), entities: $json._parsed?.entities || null, caption_entities: $json._parsed?.caption_entities || null }) }}",
        "dataPropertyName": "_hash_hex"
      },
      "id": "2158991a-b92c-4193-98b4-cd5dc98a3511",
      "name": "Crypto — SHA256 Content",
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        -28224,
        3168
      ],
      "notes": "Compute SHA256 hash of message content.\nInput: Item with _parsed.text, _parsed.caption, _parsed.entities, _parsed.caption_entities.\nOutput: Adds _hash_hex field with hex-encoded hash.\nWHY: content_sha256 column for deduplication."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "5c5aee84-b918-4d74-b6d6-e7815e33e8b1",
      "name": "Merge — Restore After Upsert tg.chat_memberships_current",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -29328,
        4544
      ],
      "notes": "Restore context after PG — Upsert tg.chat_memberships_current.\nWHY: Need _ctx, _parsed for SuccessEnvelope."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "54f0fbd8-2978-408d-bd4c-314c46815fff",
              "name": "db.membership",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "f6cd81f7-1547-4726-812d-cb1fc3b1a37a",
      "name": "Set — Wrap Upsert tg.chat_memberships_current",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -29680,
        4336
      ],
      "notes": "Wrap PG result into db.membership.\nWHY: Preserve _ctx/_parsed/membership_* context."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "a997c1a4-e36e-4433-a194-c483ff76e299",
      "name": "Merge — Restore After Insert tg.chat_member_events",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -30240,
        4512
      ],
      "notes": "Restore context after PG — Insert tg.chat_member_events.\nWHY: Need _ctx, _parsed for SuccessEnvelope."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9b487f58-fc92-437f-a780-6f44b2c2cf9e",
              "name": "db.member_event",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "c9c9b50b-0330-44c8-a390-f3dcabc5019b",
      "name": "Set — Wrap Insert tg.chat_member_events",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30448,
        4192
      ],
      "notes": "Wrap PG result into db.member_event.\nWHY: Preserve _ctx/_parsed/membership_* context."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "d8fb0e1e-d6e3-418d-9b2f-45ddb7c287a7",
      "name": "Merge — Restore After Upsert tg.file_instances",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -23488,
        2816
      ],
      "notes": "Restore context after PG — Upsert tg.file_instances.\nWHY: Need _file, _ctx for downstream operations."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "17d21812-2d27-4a1d-89be-a74b516fe613",
              "name": "db.file_instance",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "cd8868b8-0231-494f-962f-53c258511d77",
      "name": "Set — Wrap Upsert tg.file_instances",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23760,
        2688
      ],
      "notes": "Wrap PG result into db.file_instance.\nWHY: Preserve _file/_ctx context."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "6bf31c70-4052-46dc-b880-4ef14811fea2",
      "name": "Merge — Restore After Upsert tg.files",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -24240,
        2832
      ],
      "notes": "Restore context after PG — Upsert tg.files.\nWHY: Need _file, _ctx for downstream operations."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c5fcb05b-8946-45a8-953a-5cd1f85eaea5",
              "name": "db.file",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "3fc17459-8800-4142-94c2-8ecaf951a57d",
      "name": "Set — Wrap Upsert tg.files",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -24560,
        2656
      ],
      "notes": "Wrap PG result into db.file.\nWHY: Preserve _file/_ctx context."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "30f61c22-91d6-4635-ac81-9eae28448d2f",
      "name": "Merge — Restore After Upsert URLs",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -24176,
        3312
      ],
      "notes": "Restore working item after URL upsert.\nWHY: Need _ctx, _url, _message_fk, _version_id for job creation."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b478f005-8c2c-455e-aae9-f74247dce197",
              "name": "db.url",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "1ab8af4e-299e-4674-a664-5a57924111d6",
      "name": "Set — Wrap Upsert content.urls",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -24496,
        3472
      ],
      "notes": "Wrap PG result into db.url namespace.\nWHY: Preserve _ctx/_url/_message_fk/_version_id after URL upsert."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "bb502653-294b-428b-b18b-f08bab288857",
      "name": "Merge — Restore After Update messages.current_version_id",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -26144,
        3104
      ],
      "notes": "Restore working item after PG — Update messages.current_version_id.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.update_result).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a8480dde-a675-421e-b3e3-46e89811c887",
              "name": "db.update_result",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "f9910d29-1aea-45f4-a005-5643da8d1fab",
      "name": "Set — Wrap Update messages.current_version_id",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -26448,
        2960
      ],
      "notes": "Wrap PG result into db.update_result namespace.\nInput: PG result.\nOutput: { db.update_result: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "3071c736-40d8-4496-90eb-5bdaa808933d",
      "name": "Merge — Restore After Insert tg.message_versions",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -27056,
        3040
      ],
      "notes": "Restore working item after PG — Insert tg.message_versions.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.version).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "wrap-ver",
              "name": "db.version",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "5d1a8b65-aa56-429f-be43-cf47be8aa1ff",
      "name": "Set — Wrap Insert tg.message_versions",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27200,
        3200
      ],
      "notes": "Wrap PG result into db.version namespace.\nInput: PG result.\nOutput: { db.version: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "04d927b0-5dc7-4561-8b90-3b9f501d6e98",
      "name": "Merge — Restore After Select Max Version",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -28704,
        2928
      ],
      "notes": "Restore working item after PG — Select Max Version.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.max_version).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4189566b-29a3-48b1-8002-a3ab2c58edeb",
              "name": "db.max_version",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "b9a72297-7e1b-4a4c-ae5a-be2453c2c2bc",
      "name": "Set — Wrap Select Max Version",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28800,
        3104
      ],
      "notes": "Wrap PG result into db.max_version namespace.\nInput: PG result.\nOutput: { db.max_version: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "e7572b60-de24-4eec-921f-e21196adfe0c",
      "name": "Merge — Restore After Insert tg.messages",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -28528,
        3312
      ],
      "notes": "Restore working item after PG — Insert tg.messages.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.new_message).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "72bd2133-9cac-4527-9e1e-53b97813e6dc",
              "name": "db.new_message",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "330340f2-ad36-4819-ae52-4150df4705f6",
      "name": "Set — Wrap Insert tg.messages",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28672,
        3408
      ],
      "notes": "Wrap PG result into db.new_message namespace.\nInput: PG result.\nOutput: { db.new_message: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "db7dfecc-6641-40c7-b46e-a1b5320c29c0",
      "name": "Merge — Restore After PG — Select Existing Message",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -29376,
        3312
      ],
      "notes": "Restore working item after PG � Select Existing Message.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.existing_msg).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eddf95dd-b480-4de2-b8a0-515df92dd2d2",
              "name": "db.existing_msg",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "cfd5f1ac-d8f5-40cb-a9dd-1952c0ce0abb",
      "name": "Set — Wrap PG — Select Existing Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -29568,
        3152
      ],
      "notes": "Wrap PG result into db.existing_msg namespace.\nInput: PG result.\nOutput: { db.existing_msg: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "215e110a-be7c-455b-8932-c002d51c5271",
      "name": "Merge — Restore After PG — Upsert tg.chats",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -29824,
        3504
      ],
      "notes": "Restore working item after PG � Upsert tg.chats.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.chat).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5539114d-5042-4426-a871-6372794173ef",
              "name": "db.chat",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "b5f33fba-3a58-44e7-9730-edbcff08b0b2",
      "name": "Set — Wrap PG — Upsert tg.chats",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30016,
        3392
      ],
      "notes": "Wrap PG result into db.chat namespace.\nInput: PG result.\nOutput: { db.chat: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "78eed599-8bca-40f8-887e-d2ee8e6c557e",
      "name": "Merge — Restore After PG — Upsert tg.users",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -30448,
        3552
      ],
      "notes": "Restore working item after PG � Upsert tg.users.\nInput 0: Original working item with _ctx/_parsed/req.\nInput 1: Wrapped DB result (db.user).\nOutput: Merged item with all context + DB result.\nWHY: PG nodes only return DB fields, losing working context."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "5083c986-fae7-4467-bfbe-742e799c1ec1",
              "name": "db.user",
              "value": "={{ $json }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "abbe9821-3ea6-4644-9de8-10844ddfda17",
      "name": "Set — Wrap PG — Upsert tg.users",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30608,
        3408
      ],
      "notes": "Wrap PG result into db.user namespace.\nInput: PG result.\nOutput: { db.user: {...db fields...} }\nWHY: Prevent collision with working item fields during merge."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "ops"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "jobs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json._job_url.tenant_id }}",
            "job_type": "={{ $json._job_url.job_type }}",
            "payload": "={{ $json._job_url.payload }}",
            "correlation_id": "={{ $json._job_url.correlation_id }}",
            "priority": "={{ $json._job_url.priority }}"
          },
          "schema": [
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "job_type",
              "displayName": "job_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "telegram_update",
                  "value": "telegram_update"
                },
                {
                  "name": "test_job",
                  "value": "test_job"
                },
                {
                  "name": "reembed_model_migration",
                  "value": "reembed_model_migration"
                },
                {
                  "name": "answer_query",
                  "value": "answer_query"
                },
                {
                  "name": "embed_chunks",
                  "value": "embed_chunks"
                },
                {
                  "name": "chunk_document",
                  "value": "chunk_document"
                },
                {
                  "name": "build_document",
                  "value": "build_document"
                },
                {
                  "name": "extract_text",
                  "value": "extract_text"
                },
                {
                  "name": "fetch_url",
                  "value": "fetch_url"
                },
                {
                  "name": "fetch_tg_file",
                  "value": "fetch_tg_file"
                },
                {
                  "name": "upsert_membership",
                  "value": "upsert_membership"
                },
                {
                  "name": "normalize_update",
                  "value": "normalize_update"
                }
              ]
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "dead",
                  "value": "dead"
                },
                {
                  "name": "failed",
                  "value": "failed"
                },
                {
                  "name": "succeeded",
                  "value": "succeeded"
                },
                {
                  "name": "running",
                  "value": "running"
                },
                {
                  "name": "queued",
                  "value": "queued"
                }
              ],
              "removed": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "attempts",
              "displayName": "attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "max_attempts",
              "displayName": "max_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "next_run_at",
              "displayName": "next_run_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "locked_at",
              "displayName": "locked_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "locked_by",
              "displayName": "locked_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "correlation_id",
              "displayName": "correlation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_error",
              "displayName": "last_error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "443a3e63-217a-4fe1-aa2c-f72a68957852",
      "name": "PG — Insert ops.jobs (URL)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -23504,
        3312
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert fetch_url job into ops.jobs.\nInput: { _job_url }\nOutput: Inserted row.\nWHY: Queue URL fetch for background processing."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "job-tenant",
              "name": "_job_url.tenant_id",
              "value": "={{ $json._ctx.tenant_id }}",
              "type": "string"
            },
            {
              "id": "job-type",
              "name": "_job_url.job_type",
              "value": "fetch_url",
              "type": "string"
            },
            {
              "id": "job-corr",
              "name": "_job_url.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "job-priority",
              "name": "_job_url.priority",
              "value": "=100",
              "type": "number"
            },
            {
              "id": "job-p-urlid",
              "name": "_job_url.payload.url_id",
              "value": "={{ $json.db.url.id }}",
              "type": "number"
            },
            {
              "id": "job-p-url",
              "name": "_job_url.payload.url",
              "value": "={{ $json._url }}",
              "type": "string"
            },
            {
              "id": "job-p-verid",
              "name": "_job_url.payload.message_version_id",
              "value": "={{ $json._version_id }}",
              "type": "number"
            },
            {
              "id": "job-p-chatid",
              "name": "_job_url.payload.chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "job-p-visibility",
              "name": "_job_url.payload.visibility",
              "value": "={{ $json._parsed.visibility }}",
              "type": "string"
            },
            {
              "id": "job-p-dm",
              "name": "_job_url.payload.dm_owner_user_id",
              "value": "={{ $json._parsed.dm_owner_user_id }}",
              "type": "number"
            },
            {
              "id": "ce8a310f-4776-4ab0-bf05-5f55da171d0f",
              "name": "_job_url.payload.tenant_id",
              "value": "={{$json._ctx.tenant_id}}",
              "type": "string"
            },
            {
              "id": "b60fe88e-7661-4299-8e5d-ba522cecd204",
              "name": "_job_url.payload.bot_id",
              "value": "={{$json._ctx.bot_id}}",
              "type": "string"
            },
            {
              "id": "c8deae62-005b-4b18-ab71-d57b25c9939c",
              "name": "_job_url.payload.trace_id",
              "value": "={{$json._ctx.trace_id}}",
              "type": "string"
            },
            {
              "id": "8e82d0a1-ab6a-403f-b121-0c8c1fddd0f0",
              "name": "_job_url.payload.visibility",
              "value": "={{$json._parsed.visibility}}",
              "type": "string"
            },
            {
              "id": "90c04b69-354d-41a6-9deb-c079bcc2069b",
              "name": "_job_url.payload.correlation_id",
              "value": "={{$json._ctx.correlation_id}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "bb2555c6-cef2-40ae-aa11-a479d48c836f",
      "name": "Set — Prepare Job URL Fetch",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23904,
        3312
      ],
      "notes": "Prepare fetch_url job payload.\nInput: _url (string), _ctx, _parsed, _version_id.\nOutput: _job_url object with all required fields.\nWHY: Each discovered URL needs a fetch_url job for downstream processing."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert ops.jobs (File)",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "ops.jobs",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "90e0c094-bd21-417d-8e81-c7e80c9ed1fe",
      "name": "ERR — Source PG Insert Job File",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -21360,
        5808
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error from job insert.\nOutput: Adds _err metadata.\nWHY: Identify error source for WF99."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "ops"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "jobs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json._job_file.tenant_id }}",
            "job_type": "={{ $json._job_file.job_type }}",
            "payload": "={{ $json._job_file.payload }}",
            "correlation_id": "={{ $json._job_file.correlation_id }}",
            "priority": "={{ $json._job_file.priority }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "job_type",
              "displayName": "job_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "telegram_update",
                  "value": "telegram_update"
                },
                {
                  "name": "test_job",
                  "value": "test_job"
                },
                {
                  "name": "reembed_model_migration",
                  "value": "reembed_model_migration"
                },
                {
                  "name": "answer_query",
                  "value": "answer_query"
                },
                {
                  "name": "embed_chunks",
                  "value": "embed_chunks"
                },
                {
                  "name": "chunk_document",
                  "value": "chunk_document"
                },
                {
                  "name": "build_document",
                  "value": "build_document"
                },
                {
                  "name": "extract_text",
                  "value": "extract_text"
                },
                {
                  "name": "fetch_url",
                  "value": "fetch_url"
                },
                {
                  "name": "fetch_tg_file",
                  "value": "fetch_tg_file"
                },
                {
                  "name": "upsert_membership",
                  "value": "upsert_membership"
                },
                {
                  "name": "normalize_update",
                  "value": "normalize_update"
                }
              ]
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "dead",
                  "value": "dead"
                },
                {
                  "name": "failed",
                  "value": "failed"
                },
                {
                  "name": "succeeded",
                  "value": "succeeded"
                },
                {
                  "name": "running",
                  "value": "running"
                },
                {
                  "name": "queued",
                  "value": "queued"
                }
              ],
              "removed": true
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "attempts",
              "displayName": "attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "max_attempts",
              "displayName": "max_attempts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "next_run_at",
              "displayName": "next_run_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "locked_at",
              "displayName": "locked_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "locked_by",
              "displayName": "locked_by",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "correlation_id",
              "displayName": "correlation_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "last_error",
              "displayName": "last_error",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "bd8a5054-b8e1-499d-b058-e23392d329f4",
      "name": "PG — Insert ops.jobs (File)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -22512,
        2816
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert fetch_tg_file job into ops.jobs.\nInput: { _job_file }\nOutput: Inserted row.\nWHY: Queue file download for background processing."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "job-tenant",
              "name": "_job_file.tenant_id",
              "value": "={{ $json._ctx.tenant_id }}",
              "type": "string"
            },
            {
              "id": "job-type",
              "name": "_job_file.job_type",
              "value": "fetch_tg_file",
              "type": "string"
            },
            {
              "id": "job-corr",
              "name": "_job_file.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "job-priority",
              "name": "_job_file.priority",
              "value": "=100",
              "type": "number"
            },
            {
              "id": "job-p-tgfileid",
              "name": "_job_file.payload.tg_file_id",
              "value": "={{ $json._file.file_id }}",
              "type": "string"
            },
            {
              "id": "job-p-uniqueid",
              "name": "_job_file.payload.file_unique_id",
              "value": "={{ $json._file.file_unique_id }}",
              "type": "string"
            },
            {
              "id": "job-p-kind",
              "name": "_job_file.payload.file_kind",
              "value": "={{ $json._file.type }}",
              "type": "string"
            },
            {
              "id": "job-p-verid",
              "name": "_job_file.payload.message_version_id",
              "value": "={{ $json._version_id }}",
              "type": "number"
            },
            {
              "id": "job-p-chatid",
              "name": "_job_file.payload.chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "job-p-visibility",
              "name": "_job_file.payload.visibility",
              "value": "={{ $json._parsed.visibility }}",
              "type": "string"
            },
            {
              "id": "job-p-dm",
              "name": "_job_file.payload.dm_owner_user_id",
              "value": "={{ $json._parsed.dm_owner_user_id }}",
              "type": "number"
            },
            {
              "id": "a5aa62ca-ae1d-4ec0-8439-b72ccd2e9399",
              "name": "_job_file.payload.tenant_id",
              "value": "={{$json._ctx.tenant_id}}",
              "type": "string"
            },
            {
              "id": "fd793020-e92b-48e0-aae1-b9bdf952ce6a",
              "name": "_job_file.payload.bot_id",
              "value": "={{$json._ctx.bot_id}}",
              "type": "string"
            },
            {
              "id": "84a43a81-ecb3-4aff-996c-750b0b149568",
              "name": "_job_file.payload.trace_id",
              "value": "={{$json._ctx.trace_id}}",
              "type": "string"
            },
            {
              "id": "ac3b3583-7020-41f6-9bd4-d6afaa40ecf0",
              "name": "_job_file.payload.correlation_id",
              "value": "={{$json._ctx.correlation_id}}",
              "type": "string"
            },
            {
              "id": "edf7b297-ec6a-4a86-9985-a2b1cf29ddd0",
              "name": "_job_file.payload.visibility",
              "value": "={{$json._parsed.visibility}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "53dc836b-f0fa-4d49-9c5e-ca000fcc5185",
      "name": "Set — Prepare Job File Fetch",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -22800,
        2800
      ],
      "notes": "Prepare fetch_tg_file job payload.\nInput: _file object, _ctx, _parsed, _version_id.\nOutput: _job_file object with all required fields.\nWHY: Each file attachment needs a fetch_tg_file job for download and processing."
    },
    {
      "parameters": {
        "numberInputs": 4
      },
      "id": "fb9eeeaa-ac94-4b0e-81a5-09085a16e6c3",
      "name": "Merge — Test Cases",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -33744,
        4832
      ],
      "notes": "Merge test case outputs.\nInput 0: Happy path data.\nInput 1: Edge case data.\nInput 2: Fail case data.\nOutput: Single item for correlation check.\nWHY: Converge test paths before main flow."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-req",
              "name": "req",
              "value": "={{ {\"ctx\": {\"tenant_id\": \"test-tenant\", \"correlation_id\": \"test-corr-003\", \"trace_id\": \"test-trace-003\"}, \"job\": {\"id\": 3, \"job_type\": \"normalize_update\", \"payload\": {\"bot_id\": \"nonexistent_bot\", \"update_id\": 99999, \"received_at\": \"1970-01-01T00:00:00Z\"}}} }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "7388e3b1-7e56-44e6-bfff-cec9acc98512",
      "name": "Set — Test Fail Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33952,
        4992
      ],
      "notes": "T3 (fail): Raw update not found.\nExpected: Routes to WF99 error path (non-retryable)."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-req",
              "name": "req",
              "value": "={{ {\"ctx\": {\"tenant_id\": \"test-tenant\", \"correlation_id\": \"test-corr-002\", \"trace_id\": \"test-trace-002\"}, \"job\": {\"id\": 2, \"job_type\": \"normalize_update\", \"payload\": {\"bot_id\": \"test_bot\", \"update_id\": 12346, \"received_at\": \"2025-01-01T00:01:00Z\"}}} }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "36e3d76b-953c-4236-aa9c-571446542bdd",
      "name": "Set — Test Edge Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33952,
        4832
      ],
      "notes": "T2 (edge): Update with 0 files and 0 urls.\nExpected: Still returns success, inserts message/version, creates build_document job only."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-req",
              "name": "req",
              "value": "={{ {\"ctx\": {\"tenant_id\": \"test-tenant\", \"correlation_id\": \"test-corr-001\", \"trace_id\": \"test-trace-001\"}, \"job\": {\"id\": 1, \"job_type\": \"normalize_update\", \"payload\": {\"bot_id\": \"test_bot\", \"update_id\": 12345, \"received_at\": \"2025-01-01T00:00:00Z\"}}} }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "179da6a9-7629-45d5-aaad-618c077c3e89",
      "name": "Set — Test Happy Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33952,
        4672
      ],
      "notes": "T1 (happy): normalize_update job with valid pointer.\nExpected: Loads raw update, inserts message+version, enqueues build_document job."
    },
    {
      "parameters": {},
      "id": "eab2b13b-ab14-4969-a089-2d6b3beb3841",
      "name": "Manual Trigger (TEST)",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -34368,
        4832
      ],
      "notes": "TEST trigger for manual testing.\nInput: None.\nOutput: Triggers test case switch.\nWHY: Allows testing without Job Runner."
    },
    {
      "parameters": {
        "numberInputs": 3
      },
      "id": "c595656a-ccae-4bbb-83cd-5b5b77fee14c",
      "name": "Merge — All Success Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -19840,
        3600
      ],
      "notes": "Collect success output from all paths (message, membership, other).\nInput: One of three SuccessEnvelope items.\nOutput: Single SuccessEnvelope.\nWHY: Ensures exactly one output item regardless of update kind."
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gcM1ZRVCKVtzJfHOH7OTw",
          "mode": "list",
          "cachedResultUrl": "/workflow/gcM1ZRVCKVtzJfHOH7OTw",
          "cachedResultName": "WF99 — Global ERR Handler"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "id": "0f9eaa59-8514-44ef-bbe5-3efc7389000d",
      "name": "Execute Workflow — WF99",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -16720,
        7200
      ],
      "notes": "Call WF99 Global Error Handler.\nInput: Error context from ErrorPipe v1 or raw-not-found error.\nOutput: ErrorEnvelope (WF99 builds it, not WF20).\nWHY: Centralized error handling per ErrorPipe Contract v1."
    },
    {
      "parameters": {
        "numberInputs": 17
      },
      "id": "cc8fba7b-9583-471a-bc13-7823bc17a307",
      "name": "Merge — All Error Paths",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -17440,
        6544
      ],
      "notes": "Merge all error outputs from Postgres nodes.\nInput: Multiple error streams from different PG nodes (13 original + 2 job insert errors).\nOutput: Single error stream for ErrorPipe preparation.\nWHY: Centralize error handling. numberInputs=15 for all PG error outputs."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ctx",
              "name": "ctx",
              "value": "={{ $json._ctx }}",
              "type": "object"
            },
            {
              "id": "ec-node",
              "name": "error_context.node",
              "value": "={{ $json._err.node }}",
              "type": "string"
            },
            {
              "id": "ec-op",
              "name": "error_context.operation",
              "value": "={{ $json._err.operation }}",
              "type": "string"
            },
            {
              "id": "ec-table",
              "name": "error_context.table",
              "value": "={{ $json._err.table }}",
              "type": "string"
            },
            {
              "id": "ec-corr",
              "name": "error_context.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "ec-msg",
              "name": "error_context.error_message",
              "value": "={{ $json.message || $json.error?.message || 'Database error' }}",
              "type": "string"
            },
            {
              "id": "ec-status",
              "name": "error_context.status_code",
              "value": "=500",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "19bcd262-50fa-4edd-a985-6ecbcabd7f4f",
      "name": "Set — Prepare ErrorPipe v1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -17024,
        6800
      ],
      "notes": "Prepare ErrorPipe v1 payload for WF99.\nInput: { _ctx, _err, message/error from PG error output }\nOutput: { ctx, error_context } per ErrorPipe Contract v1.\nWHY: Normalize error format before calling WF99."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ok",
              "name": "ok",
              "value": "=true",
              "type": "boolean"
            },
            {
              "id": "sc",
              "name": "status_code",
              "value": "=200",
              "type": "number"
            },
            {
              "id": "data-kind",
              "name": "data.update_kind",
              "value": "={{ $json._parsed.update_kind }}",
              "type": "string"
            },
            {
              "id": "data-msgs",
              "name": "data.messages_upserted",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-vers",
              "name": "data.versions_inserted",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-files",
              "name": "data.files_discovered",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-urls",
              "name": "data.urls_discovered",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-jobs",
              "name": "data.jobs_created",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "meta-corr",
              "name": "meta.correlation.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "2e581cc1-d251-41e1-b553-af88f4fc232c",
      "name": "Set — SuccessEnvelope (Other)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30064,
        4896
      ],
      "notes": "Build canonical SuccessEnvelope for unsupported update types.\nOutput: Single item with counts (all 0).\nWHY: Some update types are acknowledged but not processed."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ok",
              "name": "ok",
              "value": "=true",
              "type": "boolean"
            },
            {
              "id": "sc",
              "name": "status_code",
              "value": "=200",
              "type": "number"
            },
            {
              "id": "data-kind",
              "name": "data.update_kind",
              "value": "={{ $json._parsed.update_kind }}",
              "type": "string"
            },
            {
              "id": "data-msgs",
              "name": "data.messages_upserted",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-vers",
              "name": "data.versions_inserted",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-files",
              "name": "data.files_discovered",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-urls",
              "name": "data.urls_discovered",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "data-jobs",
              "name": "data.jobs_created",
              "value": "=0",
              "type": "number"
            },
            {
              "id": "meta-corr",
              "name": "meta.correlation.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "3d577b61-9059-4b72-a732-a60c3cd4bac7",
      "name": "Set — SuccessEnvelope (Membership)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28912,
        4544
      ],
      "notes": "Build canonical SuccessEnvelope for membership update.\nOutput: Single item with counts (all 0 for membership).\nWHY: Membership updates don't create messages/versions/jobs."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert tg.chat_memberships_current",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.chat_memberships_current",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "8b90388e-3893-4873-8374-ed931c22c846",
      "name": "ERR — Source PG Upsert Membership",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -29744,
        6208
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "chat_memberships_current"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json._ctx.tenant_id }}",
            "chat_id": "={{ $json.membership_chat_id }}",
            "tg_user_id": "={{ $json.membership_user_id }}",
            "status": "={{ $json.new_status }}",
            "role_payload": "={{ $json.role_payload }}"
          },
          "matchingColumns": [
            "tenant_id",
            "chat_id",
            "tg_user_id"
          ],
          "schema": [
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "tg_user_id",
              "displayName": "tg_user_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "role_payload",
              "displayName": "role_payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "2c9910fb-f63e-4baa-98a0-56bdab2a7d24",
      "name": "PG — Upsert tg.chat_memberships_current",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -29984,
        4336
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert current membership status.\nInput: tenant_id, chat_id, tg_user_id, status, role_payload\nOutput: Upserted row.\nWHY: Keep current membership state. Idempotent by PK (tenant_id, chat_id, tg_user_id)."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert tg.chat_member_events",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.chat_member_events",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "b2457ee4-871e-4493-a09a-a4960786889a",
      "name": "ERR — Source PG Insert Member Event",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30320,
        6512
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "chat_member_events"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json._ctx.tenant_id }}",
            "chat_id": "={{ $json.membership_chat_id }}",
            "tg_user_id": "={{ $json.membership_user_id }}",
            "actor_user_id": "={{ $json.actor_user_id }}",
            "old_status": "={{ $json.old_status }}",
            "new_status": "={{ $json.new_status }}",
            "payload": "={{ $json.membership_payload }}"
          },
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "tg_user_id",
              "displayName": "tg_user_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "actor_user_id",
              "displayName": "actor_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "event_at",
              "displayName": "event_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "old_status",
              "displayName": "old_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "new_status",
              "displayName": "new_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "fe160765-690e-44de-9851-52789afab26d",
      "name": "PG — Insert tg.chat_member_events",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -30688,
        4208
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert membership event into tg.chat_member_events.\nInput: tenant_id, chat_id, tg_user_id, etc.\nOutput: Inserted row.\nWHY: Audit trail of membership changes."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "mem-chat",
              "name": "membership_chat_id",
              "value": "={{ $json._parsed.membership_update?.chat?.id }}",
              "type": "number"
            },
            {
              "id": "mem-user",
              "name": "membership_user_id",
              "value": "={{ $json._parsed.membership_update?.new_chat_member?.user?.id || $json._parsed.membership_update?.from?.id }}",
              "type": "number"
            },
            {
              "id": "mem-actor",
              "name": "actor_user_id",
              "value": "={{ $json._parsed.membership_update?.from?.id }}",
              "type": "number"
            },
            {
              "id": "mem-old",
              "name": "old_status",
              "value": "={{ $json._parsed.membership_update?.old_chat_member?.status }}",
              "type": "string"
            },
            {
              "id": "mem-new",
              "name": "new_status",
              "value": "={{ $json._parsed.membership_update?.new_chat_member?.status }}",
              "type": "string"
            },
            {
              "id": "mem-payload",
              "name": "membership_payload",
              "value": "={{ $json._parsed.membership_update || {} }}",
              "type": "object"
            },
            {
              "id": "mem-role",
              "name": "role_payload",
              "value": "={{ $json._parsed.membership_update?.new_chat_member || {} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "4bf1bbb5-f437-40b8-8864-dd1504f808ed",
      "name": "Set — Prepare Membership Data",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30912,
        4400
      ],
      "notes": "Prepare fields for membership event insert.\nInput: { _parsed.membership_update }\nOutput: Adds membership_chat_id, membership_user_id, old_status, new_status, etc.\nWHY: Map Telegram membership update to tg.chat_member_events schema."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ok",
              "name": "ok",
              "value": "=true",
              "type": "boolean"
            },
            {
              "id": "sc",
              "name": "status_code",
              "value": "=200",
              "type": "number"
            },
            {
              "id": "data-msgs",
              "name": "data.messages_upserted",
              "value": "=1",
              "type": "number"
            },
            {
              "id": "data-vers",
              "name": "data.versions_inserted",
              "value": "=1",
              "type": "number"
            },
            {
              "id": "data-files",
              "name": "data.files_discovered",
              "value": "={{ $json._attachments?.files_count || 0 }}",
              "type": "number"
            },
            {
              "id": "data-urls",
              "name": "data.urls_discovered",
              "value": "={{ $json._attachments?.urls_count || 0 }}",
              "type": "number"
            },
            {
              "id": "data-jobs",
              "name": "data.jobs_created",
              "value": "={{ ($json._attachments?.files_count || 0) + ($json._attachments?.urls_count || 0) + 1 }}",
              "type": "number"
            },
            {
              "id": "data-kind",
              "name": "data.update_kind",
              "value": "={{ $json._parsed.update_kind }}",
              "type": "string"
            },
            {
              "id": "data-chat",
              "name": "data.chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "data-msgid",
              "name": "data.message_id",
              "value": "={{ $json._parsed.message_id }}",
              "type": "number"
            },
            {
              "id": "data-verid",
              "name": "data.message_version_id",
              "value": "={{ $json._version_id }}",
              "type": "number"
            },
            {
              "id": "meta-corr",
              "name": "meta.correlation.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "167ea4cc-9f8e-427b-ad07-148f3428a39f",
              "name": "meta.job_run_id",
              "value": "={{ $json._meta.job_run_id }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "336b7290-b25e-43b0-b803-dae26707e1d2",
      "name": "Set — SuccessEnvelope (Message)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -20320,
        3408
      ],
      "notes": "Build canonical SuccessEnvelope for message processing.\nInput: All accumulated context.\nOutput: Single item with ok, status_code, data counts, meta.correlation.\nWHY: WF20 must return exactly ONE SuccessEnvelope per the workflow contract."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert content.urls",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "content.urls",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "299f284d-f2fd-442f-b89f-fdf2b18549d8",
      "name": "ERR — Source PG Upsert URL",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23680,
        5680
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "content"
        },
        "table": {
          "__rl": true,
          "value": "urls",
          "mode": "list",
          "cachedResultName": "urls"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "normalized_url": "={{ $json._url }}",
            "meta": "={}"
          },
          "matchingColumns": [
            "normalized_url"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "normalized_url",
              "displayName": "normalized_url",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "canonical_url",
              "displayName": "canonical_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "first_seen_at",
              "displayName": "first_seen_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "last_seen_at",
              "displayName": "last_seen_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "4cce0946-c060-43a1-9bbc-1f1571061831",
      "name": "PG — Upsert content.urls",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -24816,
        3456
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert discovered URL into content.urls.\nInput: _url\nOutput: Upserted row.\nWHY: Deduplicate URLs by normalized_url (unique constraint)."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "has-urls",
              "leftValue": "={{ ($json._attachments?.urls_count ?? 0) > 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "a596fb66-648f-4f81-bd7b-eda8a539b73c",
      "name": "IF — Has URLs",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -25792,
        3200
      ],
      "notes": "Check if message has discovered URLs.\nInput: { _attachments: { urls_count } }\nOutput true: Has URLs, persist to content.urls.\nOutput false: No URLs, skip.\nWHY: Only process URLs if found."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert tg.message_attachments",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.message_attachments",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "59c09648-19bc-4539-ba04-9da0cb7b5e9f",
      "name": "ERR — Source PG Insert Attachment",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -21760,
        5600
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "message_attachments"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message_version_id": "={{ $json._version_id }}",
            "attach_type": "={{ $json._file.type }}",
            "file_id": "={{ $json._file.file_id }}",
            "file_unique_id": "={{ $json._file.file_unique_id }}",
            "mime_type": "={{ $json._file.mime_type }}",
            "file_name": "={{ $json._file.file_name }}",
            "file_size": "={{ $json._file.file_size }}",
            "width": "={{ $json._file.width }}",
            "height": "={{ $json._file.height }}",
            "duration_sec": "={{ $json._file.duration }}",
            "payload": "={{ $json._file.payload || {} }}"
          },
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "message_version_id",
              "displayName": "message_version_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "attach_type",
              "displayName": "attach_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_unique_id",
              "displayName": "file_unique_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "mime_type",
              "displayName": "mime_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_name",
              "displayName": "file_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_size",
              "displayName": "file_size",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "width",
              "displayName": "width",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "height",
              "displayName": "height",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "duration_sec",
              "displayName": "duration_sec",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "8b804aca-971c-421f-8057-428ab72ee4d6",
      "name": "PG — Insert tg.message_attachments",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -23248,
        2640
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert file attachment linking version to file.\nInput: _version_id, _file details\nOutput: Inserted row.\nWHY: Link message version to discovered files."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert tg.file_instances",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.file_instances",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "502fb615-266e-4168-bf5e-b1c3e45a204b",
      "name": "ERR — Source PG Upsert File Instance",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23232,
        5472
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "file_instances"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "file_id": "={{ $json._file.file_id }}",
            "file_unique_id": "={{ $json._file.file_unique_id }}",
            "meta": "={}"
          },
          "matchingColumns": [
            "file_id"
          ],
          "schema": [
            {
              "id": "file_id",
              "displayName": "file_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "file_unique_id",
              "displayName": "file_unique_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "tg_file_path",
              "displayName": "tg_file_path",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "last_seen_at",
              "displayName": "last_seen_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "meta",
              "displayName": "meta",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "5354ae07-b068-42bf-9536-4391b217e3f8",
      "name": "PG — Upsert tg.file_instances",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -24032,
        2720
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert file instance into tg.file_instances.\nInput: _file.file_id, file_unique_id\nOutput: Upserted row.\nWHY: Track file_id -> file_unique_id mapping. file_id is PK."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert tg.files",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.files",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "e85b2bed-f497-4e06-8eba-30d8a0964a87",
      "name": "ERR — Source PG Upsert File",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -23584,
        5136
      ],
      "notes": "Tag error source for ErrorPipe v1."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Update messages.current_version_id",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "update",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.messages",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "2054d644-1a4d-4bc4-9ad0-02b4664c6d82",
      "name": "ERR — Source PG Update Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -25824,
        5584
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "operation": "update",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "messages"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json._message_fk }}",
            "current_version_id": "={{ $json._version_id }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "message_thread_id",
              "displayName": "message_thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "is_topic_message",
              "displayName": "is_topic_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "visibility",
              "displayName": "visibility",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "admin_only",
                  "value": "admin_only"
                },
                {
                  "name": "dm_private",
                  "value": "dm_private"
                },
                {
                  "name": "group",
                  "value": "group"
                }
              ],
              "removed": true
            },
            {
              "id": "dm_owner_user_id",
              "displayName": "dm_owner_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "current_version_id",
              "displayName": "current_version_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "22b3d20f-3edb-4e77-9a08-237b1d434c66",
      "name": "PG — Update messages.current_version_id",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -26672,
        2960
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Update tg.messages.current_version_id to point to new version.\nInput: _message_fk, _version_id\nOutput: Updated row.\nWHY: Keep current_version_id in sync after each version insert."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ver-id",
              "name": "_version_id",
              "value": "={{ $json.db.version.id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "f133ac3a-fcff-4172-aea5-ec7949415370",
      "name": "Set — Store Version ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -26912,
        3168
      ],
      "notes": "Store inserted version ID for later use.\nInput: { id: <version id> }\nOutput: Adds _version_id.\nWHY: Need version ID to update tg.messages.current_version_id and for attachments."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert tg.message_versions",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.message_versions",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "81706406-4afe-4dba-be0e-f8fa95f5f352",
      "name": "ERR — Source PG Insert Version",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -26608,
        5424
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "message_versions"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "message_fk": "={{ $json.message_fk }}",
            "version_no": "={{ $json.version_no }}",
            "sent_at": "={{ $json.sent_at }}",
            "edited_at": "={{ $json.edited_at }}",
            "from_user_id": "={{ $json.from_user_id }}",
            "via_bot_user_id": "={{ $json.via_bot_user_id }}",
            "text": "={{ $json.text }}",
            "caption": "={{ $json.caption }}",
            "reply_to_message_id": "={{ $json.reply_to_message_id }}",
            "forward_from_user_id": "={{ $json.forward_from_user_id }}",
            "forward_from_chat_id": "={{ $json.forward_from_chat_id }}",
            "forward_date": "={{ $json.forward_date }}",
            "has_media": "={{ $json.has_media }}",
            "has_links": "={{ $json.has_links }}",
            "content_sha256": "={{ $json.content_sha256 }}",
            "payload": "={{ $json.payload }}"
          },
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "message_fk",
              "displayName": "message_fk",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "version_no",
              "displayName": "version_no",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "sent_at",
              "displayName": "sent_at",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "edited_at",
              "displayName": "edited_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "from_user_id",
              "displayName": "from_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "via_bot_user_id",
              "displayName": "via_bot_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "text",
              "displayName": "text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "caption",
              "displayName": "caption",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "reply_to_message_id",
              "displayName": "reply_to_message_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "forward_from_user_id",
              "displayName": "forward_from_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "forward_from_chat_id",
              "displayName": "forward_from_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "forward_date",
              "displayName": "forward_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true
            },
            {
              "id": "has_media",
              "displayName": "has_media",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "has_links",
              "displayName": "has_links",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "normalized_text",
              "displayName": "normalized_text",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "content_sha256",
              "displayName": "content_sha256",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "outputColumns": [
            "id"
          ]
        }
      },
      "id": "c712e4c2-cb0e-42ce-a40a-2bb4b97cdc7d",
      "name": "PG — Insert tg.message_versions",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -27392,
        3440
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert message version into tg.message_versions.\nInput: All version fields.\nOutput: Inserted row with id.\nWHY: Persist version content. Unique by (message_fk, version_no).\nNOTE: entities/caption_entities excluded (n8n limitation with arrays). Source: payload jsonb."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ver-msgfk",
              "name": "message_fk",
              "value": "={{ $json._message_fk }}",
              "type": "number"
            },
            {
              "id": "ver-no",
              "name": "version_no",
              "value": "={{ $json._version_no }}",
              "type": "number"
            },
            {
              "id": "ver-sent",
              "name": "sent_at",
              "value": "={{ $json._parsed.date_iso }}",
              "type": "string"
            },
            {
              "id": "ver-edit",
              "name": "edited_at",
              "value": "={{ $json._parsed.edit_date_iso }}",
              "type": "string"
            },
            {
              "id": "ver-from",
              "name": "from_user_id",
              "value": "={{ $json._parsed.from_user?.id }}",
              "type": "number"
            },
            {
              "id": "ver-via",
              "name": "via_bot_user_id",
              "value": "={{ $json._parsed.via_bot?.id }}",
              "type": "number"
            },
            {
              "id": "ver-text",
              "name": "text",
              "value": "={{ $json._parsed.text }}",
              "type": "string"
            },
            {
              "id": "ver-caption",
              "name": "caption",
              "value": "={{ $json._parsed.caption }}",
              "type": "string"
            },
            {
              "id": "ver-reply",
              "name": "reply_to_message_id",
              "value": "={{ $json._parsed.reply_to_message_id }}",
              "type": "number"
            },
            {
              "id": "ver-fwd-user",
              "name": "forward_from_user_id",
              "value": "={{ $json._parsed.forward_from?.id }}",
              "type": "number"
            },
            {
              "id": "ver-fwd-chat",
              "name": "forward_from_chat_id",
              "value": "={{ $json._parsed.forward_from_chat?.id }}",
              "type": "number"
            },
            {
              "id": "ver-fwd-date",
              "name": "forward_date",
              "value": "={{ $json._parsed.forward_date_iso }}",
              "type": "string"
            },
            {
              "id": "ver-media",
              "name": "has_media",
              "value": "={{ $json._parsed.has_media }}",
              "type": "boolean"
            },
            {
              "id": "ver-links",
              "name": "has_links",
              "value": "={{ $json._parsed.has_links }}",
              "type": "boolean"
            },
            {
              "id": "ver-hash",
              "name": "content_sha256",
              "value": "={{ $json._content_sha256 }}",
              "type": "string"
            },
            {
              "id": "ver-payload",
              "name": "payload",
              "value": "={{ $json.req.update }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "9152bbab-120a-472a-b89b-720ae6899116",
      "name": "Set — Prepare Version Insert",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27616,
        3424
      ],
      "notes": "Prepare fields for tg.message_versions insert.\nInput: { _message_fk, _version_no, _parsed, _content_sha256, req.update }\nOutput: All version fields mapped from parsed data.\nWHY: Map Telegram message content to tg.message_versions schema.\nNOTE: entities/caption_entities are NOT written separately (n8n Set node cannot handle arrays as 'object' type). They remain accessible via payload jsonb column."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg-fk2",
              "name": "_message_fk",
              "value": "={{ $('IF — Message Exists').item.json.db.existing_msg.id }}",
              "type": "number"
            },
            {
              "id": "ver-no2",
              "name": "_version_no",
              "value": "={{ ($json.db.max_version.version_no || 0) + 1 }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "abcc0625-1968-4950-854f-429c8322cde0",
      "name": "Set — Existing Message FK (next version)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28496,
        3008
      ],
      "notes": "Set message_fk and increment version_no for edited message.\nInput: { version_no, ... } from select or empty.\nOutput: Adds _message_fk from prior IF node, _version_no = current + 1.\nWHY: Edited message gets next version number."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Select Max Version",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.message_versions",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "f6a27ece-16a8-4a17-ba30-f898224a27a1",
      "name": "ERR — Source PG Select Version",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27776,
        6112
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "message_versions"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "message_fk",
              "value": "={{ $json.db.existing_msg?.id }}"
            }
          ]
        },
        "sort": {
          "values": [
            {
              "column": "version_no",
              "direction": "DESC"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "version_no"
          ]
        }
      },
      "id": "d0bcbef0-1ae9-4aa4-8445-02233caada10",
      "name": "PG — Select Max Version",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -29008,
        3168
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Get current max version_no for existing message.\nInput: message_fk (id from tg.messages)\nOutput: { version_no } or empty.\nWHY: Need to increment version for edited message. alwaysOutputData handles empty result."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg-fk",
              "name": "_message_fk",
              "value": "={{ $json.db.new_message.id }}",
              "type": "number"
            },
            {
              "id": "ver-no",
              "name": "_version_no",
              "value": "=1",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "18e588f1-6106-4e1d-859d-1fb9d2bbbf74",
      "name": "Set — New Message FK (version 1)",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28368,
        3424
      ],
      "notes": "Set message_fk and version_no=1 for new message.\nInput: { id: <new message id>, ... }\nOutput: Adds _message_fk, _version_no=1.\nWHY: New message always starts at version 1."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert tg.messages",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.messages",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "0589c3ba-c870-4464-b8b1-0b23b66645ea",
      "name": "ERR — Source PG Insert Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28192,
        5888
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "tg"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "messages"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json.tenant_id }}",
            "chat_id": "={{ $json.chat_id }}",
            "message_id": "={{ $json.message_id }}",
            "message_thread_id": "={{ $json.message_thread_id }}",
            "is_topic_message": "={{ $json.is_topic_message }}",
            "visibility": "={{ $json.visibility }}",
            "dm_owner_user_id": "={{ $json.dm_owner_user_id }}"
          },
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_id",
              "displayName": "message_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "message_thread_id",
              "displayName": "message_thread_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "is_topic_message",
              "displayName": "is_topic_message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": true
            },
            {
              "id": "visibility",
              "displayName": "visibility",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": true,
              "options": [
                {
                  "name": "admin_only",
                  "value": "admin_only"
                },
                {
                  "name": "dm_private",
                  "value": "dm_private"
                },
                {
                  "name": "group",
                  "value": "group"
                }
              ]
            },
            {
              "id": "dm_owner_user_id",
              "displayName": "dm_owner_user_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "created_at",
              "displayName": "created_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "current_version_id",
              "displayName": "current_version_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {
          "outputColumns": [
            "id"
          ],
          "skipOnConflict": true
        }
      },
      "id": "1b3b71e9-ec03-4627-90f2-1b25cf6e874d",
      "name": "PG — Insert tg.messages",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -28832,
        3520
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert new message into tg.messages.\nInput: tenant_id, chat_id, message_id, etc.\nOutput: Inserted row with id.\nWHY skipOnConflict=true: Idempotent by unique (tenant_id, chat_id, message_id)."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "msg-tenant",
              "name": "tenant_id",
              "value": "={{ $json.tenant_id }}",
              "type": "string"
            },
            {
              "id": "msg-chat",
              "name": "chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "msg-id",
              "name": "message_id",
              "value": "={{ $json._parsed.message_id }}",
              "type": "number"
            },
            {
              "id": "msg-thread",
              "name": "message_thread_id",
              "value": "={{ $json._parsed.message_thread_id }}",
              "type": "number"
            },
            {
              "id": "msg-topic",
              "name": "is_topic_message",
              "value": "={{ $json._parsed.is_topic_message }}",
              "type": "boolean"
            },
            {
              "id": "msg-vis",
              "name": "visibility",
              "value": "={{ $json._parsed.visibility }}",
              "type": "string"
            },
            {
              "id": "msg-dm",
              "name": "dm_owner_user_id",
              "value": "={{ $json._parsed.dm_owner_user_id }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "5e5ccad9-1319-409c-9dfc-1143248e666e",
      "name": "Set — Prepare New Message Insert",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -29008,
        3424
      ],
      "notes": "Prepare fields for new tg.messages insert.\nInput: { _ctx, _parsed }\nOutput: Adds tenant_id, chat_id, message_id, visibility, dm_owner_user_id.\nWHY: Map to tg.messages schema for new message."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "msg-exists",
              "leftValue": "={{ $json.db.existing_msg?.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e2fb178b-61f1-452d-8588-85432b7d9cba",
      "name": "IF — Message Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -29200,
        3152
      ],
      "notes": "Check if message already exists in tg.messages.\nInput: Select result with id field or empty.\nOutput true: Message exists, need to create new version.\nOutput false: New message, insert message first.\nWHY: Different paths for new message vs edit."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Select Existing Message",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.messages",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "d47c67f3-dd47-49b8-9520-a25b32cf164b",
      "name": "ERR — Source PG Select Message",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -28976,
        5760
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "operation": "select",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "messages",
          "mode": "list",
          "cachedResultName": "messages"
        },
        "limit": 1,
        "where": {
          "values": [
            {
              "column": "tenant_id",
              "value": "={{$json._ctx.tenant_id}}"
            },
            {
              "column": "chat_id",
              "value": "={{ $json._parsed.chat_id }}"
            },
            {
              "column": "message_id",
              "value": "={{ $json._parsed.message_id }}"
            }
          ]
        },
        "options": {
          "outputColumns": [
            "id",
            "current_version_id"
          ]
        }
      },
      "id": "d591ecf7-8721-4574-a91a-22a31384110d",
      "name": "PG — Select Existing Message",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -29696,
        3312
      ],
      "alwaysOutputData": true,
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Check if message already exists by natural key (tenant_id, chat_id, message_id).\nInput: _ctx.tenant_id, _parsed.chat_id, _parsed.message_id\nOutput: Existing message row or empty.\nWHY alwaysOutputData=true: Need to handle both cases (exists/not exists) without breaking flow."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert tg.chats",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.chats",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "7275707d-5bd3-4910-b37c-a4df13f57239",
      "name": "ERR — Source PG Upsert tg.chats",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -29440,
        6240
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "chats",
          "mode": "list",
          "cachedResultName": "chats"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "chat_id": "={{ $json.chat_id }}",
            "chat_type": "={{ $json.chat_type }}",
            "title": "={{ $json.title }}",
            "username": "={{ $json.username }}",
            "is_forum": "={{ $json.is_forum }}",
            "payload": "={{ $json.payload }}"
          },
          "matchingColumns": [
            "chat_id"
          ],
          "schema": [
            {
              "id": "chat_id",
              "displayName": "chat_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "chat_type",
              "displayName": "chat_type",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "options",
              "canBeUsedToMatch": false,
              "options": [
                {
                  "name": "channel",
                  "value": "channel"
                },
                {
                  "name": "supergroup",
                  "value": "supergroup"
                },
                {
                  "name": "group",
                  "value": "group"
                },
                {
                  "name": "private",
                  "value": "private"
                }
              ]
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "is_forum",
              "displayName": "is_forum",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "parent_chat_id",
              "displayName": "parent_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "b954ee86-98a9-45d2-b342-3d967f2ddf67",
      "name": "PG — Upsert tg.chats",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -30160,
        3536
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert chat into tg.chats.\nInput: chat_id, chat_type, title, etc.\nOutput: Upserted row or error.\nWHY: Persist chat for message context. Idempotent by chat_id PK."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "chat-id",
              "name": "chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "chat-type",
              "name": "chat_type",
              "value": "={{ $json._parsed.chat_type }}",
              "type": "string"
            },
            {
              "id": "chat-title",
              "name": "title",
              "value": "={{ $json._parsed.chat?.title }}",
              "type": "string"
            },
            {
              "id": "chat-username",
              "name": "username",
              "value": "={{ $json._parsed.chat?.username }}",
              "type": "string"
            },
            {
              "id": "chat-forum",
              "name": "is_forum",
              "value": "={{ $json._parsed.chat?.is_forum }}",
              "type": "boolean"
            },
            {
              "id": "chat-payload",
              "name": "payload",
              "value": "={{ $json._parsed.chat || {} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "81685c63-d3fd-471d-9203-bacc8adb2104",
      "name": "Set — Prepare Chat Upsert",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30288,
        3792
      ],
      "notes": "Prepare fields for tg.chats upsert.\nInput: { _parsed: { chat_id, chat_type, chat: {...} }, ... }\nOutput: Adds chat_id, chat_type, title, etc.\nWHY: Map Telegram chat to tg.chats schema."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Upsert tg.users",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "upsert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "tg.users",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "1169bd8e-753c-4e5a-85db-5357b7093707",
      "name": "ERR — Source PG Upsert tg.users",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30464,
        6672
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "operation": "upsert",
        "schema": {
          "__rl": true,
          "value": "tg",
          "mode": "list",
          "cachedResultName": "tg"
        },
        "table": {
          "__rl": true,
          "value": "users",
          "mode": "list",
          "cachedResultName": "users"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tg_user_id": "={{ $json.tg_user_id }}",
            "is_bot": "={{ $json.is_bot }}",
            "first_name": "={{ $json.first_name }}",
            "last_name": "={{ $json.last_name }}",
            "username": "={{ $json.username }}",
            "language_code": "={{ $json.language_code }}",
            "is_premium": "={{ $json.is_premium }}",
            "payload": "={{ $json.payload }}"
          },
          "matchingColumns": [
            "tg_user_id"
          ],
          "schema": [
            {
              "id": "tg_user_id",
              "displayName": "tg_user_id",
              "required": true,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true
            },
            {
              "id": "is_bot",
              "displayName": "is_bot",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "last_name",
              "displayName": "last_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "username",
              "displayName": "username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "language_code",
              "displayName": "language_code",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "is_premium",
              "displayName": "is_premium",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false
            },
            {
              "id": "added_to_attach_menu",
              "displayName": "added_to_attach_menu",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "boolean",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "updated_at",
              "displayName": "updated_at",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "dateTime",
              "canBeUsedToMatch": false,
              "removed": true
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "object",
              "canBeUsedToMatch": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "4e18ee0e-e2ca-4787-8c0a-a33703263e4f",
      "name": "PG — Upsert tg.users",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -30816,
        3408
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Upsert sender user into tg.users.\nInput: tg_user_id, is_bot, first_name, etc.\nOutput: Upserted row or error.\nWHY: Persist user for message attribution. Idempotent by tg_user_id PK."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-id",
              "name": "tg_user_id",
              "value": "={{ $json._parsed.from_user?.id }}",
              "type": "number"
            },
            {
              "id": "user-is-bot",
              "name": "is_bot",
              "value": "={{ $json._parsed.from_user?.is_bot || false }}",
              "type": "boolean"
            },
            {
              "id": "user-first",
              "name": "first_name",
              "value": "={{ $json._parsed.from_user?.first_name }}",
              "type": "string"
            },
            {
              "id": "user-last",
              "name": "last_name",
              "value": "={{ $json._parsed.from_user?.last_name }}",
              "type": "string"
            },
            {
              "id": "user-username",
              "name": "username",
              "value": "={{ $json._parsed.from_user?.username }}",
              "type": "string"
            },
            {
              "id": "user-lang",
              "name": "language_code",
              "value": "={{ $json._parsed.from_user?.language_code }}",
              "type": "string"
            },
            {
              "id": "user-premium",
              "name": "is_premium",
              "value": "={{ $json._parsed.from_user?.is_premium }}",
              "type": "boolean"
            },
            {
              "id": "user-payload",
              "name": "payload",
              "value": "={{ $json._parsed.from_user || {} }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "e9539091-4c69-46a9-b86c-03179d4a0268",
      "name": "Set — Prepare User Upsert",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -30960,
        3536
      ],
      "notes": "Prepare fields for tg.users upsert.\nInput: { _parsed: { from_user: {...} }, ... }\nOutput: Adds tg_user_id, is_bot, first_name, etc. for Postgres upsert.\nWHY: Map Telegram user to tg.users schema."
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "message",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "1adb9dde-6641-4177-ad7d-a0829d6ef250"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "edited_message",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7781cf48-78e4-45c1-80ec-951f57e00c79"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "channel_post",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "132f44af-fbc8-4cae-8a99-20795c2a3641"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "edited_channel_post",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "15659d69-b87d-4dc5-9450-231cab083f45"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "my_chat_member",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "a6832f36-9ebd-4272-8d47-39d80e4770a2"
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json._parsed.update_kind }}",
                    "rightValue": "chat_member",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d60418d5-3f81-4450-81b8-2e8e7a902d0c"
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "05225df5-dfc8-4967-bb44-be0963469032",
      "name": "Switch — Update Kind",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [
        -31296,
        3984
      ],
      "notes": "Route based on update_kind.\nInput: { _parsed: { update_kind: '...' }, ... }\nOutputs: 0=message, 1=edited_message, 2=channel_post, 3=edited_channel_post, 4=my_chat_member, 5=chat_member, 6=other(fallback).\nWHY: Different update types require different processing paths."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "ctx-wf",
              "name": "_ctx.workflow",
              "value": "WF20",
              "type": "string"
            },
            {
              "id": "ctx-tenant",
              "name": "_ctx.tenant_id",
              "value": "={{ $json.req.ctx.tenant_id }}",
              "type": "string"
            },
            {
              "id": "ctx-trace",
              "name": "_ctx.trace_id",
              "value": "={{ $json.req.ctx.trace_id }}",
              "type": "string"
            },
            {
              "id": "ctx-corr",
              "name": "_ctx.correlation_id",
              "value": "={{ $json.req.ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "ctx-contract",
              "name": "_ctx.contracts.errorpipe",
              "value": "=1",
              "type": "number"
            },
            {
              "id": "5a87b3f2-6123-446d-915e-896bc61612a8",
              "name": "_ctx.job_id",
              "value": "={{$json.req.job.id}}",
              "type": "number"
            },
            {
              "id": "14da5771-60de-43df-9589-470e1764937d",
              "name": "_ctx.bot_id",
              "value": "={{$json.req.job.payload.bot_id}}",
              "type": "string"
            },
            {
              "id": "f41057f9-136c-4649-8efe-ae042abe923e",
              "name": "_ctx.update_id",
              "value": "={{$json.req.job.payload.update_id}}",
              "type": "string"
            },
            {
              "id": "64fb02b0-220e-4bb4-860e-4163260b12ec",
              "name": "_ctx.received_at",
              "value": "={{$json.req.job.payload.received_at}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "c02a3ec3-87c3-41ce-8b41-4007b60de211",
      "name": "Set — Build _ctx",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33552,
        4016
      ],
      "notes": "Build _ctx object for correlation and ErrorPipe.\nInput: { req: { tenant_id, update, trace_id, correlation_id } }\nOutput: Adds _ctx.workflow, _ctx.tenant_id, _ctx.trace_id, _ctx.correlation_id, _ctx.contracts.errorpipe.\nWHY: _ctx required for ErrorPipe v1 and meta in SuccessEnvelope."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "gen-corr",
              "name": "req.ctx.correlation_id",
              "value": "={{ $json.data }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "faa5653b-4eb4-4bfc-98fb-0905fd9b5fd8",
      "name": "Set — Assign Generated Correlation ID",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33760,
        4160
      ],
      "notes": "Assign generated UUID to req.correlation_id.\nInput: { data: '<uuid>', req: { ... } }\nOutput: { req: { correlation_id: '<uuid>', ... } }\nWHY: Move generated UUID into proper location."
    },
    {
      "parameters": {
        "action": "generate"
      },
      "id": "f05393ca-6bb3-466a-a45a-6267716dc1cc",
      "name": "Crypto — Generate UUID",
      "type": "n8n-nodes-base.crypto",
      "typeVersion": 1,
      "position": [
        -33952,
        4160
      ],
      "notes": "Generate UUID for correlation_id when not provided.\nInput: Item without correlation_id.\nOutput: { data: '<uuid>' } added to item.\nWHY: No Code node for UUID generation per project rules."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "cond-corr-exists",
              "leftValue": "={{ $json.req.ctx.correlation_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "61de7742-b64f-4405-b866-87f1fd469dc3",
      "name": "IF — Correlation ID Exists",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -34160,
        4032
      ],
      "notes": "Check if req.correlation_id was provided.\nInput: { req: { ... } }\nOutput true: correlation_id exists, pass through.\nOutput false: need to generate correlation_id.\nWHY: correlation_id required for tracing; generate if missing per CTX spec."
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "id": "88a6e4eb-64f4-491d-95c3-bf9c5adae0d8",
      "name": "Execute Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -34368,
        3920
      ],
      "notes": "PROD trigger: Receives update payload from Job Runner.\nInput: { req: { tenant_id, update, trace_id, correlation_id } }\nOutput: Same item passed through.\nWHY passthrough: Accepts any shape from caller, processes raw Telegram update."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "vis-type",
              "name": "_parsed.visibility",
              "value": "={{ $json._parsed.chat_type === 'private' ? 'dm_private' : 'group' }}",
              "type": "string"
            },
            {
              "id": "vis-dm-owner",
              "name": "_parsed.dm_owner_user_id",
              "value": "={{ $json._parsed.chat_type === 'private' ? ($json._parsed.chat_id || null) : null }}",
              "type": "number"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -31632,
        4240
      ],
      "id": "eac98e4c-fc0e-4ce7-8233-b2a969614107",
      "name": "Set — Derive Visibility",
      "notes": "Derive visibility and dm_owner_user_id from chat_type.\nInput: _parsed.chat_type, _parsed.from_user.\nOutput: _parsed.visibility (string: dm_private|group), _parsed.dm_owner_user_id (number|null).\nWHY: tg.messages.visibility is NOT NULL. DM access requires dm_owner_user_id = from_user.id (not chat_id)."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "date-iso",
              "name": "_parsed.date_iso",
              "value": "={{ $json._parsed.date ? new Date($json._parsed.date * 1000).toISOString() : null }}",
              "type": "string"
            },
            {
              "id": "edit-date-iso",
              "name": "_parsed.edit_date_iso",
              "value": "={{ $json._parsed.edit_date ? new Date($json._parsed.edit_date * 1000).toISOString() : null }}",
              "type": "string"
            },
            {
              "id": "fwd-date-iso",
              "name": "_parsed.forward_date_iso",
              "value": "={{ $json._parsed.forward_date ? new Date($json._parsed.forward_date * 1000).toISOString() : null }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -27824,
        3136
      ],
      "id": "2ca56bdf-2bd3-4c4c-a544-3832c3f90d27",
      "name": "Set node Set — Convert Epoch → ISO",
      "notes": "Convert Telegram epoch seconds to ISO 8601 timestamptz strings.\nInput: _parsed.date, _parsed.edit_date, _parsed.forward_date (epoch seconds).\nOutput: _parsed.date_iso, _parsed.edit_date_iso, _parsed.forward_date_iso.\nWHY: PostgreSQL timestamptz expects ISO format, not epoch integers."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Load raw.telegram_updates",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "select",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "raw.telegram_updates",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "1307182b-eed3-48c3-beff-8a248ffe0500",
      "name": "ERR — Source PG Load Raw",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -32304,
        5312
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG Load raw node.\nOutput: Adds _err.node, _err.operation, _err.table.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "cond-from-user",
              "leftValue": "={{ $json._parsed.from_user }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "ce3896b3-b97f-41b4-a103-abab03bad451",
      "name": "IF — Has from_user",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -31104,
        3840
      ],
      "notes": "Check if update has from_user (absent for channel_post).\nInput: _parsed.from_user.\nOutput True: Has user → proceed to tg.users upsert.\nOutput False: No user → skip user upsert, go directly to chat upsert.\nWHY: channel_post updates lack from_user; trying to upsert null user would fail."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "job-tenant",
              "name": "_job_doc.tenant_id",
              "value": "={{ $json._ctx.tenant_id }}",
              "type": "string"
            },
            {
              "id": "job-type",
              "name": "_job_doc.job_type",
              "value": "build_document",
              "type": "string"
            },
            {
              "id": "job-corr",
              "name": "_job_doc.correlation_id",
              "value": "={{ $json._ctx.correlation_id }}",
              "type": "string"
            },
            {
              "id": "job-priority",
              "name": "_job_doc.priority",
              "value": "=50",
              "type": "number"
            },
            {
              "id": "job-p-doctype",
              "name": "_job_doc.payload.doc_type",
              "value": "message",
              "type": "string"
            },
            {
              "id": "job-p-verid",
              "name": "_job_doc.payload.message_version_id",
              "value": "={{ $json._version_id }}",
              "type": "number"
            },
            {
              "id": "job-p-chatid",
              "name": "_job_doc.payload.chat_id",
              "value": "={{ $json._parsed.chat_id }}",
              "type": "number"
            },
            {
              "id": "job-p-vis",
              "name": "_job_doc.payload.visibility",
              "value": "={{ $json._parsed.visibility }}",
              "type": "string"
            },
            {
              "id": "job-p-dm",
              "name": "_job_doc.payload.dm_owner_user_id",
              "value": "={{ $json._parsed.dm_owner_user_id }}",
              "type": "number"
            },
            {
              "id": "959a968c-cd6e-402d-8571-ea1ad86143f5",
              "name": "_job_doc.payload.tenant_id",
              "value": "={{$json._ctx.tenant_id}}",
              "type": "string"
            },
            {
              "id": "f8383453-d3a3-47d9-9739-8f20a160badc",
              "name": "_job_doc.payload.bot_id",
              "value": "={{$json._ctx.bot_id}}",
              "type": "string"
            },
            {
              "id": "1c89112c-5a80-4e67-bd57-210a1ba40d36",
              "name": "_job_doc.payload.trace_id",
              "value": "={{$json._ctx.trace_id}}",
              "type": "string"
            },
            {
              "id": "ec328013-6a1f-48d5-840a-5deb56e0b3a0",
              "name": "_job_doc.payload.correlation_id",
              "value": "={{$json._ctx.correlation_id}}",
              "type": "string"
            },
            {
              "id": "3b12c4e4-81d5-4c86-89df-a2587202b167",
              "name": "_job_doc.payload.visibility",
              "value": "={{$json._parsed.visibility}}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "0b54318a-3550-4082-959b-de12a749499d",
      "name": "Set — Prepare Job Build Document",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -21440,
        3216
      ],
      "notes": "Prepare build_document job payload.\nInput: _ctx, _parsed, _version_id.\nOutput: _job_doc object.\nWHY: Every processed message needs a build_document job for downstream document assembly."
    },
    {
      "parameters": {
        "schema": {
          "__rl": true,
          "mode": "list",
          "value": "ops"
        },
        "table": {
          "__rl": true,
          "mode": "list",
          "value": "jobs"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "tenant_id": "={{ $json._job_doc.tenant_id }}",
            "job_type": "={{ $json._job_doc.job_type }}",
            "payload": "={{ $json._job_doc.payload }}",
            "correlation_id": "={{ $json._job_doc.correlation_id }}",
            "priority": "={{ $json._job_doc.priority }}"
          },
          "schema": [
            {
              "id": "tenant_id",
              "displayName": "tenant_id",
              "required": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "job_type",
              "displayName": "job_type",
              "required": true,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "payload",
              "displayName": "payload",
              "required": true,
              "type": "object",
              "canBeUsedToMatch": false
            },
            {
              "id": "correlation_id",
              "displayName": "correlation_id",
              "required": false,
              "type": "string",
              "canBeUsedToMatch": false
            },
            {
              "id": "priority",
              "displayName": "priority",
              "required": false,
              "type": "number",
              "canBeUsedToMatch": false
            }
          ]
        },
        "options": {}
      },
      "id": "e4e21c69-b1ba-4990-a353-224ac18ed3f2",
      "name": "PG — Insert ops.jobs (Build Document)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        -21072,
        3040
      ],
      "credentials": {
        "postgres": {
          "id": "yckAFBLpmdhsPaDZ",
          "name": "Postgres DF Assistant"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Insert build_document job into ops.jobs.\nInput: _job_doc fields.\nOutput: Inserted row.\nWHY: Triggers downstream document building for the processed message."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert ops.jobs (Build Document)",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "ops.jobs",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "93733bf3-b407-4bbe-af56-f42de734b671",
      "name": "ERR — Source PG Insert Job BuildDoc",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -19808,
        5952
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error item from PG Build Document insert.\nOutput: Adds _err fields.\nWHY: ErrorPipe requires explicit source identification."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "test-req",
              "name": "req",
              "value": "={{ {\"ctx\": {\"tenant_id\": \"test-tenant\", \"correlation_id\": \"test-corr-004\", \"trace_id\": \"test-trace-004\"}, \"job\": {\"id\": 4, \"job_type\": \"normalize_update\", \"payload\": {\"bot_id\": \"test_bot\", \"update_id\": 12347, \"received_at\": \"2025-01-01T00:02:00Z\"}}} }}",
              "type": "object"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "id": "cd7f1d5a-aa49-4214-89a0-8f00ffeab199",
      "name": "Set — Test T4 Channel Post",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -33936,
        5184
      ],
      "notes": "T4 (edge): channel_post without from_user.\nExpected: Skips tg.users upsert but still inserts chat/message/version."
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -32704,
        4064
      ],
      "id": "9c402181-cfda-46ea-8ebd-1af82129e96e",
      "name": "Merge — Restore after PG — Load raw.telegram_updates",
      "notes": "Append base item and raw update results.\nInput 0: Base item from Parse job.payload.\nInput 1: Raw update row(s) from PG select (may be 0 items).\nOutput: All items appended; IF node will check for raw data.\nWHY: Append mode preserves base item even when PG returns 0 rows."
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "err-node",
              "name": "_err.node",
              "value": "PG — Insert ops.jobs (URL)",
              "type": "string"
            },
            {
              "id": "err-op",
              "name": "_err.operation",
              "value": "insert",
              "type": "string"
            },
            {
              "id": "err-table",
              "name": "_err.table",
              "value": "ops.jobs",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "fe7db193-7019-47bd-9084-68b3435c28df",
      "name": "ERR — Source PG Insert Job URL",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -22624,
        5536
      ],
      "notes": "Tag error source for ErrorPipe v1.\nInput: Error from job insert.\nOutput: Adds _err metadata.\nWHY: Identify error source for WF99."
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "has-files",
              "leftValue": "={{ ($json._attachments?.files_count ?? 0) > 0 }}",
              "rightValue": 0,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "2baa1eaf-5262-4e91-89a0-674cd2c35990",
      "name": "IF — Has Files",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        -25792,
        3008
      ],
      "notes": "Check if message has file attachments to persist.\nInput: { _attachments: { files_count } }\nOutput true: Has files, process attachments.\nOutput false: No files, skip to URL processing.\nWHY: Only run file persistence if files exist."
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -22000,
        2976
      ],
      "id": "119c73b3-dd70-4ce3-8edc-bf76b936344e",
      "name": "Merge — SYNC Files"
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -22192,
        3248
      ],
      "id": "1827a5ac-083b-4980-afed-5dfa7749b868",
      "name": "Merge — SYNC URLs"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "unmark-base",
              "name": "_file.file_id",
              "value": "={{ $json._file.file_id }}",
              "type": "string"
            },
            {
              "id": "5467f632-1bec-410e-ba8c-eb0fcb96c843",
              "name": "_file.file_unique_id",
              "value": "={{ $json._file.file_unique_id }}",
              "type": "string"
            },
            {
              "id": "c43615bf-b524-44b1-a516-c6d30ec84a45",
              "name": "_file.type",
              "value": "={{ $json._file.type }}",
              "type": "string"
            },
            {
              "id": "52b2808a-3b9f-44cc-b6a7-772bb152d980",
              "name": "_file.payload",
              "value": "={{ $json._file.payload }}",
              "type": "object"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "8140f59a-fa11-420c-85f7-23454ac3d0ca",
      "name": "Set — Normalize File Item",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -25088,
        2832
      ],
      "notes": "Mark file items as NOT base (they have _file field)"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "url-str",
              "name": "_url",
              "value": "={{ $json._url_obj.url }}",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {
          "dotNotation": true
        }
      },
      "id": "ba8e6a3d-0b65-4f4b-bb68-801444076a6b",
      "name": "Set — Normalize URL Item",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -25088,
        3312
      ],
      "notes": "Extract canonical URL string from split URL object.\nInput: _url_obj with url field.\nOutput: _url as plain string.\nWHY: Downstream nodes and content.urls need _url as a string."
    },
    {
      "parameters": {
        "mode": "chooseBranch"
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -21792,
        3136
      ],
      "id": "af814bdb-60ad-4b2b-a648-3720618e470e",
      "name": "Merge — SYNC Files + URLs"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -23040,
        2800
      ],
      "id": "182bcf0d-6153-4084-814c-81be71327d3a",
      "name": "Merge -  Restore after PG — Insert tg.message_attachments"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -20656,
        3200
      ],
      "id": "4d75658d-f37a-4168-9f2a-4a15153a0cff",
      "name": "Merge - Restore after PG — Insert ops.jobs (Build Document)"
    }
  ],
  "pinData": {},
  "connections": {
    "Item Lists — Split URLs": {
      "main": [
        [
          {
            "node": "Set — Normalize URL Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Item Lists — Split Files": {
      "main": [
        [
          {
            "node": "Set — Normalize File Item",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Attachment Counts & URLs": {
      "main": [
        [
          {
            "node": "Set — Prepare Version Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Build Files Array": {
      "main": [
        [
          {
            "node": "Set — Attachment Counts & URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract URLs from Entities": {
      "main": [
        [
          {
            "node": "Switch — Update Kind",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract Membership": {
      "main": [
        [
          {
            "node": "Set — Extract URLs from Entities",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract Attachments": {
      "main": [
        [
          {
            "node": "Set — Extract Membership",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract Dates & Reply": {
      "main": [
        [
          {
            "node": "Set — Extract Attachments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract User & Content": {
      "main": [
        [
          {
            "node": "Set — Extract Dates & Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Extract Chat Fields": {
      "main": [
        [
          {
            "node": "Set — Derive Visibility",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Determine update_kind": {
      "main": [
        [
          {
            "node": "Set — Extract Chat Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — req.update from DB": {
      "main": [
        [
          {
            "node": "Set — Determine update_kind",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Raw Update Found": {
      "main": [
        [
          {
            "node": "Set — req.update from DB",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — Error: Raw Update Not Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PG — Load raw.telegram_updates": {
      "main": [
        [
          {
            "node": "Merge — Restore after PG — Load raw.telegram_updates",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Load Raw",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Parse job.payload": {
      "main": [
        [
          {
            "node": "Merge — Restore after PG — Load raw.telegram_updates",
            "type": "main",
            "index": 1
          },
          {
            "node": "PG — Load raw.telegram_updates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Format Content Hash": {
      "main": [
        [
          {
            "node": "Set node Set — Convert Epoch → ISO",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crypto — SHA256 Content": {
      "main": [
        [
          {
            "node": "Set — Format Content Hash",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Upsert tg.chat_memberships_current": {
      "main": [
        [
          {
            "node": "Merge — Restore After Upsert tg.chat_memberships_current",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Insert tg.chat_member_events": {
      "main": [
        [
          {
            "node": "PG — Upsert tg.chat_memberships_current",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore After Upsert tg.chat_memberships_current",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Insert tg.chat_member_events": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.chat_member_events",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "PG — Upsert tg.files": {
      "main": [
        [
          {
            "node": "Set — Wrap Upsert tg.files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore After Upsert tg.file_instances": {
      "main": [
        [
          {
            "node": "PG — Insert tg.message_attachments",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge -  Restore after PG — Insert tg.message_attachments",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set — Wrap Upsert tg.file_instances": {
      "main": [
        [
          {
            "node": "Merge — Restore After Upsert tg.file_instances",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore After Upsert tg.files": {
      "main": [
        [
          {
            "node": "PG — Upsert tg.file_instances",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore After Upsert tg.file_instances",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set — Wrap Upsert tg.files": {
      "main": [
        [
          {
            "node": "Merge — Restore After Upsert tg.files",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Upsert content.urls": {
      "main": [
        [
          {
            "node": "Merge — Restore After Upsert URLs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Update messages.current_version_id": {
      "main": [
        [
          {
            "node": "IF — Has Files",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — SYNC URLs",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — SYNC Files",
            "type": "main",
            "index": 0
          },
          {
            "node": "IF — Has URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Update messages.current_version_id": {
      "main": [
        [
          {
            "node": "Merge — Restore After Update messages.current_version_id",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Insert tg.message_versions": {
      "main": [
        [
          {
            "node": "Set — Store Version ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Insert tg.message_versions": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.message_versions",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Select Max Version": {
      "main": [
        [
          {
            "node": "Set — Existing Message FK (next version)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Select Max Version": {
      "main": [
        [
          {
            "node": "Merge — Restore After Select Max Version",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Insert tg.messages": {
      "main": [
        [
          {
            "node": "Set — New Message FK (version 1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap Insert tg.messages": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.messages",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After PG — Select Existing Message": {
      "main": [
        [
          {
            "node": "IF — Message Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap PG — Select Existing Message": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Select Existing Message",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After PG — Upsert tg.chats": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Select Existing Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Select Existing Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap PG — Upsert tg.chats": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Upsert tg.chats",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After PG — Upsert tg.users": {
      "main": [
        [
          {
            "node": "Set — Prepare Chat Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Wrap PG — Upsert tg.users": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Upsert tg.users",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — Restore After Upsert URLs": {
      "main": [
        [
          {
            "node": "Set — Prepare Job URL Fetch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PG — Insert ops.jobs (URL)": {
      "main": [
        [
          {
            "node": "Merge — SYNC URLs",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Job URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Job URL Fetch": {
      "main": [
        [
          {
            "node": "PG — Insert ops.jobs (URL)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PG — Insert ops.jobs (File)": {
      "main": [
        [
          {
            "node": "Merge — SYNC Files",
            "type": "main",
            "index": 1
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Job File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Job File Fetch": {
      "main": [
        [
          {
            "node": "PG — Insert ops.jobs (File)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Test Fail Data": {
      "main": [
        [
          {
            "node": "Merge — Test Cases",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Set — Test Edge Data": {
      "main": [
        [
          {
            "node": "Merge — Test Cases",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set — Test Happy Data": {
      "main": [
        [
          {
            "node": "Merge — Test Cases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger (TEST)": {
      "main": [
        [
          {
            "node": "Set — Test Fail Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set — Test Edge Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set — Test Happy Data",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set — Test T4 Channel Post",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore After Upsert tg.chat_memberships_current": {
      "main": [
        [
          {
            "node": "Set — SuccessEnvelope (Membership)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Error: Raw Update Not Found": {
      "main": [
        [
          {
            "node": "Execute Workflow — WF99",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Job File": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 13
          }
        ]
      ]
    },
    "Merge — All Error Paths": {
      "main": [
        [
          {
            "node": "Set — Prepare ErrorPipe v1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare ErrorPipe v1": {
      "main": [
        [
          {
            "node": "Execute Workflow — WF99",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — SuccessEnvelope (Other)": {
      "main": [
        [
          {
            "node": "Merge — All Success Paths",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "Set — SuccessEnvelope (Membership)": {
      "main": [
        [
          {
            "node": "Merge — All Success Paths",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ERR — Source PG Upsert Membership": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 12
          }
        ]
      ]
    },
    "PG — Upsert tg.chat_memberships_current": {
      "main": [
        [
          {
            "node": "Set — Wrap Upsert tg.chat_memberships_current",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert Membership",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Member Event": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 11
          }
        ]
      ]
    },
    "PG — Insert tg.chat_member_events": {
      "main": [
        [
          {
            "node": "Set — Wrap Insert tg.chat_member_events",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Member Event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Membership Data": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.chat_member_events",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Insert tg.chat_member_events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — SuccessEnvelope (Message)": {
      "main": [
        [
          {
            "node": "Merge — All Success Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Upsert URL": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 10
          }
        ]
      ]
    },
    "PG — Upsert content.urls": {
      "main": [
        [
          {
            "node": "Set — Wrap Upsert content.urls",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Has URLs": {
      "main": [
        [
          {
            "node": "Item Lists — Split URLs",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge — SYNC URLs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ERR — Source PG Insert Attachment": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 9
          }
        ]
      ]
    },
    "PG — Insert tg.message_attachments": {
      "main": [
        [
          {
            "node": "Merge -  Restore after PG — Insert tg.message_attachments",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Attachment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Upsert File Instance": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 8
          }
        ]
      ]
    },
    "PG — Upsert tg.file_instances": {
      "main": [
        [
          {
            "node": "Set — Wrap Upsert tg.file_instances",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert File Instance",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Upsert File": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 7
          }
        ]
      ]
    },
    "ERR — Source PG Update Message": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 6
          }
        ]
      ]
    },
    "PG — Update messages.current_version_id": {
      "main": [
        [
          {
            "node": "Set — Wrap Update messages.current_version_id",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Update Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Store Version ID": {
      "main": [
        [
          {
            "node": "Merge — Restore After Update messages.current_version_id",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Update messages.current_version_id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Version": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 5
          }
        ]
      ]
    },
    "PG — Insert tg.message_versions": {
      "main": [
        [
          {
            "node": "Set — Wrap Insert tg.message_versions",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Version",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Version Insert": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.message_versions",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Insert tg.message_versions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Existing Message FK (next version)": {
      "main": [
        [
          {
            "node": "Crypto — SHA256 Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Select Version": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 4
          }
        ]
      ]
    },
    "PG — Select Max Version": {
      "main": [
        [
          {
            "node": "Set — Wrap Select Max Version",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Select Version",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — New Message FK (version 1)": {
      "main": [
        [
          {
            "node": "Crypto — SHA256 Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Message": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 3
          }
        ]
      ]
    },
    "PG — Insert tg.messages": {
      "main": [
        [
          {
            "node": "Set — Wrap Insert tg.messages",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare New Message Insert": {
      "main": [
        [
          {
            "node": "Merge — Restore After Insert tg.messages",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Insert tg.messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Message Exists": {
      "main": [
        [
          {
            "node": "Merge — Restore After Select Max Version",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Select Max Version",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — Prepare New Message Insert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Select Message": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 2
          }
        ]
      ]
    },
    "PG — Select Existing Message": {
      "main": [
        [
          {
            "node": "Set — Wrap PG — Select Existing Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Select Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Upsert tg.chats": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "PG — Upsert tg.chats": {
      "main": [
        [
          {
            "node": "Set — Wrap PG — Upsert tg.chats",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert tg.chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Chat Upsert": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Upsert tg.chats",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Upsert tg.chats",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Upsert tg.users": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PG — Upsert tg.users": {
      "main": [
        [
          {
            "node": "Set — Wrap PG — Upsert tg.users",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Upsert tg.users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare User Upsert": {
      "main": [
        [
          {
            "node": "Merge — Restore After PG — Upsert tg.users",
            "type": "main",
            "index": 0
          },
          {
            "node": "PG — Upsert tg.users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch — Update Kind": {
      "main": [
        [
          {
            "node": "IF — Has from_user",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF — Has from_user",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF — Has from_user",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "IF — Has from_user",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — Prepare Membership Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — Prepare Membership Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — SuccessEnvelope (Other)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Build _ctx": {
      "main": [
        [
          {
            "node": "Set — Parse job.payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Assign Generated Correlation ID": {
      "main": [
        [
          {
            "node": "Set — Build _ctx",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Crypto — Generate UUID": {
      "main": [
        [
          {
            "node": "Set — Assign Generated Correlation ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Correlation ID Exists": {
      "main": [
        [
          {
            "node": "Set — Build _ctx",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Crypto — Generate UUID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Workflow Trigger": {
      "main": [
        [
          {
            "node": "IF — Correlation ID Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Derive Visibility": {
      "main": [
        [
          {
            "node": "Set — Extract User & Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set node Set — Convert Epoch → ISO": {
      "main": [
        [
          {
            "node": "Set — Build Files Array",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Load Raw": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF — Has from_user": {
      "main": [
        [
          {
            "node": "Set — Prepare User Upsert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set — Prepare Chat Upsert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Prepare Job Build Document": {
      "main": [
        [
          {
            "node": "PG — Insert ops.jobs (Build Document)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge - Restore after PG — Insert ops.jobs (Build Document)",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "PG — Insert ops.jobs (Build Document)": {
      "main": [
        [
          {
            "node": "Merge - Restore after PG — Insert ops.jobs (Build Document)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ERR — Source PG Insert Job BuildDoc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Job BuildDoc": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set — Test T4 Channel Post": {
      "main": [
        [
          {
            "node": "Merge — Test Cases",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — Restore after PG — Load raw.telegram_updates": {
      "main": [
        [
          {
            "node": "IF — Raw Update Found",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ERR — Source PG Insert Job URL": {
      "main": [
        [
          {
            "node": "Merge — All Error Paths",
            "type": "main",
            "index": 14
          }
        ]
      ]
    },
    "IF — Has Files": {
      "main": [
        [
          {
            "node": "Item Lists — Split Files",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge — SYNC Files",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set — Normalize File Item": {
      "main": [
        [
          {
            "node": "PG — Upsert tg.files",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore After Upsert tg.files",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Set — Normalize URL Item": {
      "main": [
        [
          {
            "node": "PG — Upsert content.urls",
            "type": "main",
            "index": 0
          },
          {
            "node": "Merge — Restore After Upsert URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — SYNC URLs": {
      "main": [
        [
          {
            "node": "Merge — SYNC Files + URLs",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge — SYNC Files": {
      "main": [
        [
          {
            "node": "Merge — SYNC Files + URLs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge — SYNC Files + URLs": {
      "main": [
        [
          {
            "node": "Set — Prepare Job Build Document",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge -  Restore after PG — Insert tg.message_attachments": {
      "main": [
        [
          {
            "node": "Set — Prepare Job File Fetch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge - Restore after PG — Insert ops.jobs (Build Document)": {
      "main": [
        [
          {
            "node": "Set — SuccessEnvelope (Message)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "VykeJY27VNJD_xWfy5Nx6"
  },
  "versionId": "f4507e04-bb9a-4073-a404-f577ff51a82b",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "49b1b765c7a60d5365a95e5c3e2d1b2e695b21e61861bbe488c27ec04546a71d"
  },
  "id": "-0hFbxSj-HB7MD1sbkWF0",
  "tags": []
}