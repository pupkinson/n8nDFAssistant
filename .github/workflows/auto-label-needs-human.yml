name: Auto-label needs-human on critical file changes

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Add needs-human when SQL.txt or Credentials.json changes
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr,
              per_page: 100,
            });

            const changed = files.map((f) => f.filename);
            const touchedCritical = changed.includes('SQL.txt') || changed.includes('Credentials.json');

            if (!touchedCritical) {
              core.info('No SQL.txt/Credentials.json change.');
              return;
            }

            const existing = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: pr,
            });

            if (existing.data.some((l) => l.name === 'needs-human')) {
              core.info('needs-human already present.');
              return;
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr,
              labels: ['needs-human'],
            });

            core.info('Added needs-human label.');
