name: Auto-label needs-human on critical file changes

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Label PR if SQL.txt or Credentials.json changed
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request.number;

            // List files changed in PR
            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner, repo, pull_number: pr, per_page: 100
            });

            const changed = files.map(f => f.filename);
            const critical = new Set(["SQL.txt", "Credentials.json"]);
            const touched = changed.some(f => critical.has(f));

            if (!touched) {
              core.info("No critical files changed. Skipping labeling.");
              return;
            }

            const label = "needs-human";

            // Get existing labels on PR
            const existing = await github.rest.issues.listLabelsOnIssue({
              owner, repo, issue_number: pr
            });

            const has = existing.data.some(l => l.name === label);
            if (has) {
              core.info(`PR already has label "${label}".`);
              return;
            }

            await github.rest.issues.addLabels({
              owner, repo, issue_number: pr, labels: [label]
            });

            core.info(`Added label "${label}" because critical file changed.`);
