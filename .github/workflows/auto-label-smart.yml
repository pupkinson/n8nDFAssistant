name: Auto-label smart

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review, edited]

permissions:
  contents: read
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Add smart labels (no removals)
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pr = context.payload.pull_request.number;

            const files = await github.paginate(github.rest.pulls.listFiles, {
              owner,
              repo,
              pull_number: pr,
              per_page: 100,
            });

            const changed = files.map((f) => f.filename);
            const title = (context.payload.pull_request.title || '').toLowerCase();
            const body = (context.payload.pull_request.body || '').toLowerCase();
            const text = `${title}\n${body}`;

            const labels = new Set();

            const isAclPath = (p) => {
              if (!p.startsWith('workflows/')) return false;
              const file = p.split('/').pop() || '';
              return /^WF00c\b/i.test(file) || /^WF50\b/i.test(file) || /^WF51\b/i.test(file);
            };

            if (changed.includes('SQL.txt')) labels.add('db-change');
            if (changed.includes('Credentials.json')) labels.add('critical-credentials');
            if (changed.some(isAclPath)) labels.add('acl-change');

            const criticalTouched = labels.has('db-change') || labels.has('critical-credentials') || labels.has('acl-change');
            if (criticalTouched) {
              labels.add('tracked');
            }

            const bugHints = ['bug', 'fix', 'hotfix', 'error', 'regression', 'ошиб', 'фикс', 'баг'];
            const isBug = bugHints.some((k) => text.includes(k));
            labels.add(isBug ? 'type:bug' : 'type:feature');

            const existing = await github.rest.issues.listLabelsOnIssue({
              owner,
              repo,
              issue_number: pr,
            });
            const existingSet = new Set(existing.data.map((l) => l.name));

            const toAdd = [...labels].filter((l) => !existingSet.has(l));
            if (!toAdd.length) {
              core.info('No new labels to add.');
              return;
            }

            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: pr,
              labels: toAdd,
            });

            core.info(`Added labels: ${toAdd.join(', ')}`);
